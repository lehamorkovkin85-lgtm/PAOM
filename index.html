<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>paom.study - –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –û–±—É—á–µ–Ω–∏—è</title>
    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Tailwind –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤ –∏ —à—Ä–∏—Ñ—Ç–æ–≤ -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'paom-green': {
                            '50': '#f0fdf4',
                            '100': '#dcfce7',
                            '200': '#bbf7d0',
                            '300': '#86efac',
                            '400': '#4ade80',
                            '500': '#22c55e', // –û—Å–Ω–æ–≤–Ω–æ–π –∑–µ–ª–µ–Ω—ã–π
                            '600': '#16a34a', // –ë–æ–ª–µ–µ —Ç–µ–º–Ω—ã–π –∑–µ–ª–µ–Ω—ã–π
                            '700': '#15803d',
                            '800': '#166534',
                            '900': '#14532d',
                            '950': '#0f3d24',
                        },
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            }
        }
    </script>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏–∫–æ–Ω–æ–∫ Lucide (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –ò—Å–ø–æ–ª—å–∑—É–µ–º UMD –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script>
        // –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –≤—ã–∑–æ–≤–∞ createIcons, –∏—Å–ø–æ–ª—å–∑—É—è –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç lucide
        window.createIcons = lucide.createIcons;
        window.icons = lucide.icons; // –î–µ–ª–∞–µ–º –æ–±—ä–µ–∫—Ç icons –¥–æ—Å—Ç—É–ø–Ω—ã–º –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π
    </script>
    <style>
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏ */
        body { font-family: 'Inter', sans-serif; }
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .paom-nav-icon { height: 24px; width: 24px; }

        /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
        @media (min-width: 1024px) {
            #nav-menu {
                width: 5rem; /* lg:w-20 */
                height: 100vh;
                position: fixed;
                top: 0;
                left: 0;
                flex-direction: column;
                padding-top: 2rem;
            }
            #main-content {
                margin-left: 5rem;
                padding-bottom: 0;
            }
        }
    </style>
</head>
<body class="bg-paom-green-50 min-h-screen">

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <div id="app-container" class="min-h-screen flex flex-col lg:flex-row">

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–æ–µ –º–µ–Ω—é (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ —Å–Ω–∏–∑—É –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö, —Å–ª–µ–≤–∞ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ) -->
        <div id="nav-menu" class="fixed bottom-0 left-0 right-0 bg-paom-green-800 shadow-xl z-30 flex justify-around p-2 lg:relative lg:flex-col lg:space-y-4 lg:justify-start">
            <!-- –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã JavaScript -->
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞ -->
        <main id="main-content" class="flex-grow pb-20 lg:pb-0">
            <div id="app-content" class="max-w-7xl mx-auto p-4 sm:p-8">
                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è JavaScript -->
            </div>
        </main>
    </div>

    <!-- –û–±–ª–∞—Å—Ç—å –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω -->
    <div id="modal-container"></div>

    <script>
        // --- –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ù–ê–ß–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï ---

        const APP_NAME = "paom.study";
        const STORAGE_KEY = `${APP_NAME}_DATA_V2`;

        const LEAGUE_NAMES = ["–ë—Ä–æ–Ω–∑–∞", "–°–µ—Ä–µ–±—Ä–æ", "–ó–æ–ª–æ—Ç–æ", "–ü–ª–∞—Ç–∏–Ω–∞", "–ò–∑—É–º—Ä—É–¥", "–†—É–±–∏–Ω", "–ê–ª–º–∞–∑", "–õ–µ–≥–µ–Ω–¥–∞"];
        const LEAGUE_SIZES = 25;
        const PROMOTION_ZONE = 4;
        const DEMOTION_ZONE = 5;

        const XP_PER_TASK = 10;
        const DIAMONDS_PER_LESSON = [10, 15];

        const AVATAR_URLS = [
            'https://placehold.co/100x100/16a34a/ffffff?text=P', // paom-green-600
            'https://placehold.co/100x100/3b82f6/ffffff?text=A', // blue-500
            'https://placehold.co/100x100/f59e0b/333333?text=O', // amber-500
            'https://placehold.co/100x100/8b5cf6/ffffff?text=M', // violet-500
        ];

        const COURSES_DATA = [
            { id: 'en', title: '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', icon: 'üá¨üáß', color: 'paom-green-600', lessons: generateLessons('en', '–ë–∞–∑–æ–≤—ã–µ –≥–ª–∞–≥–æ–ª—ã', 25) },
            { id: 'math', title: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', icon: '‚ûï', color: 'yellow-600', lessons: generateLessons('math', '–û—Å–Ω–æ–≤—ã –∞–ª–≥–µ–±—Ä—ã', 25) },
            { id: 'geo', title: '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è', icon: 'üåç', color: 'blue-600', lessons: generateLessons('geo', '–ú–∞—Ç–µ—Ä–∏–∫–∏ –∏ –æ–∫–µ–∞–Ω—ã', 25) },
            { id: 'music', title: '–ú—É–∑—ã–∫–∞', icon: 'üé∂', color: 'red-600', lessons: generateLessons('music', '–ù–æ—Ç—ã –∏ —Ä–∏—Ç–º—ã', 25) },
            { id: 'chess', title: '–®–∞—Ö–º–∞—Ç—ã', icon: '‚ôüÔ∏è', color: 'gray-700', lessons: generateLessons('chess', '–î–µ–±—é—Ç—ã', 25) },
            { id: 'art', title: '–ò–ó–û', icon: 'üé®', color: 'purple-600', lessons: generateLessons('art', '–¶–≤–µ—Ç–æ–≤–µ–¥–µ–Ω–∏–µ', 25) },
        ];

        // --- –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï ---

        let appState = {};
        let currentView = '';
        let currentLesson = null; // { courseId, lessonId, currentTaskIndex }
        let currentProfile = null; // –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ—Ñ–∏–ª—è –±–æ—Ç–∞/–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        let botUpdateInterval = null;

        // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –ì–ï–ù–ï–†–ê–¶–ò–ò –î–ê–ù–ù–´–• ---

        function generateLessons(courseId, baseTitle, count) {
            const characters = {
                en: ['–ü—Ä–æ—Ñ–µ—Å—Å–æ—Ä –ì—Ä–∏–Ω', '–°–æ–≤–∞ –û–ª–∏–≤–∏—è'],
                math: ['–ê–∫–∞–¥–µ–º–∏–∫ –≠–π–Ω', '–ì–µ–Ω–∏–π –ü–∏'],
                geo: ['–ü—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫ –î–∂–µ–∫', '–ö–∞—Ä—Ç–æ–≥—Ä–∞—Ñ –ö–∞—Ç—è'],
                music: ['–ö–æ–º–ø–æ–∑–∏—Ç–æ—Ä –ö—Ä–∏—Å', '–ú–∞—ç—Å—Ç—Ä–æ –ú–∏—à–∞'],
                chess: ['–ú–∞—Å—Ç–µ—Ä –ö–∞—Å–ø–∞—Ä–æ–≤', '–ß–µ–º–ø–∏–æ–Ω–∫–∞ –ß–∏–∞'],
                art: ['–•—É–¥–æ–∂–Ω–∏—Ü–∞ –õ–∏–Ω–∞', '–°–∫—É–ª—å–ø—Ç–æ—Ä –°–ª–∞–≤–∞'],
            };
            return Array.from({ length: count }, (_, i) => ({
                id: `${courseId}_l${i+1}`,
                title: `–£—Ä–æ–∫ ${i+1}: ${baseTitle}`,
                tasks: Array.from({ length: 15 }, (_, j) => {
                    const type = j % 3 === 0 ? 'translation' : j % 3 === 1 ? 'choice' : 'fill';
                    const char = characters[courseId][j % characters[courseId].length];
                    
                    let question, answer, options = null;

                    if (courseId === 'en') {
                        question = type === 'translation' ? `–ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ: "–Ø –ª—é–±–ª—é —É—á–∏—Ç—å—Å—è."` : type === 'choice' ? `–í—ã–±–µ—Ä–∏—Ç–µ: She ___ a student.` : `–ó–∞–ø–æ–ª–Ω–∏—Ç–µ: We ___ books. (read/reads)`;
                        answer = type === 'translation' ? 'I love to study.' : type === 'choice' ? 'is' : 'read';
                        options = type === 'choice' ? ['is', 'are', 'am'] : null;
                    } else if (courseId === 'math') {
                        const num = (i + 1) * (j + 1);
                        question = `–ö–∞–∫–æ–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç: $${num} \\times 5$ ?`;
                        answer = `${num * 5}`;
                        options = null;
                    } else {
                        question = `–í–æ–ø—Ä–æ—Å –ø–æ —Ç–µ–º–µ ${baseTitle}, –∑–∞–¥–∞–Ω–∏–µ ${j+1}.`;
                        answer = `–û—Ç–≤–µ—Ç ${j+1}`;
                        options = type === 'choice' ? ['–í–∞—Ä–∏–∞–Ω—Ç A', '–í–∞—Ä–∏–∞–Ω—Ç B', '–û—Ç–≤–µ—Ç'] : null;
                    }

                    return {
                        id: `t${j+1}`,
                        type: type,
                        character: char,
                        question: question,
                        answer: answer,
                        options: options,
                    };
                })
            }));
        }

        function generateRandomBots(count, currentLeague) {
            return Array.from({ length: count }, (_, i) => ({
                id: `bot_${crypto.randomUUID()}`,
                nickname: `–ë–æ—Ç_${i + 1}_${currentLeague}`,
                avatar: AVATAR_URLS[Math.floor(Math.random() * AVATAR_URLS.length)],
                xp: Math.floor(Math.random() * 5000) + 100,
                diamonds: Math.floor(Math.random() * 500) + 50,
                league: currentLeague,
                score: Math.floor(Math.random() * 1000) + 100,
                status: ['–ü—Ä–æ—Ö–æ–¥–∏—Ç –ê–Ω–≥–ª–∏–π—Å–∫–∏–π', '–£—á–∏—Ç –ú–∞—Ç–µ–º–∞—Ç–∏–∫—É', '–ü–µ—Ä–µ—à–µ–ª –≤ –Ω–æ–≤—É—é –ª–∏–≥—É'][Math.floor(Math.random() * 3)],
            }));
        }

        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–û–°–¢–û–Ø–ù–ò–ï–ú (LocalStorage) ---

        function loadState() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    const data = JSON.parse(savedData);
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
                    if (!data.leaderboard || !data.user) throw new Error("Invalid saved data");

                    // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –±–æ—Ç–æ–≤, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç –∏–ª–∏ –ª–∏–≥–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
                    const currentLeague = data.user.currentLeague || LEAGUE_NAMES[0];
                    if (!data.leaderboard.bots || data.leaderboard.bots.length !== LEAGUE_SIZES - 1 || data.leaderboard.league !== currentLeague) {
                        data.leaderboard.league = currentLeague;
                        data.leaderboard.bots = generateRandomBots(LEAGUE_SIZES - 1, currentLeague);
                    }
                    
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö —Å—É–Ω–¥—É–∫–æ–≤
                    const today = new Date().toLocaleDateString();
                    if (data.user.dailyChests.lastCheckDate !== today) {
                        data.user.dailyChests = {
                            lastCheckDate: today,
                            earlyBird: false,
                            nightOwl: false,
                            regular: false,
                        };
                    }

                    return data;
                }
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è:", e);
                localStorage.removeItem(STORAGE_KEY); // –°–±—Ä–æ—Å –Ω–µ–≤–µ—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            }

            // –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            const initialLeague = LEAGUE_NAMES[0];
            return {
                user: {
                    isRegistered: false,
                    nickname: '',
                    avatar: AVATAR_URLS[0],
                    xp: 0,
                    diamonds: 50,
                    currentLeague: initialLeague,
                    completedLessons: {}, // { courseId: lessonIndex }
                    xpBoost: { active: false, multiplier: 1, lessonsLeft: 0, bought: false },
                    dailyChests: {
                        lastCheckDate: new Date().toLocaleDateString(),
                        earlyBird: false,
                        nightOwl: false,
                        regular: false,
                    },
                    friends: [],
                },
                leaderboard: {
                    league: initialLeague,
                    score: 0, // –ù–µ–¥–µ–ª—å–Ω—ã–π —Å—á–µ—Ç
                    bots: generateRandomBots(LEAGUE_SIZES - 1, initialLeague),
                },
                newsFeed: {
                    updates: [
                        { id: 1, text: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.', date: new Date().toLocaleDateString() },
                        { id: 2, text: '–í—ã—à–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: —Ç–µ–ø–µ—Ä—å —É—Ä–æ–∫–∏ –≤–æ –≤–µ—Å—å —ç–∫—Ä–∞–Ω!', date: new Date().toLocaleDateString() },
                    ]
                }
            };
        }

        function saveState() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
        }

        // --- –£–¢–ò–õ–ò–¢–´ UI ---

        function showMessage(text) {
            // –ò–º–∏—Ç–∞—Ü–∏—è alert, –Ω–æ –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è window.alert
            const container = document.getElementById('modal-container');
            const messageBox = document.createElement('div');
            messageBox.className = 'fixed top-4 right-4 bg-paom-green-500 text-white p-4 rounded-lg shadow-xl z-50 transition-all duration-300 transform translate-y-0 opacity-100';
            messageBox.textContent = text;
            container.appendChild(messageBox);

            setTimeout(() => {
                messageBox.classList.add('opacity-0', 'translate-y-full');
                messageBox.addEventListener('transitionend', () => messageBox.remove());
            }, 3000);
        }

        function clearContent() {
            const content = document.getElementById('app-content');
            content.innerHTML = '';
        }

        function getIcon(iconName, classes = 'paom-nav-icon') {
            return `<i data-lucide="${iconName}" class="${classes}"></i>`;
        }

        // --- –õ–û–ì–ò–ö–ê –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò/–†–ï–ì–ò–°–¢–†–ê–¶–ò–ò ---

        function renderAuthScreen() {
            clearContent();
            const content = document.getElementById('app-content');
            content.className = "min-h-screen flex items-center justify-center p-4";

            content.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center border-t-8 border-paom-green-600">
                    ${getIcon('Aperture', 'w-12 h-12 text-paom-green-600 mx-auto mb-4')}
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ ${APP_NAME}!</h1>
                    <p class="text-gray-500 mb-8">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è –≤–∞—à–µ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è.</p>

                    <input
                        type="text"
                        id="nickname-input"
                        placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –Ω–∏–∫–Ω–µ–π–º"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-paom-green-500 mb-6"
                        maxlength="20"
                    />
                    <button
                        id="register-btn"
                        class="w-full bg-paom-green-600 text-white py-3 rounded-lg font-semibold hover:bg-paom-green-700 transition duration-150 disabled:opacity-50 shadow-md"
                        disabled
                    >
                        –ù–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ
                    </button>
                </div>
            `;
            // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ø–µ—Ä–µ–¥–∞–µ–º window.icons
            window.createIcons({ icons: window.icons });

            const input = document.getElementById('nickname-input');
            const button = document.getElementById('register-btn');

            input.addEventListener('input', () => {
                button.disabled = input.value.trim().length < 3;
            });

            button.addEventListener('click', () => {
                const nickname = input.value.trim();
                if (nickname.length >= 3) {
                    appState.user.isRegistered = true;
                    appState.user.nickname = nickname;
                    saveState();
                    renderView('home');
                }
            });
        }

        // --- –õ–û–ì–ò–ö–ê –°–£–ù–î–£–ö–û–í ---

        function getAvailableChest() {
            const now = new Date();
            const hour = now.getHours();
            const chests = appState.user.dailyChests;

            if (hour >= 6 && hour < 12 && !chests.earlyBird) {
                return { type: 'earlyBird', name: '–†–∞–Ω–Ω—è—è –ø—Ç–∞—à–∫–∞', xp: [2, 3], icon: 'Sunrise' };
            }
            if (hour >= 18 && hour < 24 && !chests.nightOwl) {
                return { type: 'nightOwl', name: '–ü–æ–ª—É–Ω–æ—á–Ω–∏–∫', xp: [2, 3], icon: 'Moon' };
            }
            if (!chests.regular) {
                return { type: 'regular', name: '–û–±—ã—á–Ω—ã–π', xp: [1.5, 2], icon: 'Gift' };
            }
            return null;
        }

        function handleOpenChest(chestType, multiplier) {
            const lessons = 3;
            
            // –ù–∞–π—Ç–∏ —Å–ª—É—á–∞–π–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å –∏–∑ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
            const [min, max] = multiplier;
            const finalMultiplier = min === max ? min : (Math.random() < 0.5 ? min : max);

            appState.user.dailyChests[chestType] = true;
            appState.user.xpBoost = { active: true, multiplier: finalMultiplier, lessonsLeft: lessons, bought: false };
            saveState();
            renderView('home');
            showMessage(`–í—ã –ø–æ–ª—É—á–∏–ª–∏ –º–Ω–æ–∂–∏—Ç–µ–ª—å x${finalMultiplier} –æ–ø—ã—Ç–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–µ ${lessons} —É—Ä–æ–∫–∞!`);
        }

        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ù–ê–í–ò–ì–ê–¶–ò–ï–ô ---

        function renderNavMenu() {
            const menu = document.getElementById('nav-menu');
            menu.innerHTML = `
                ${renderNavItem('home', '–ö—É—Ä—Å—ã', 'BookOpen', currentView === 'home')}
                ${renderNavItem('leaderboard', '–õ–∏–¥–µ—Ä—ã', 'BarChart', currentView === 'leaderboard')}
                ${renderNavItem('newsfeed', '–õ–µ–Ω—Ç–∞', 'Users', currentView === 'newsfeed')}
                ${renderNavItem('profile', '–ü—Ä–æ—Ñ–∏–ª—å', 'User', currentView === 'profile')}
            `;
            // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ø–µ—Ä–µ–¥–∞–µ–º window.icons
            window.createIcons({ icons: window.icons });

            menu.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', () => {
                    const targetView = button.getAttribute('data-view');
                    if (targetView) {
                        currentProfile = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ—Ñ–∏–ª—è –±–æ—Ç–∞ –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
                        renderView(targetView);
                    }
                });
            });
        }

        function renderNavItem(view, label, iconName, isActive) {
            return `
                <button
                    data-view="${view}"
                    class="flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-200 w-full ${
                        isActive
                            ? 'text-white bg-paom-green-700 shadow-lg'
                            : 'text-paom-green-200 hover:bg-paom-green-600'
                    } lg:py-4"
                >
                    ${getIcon(iconName)}
                    <span class="text-xs mt-1 font-medium">${label}</span>
                </button>
            `;
        }

        function renderView(viewName) {
            if (viewName === 'lesson') {
                renderLessonView();
                return;
            }

            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å—Ç–∏–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –≤—Å–µ—Ö –∫—Ä–æ–º–µ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —É—Ä–æ–∫–∞
            const content = document.getElementById('app-content');
            content.className = "max-w-7xl mx-auto p-4 sm:p-8";

            currentView = viewName;
            renderNavMenu();

            // –û—á–∏—â–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –±–æ—Ç–∞, –µ—Å–ª–∏ –Ω–µ –Ω–∞ —Ç–∞–±–ª–∏—Ü–µ –ª–∏–¥–µ—Ä–æ–≤
            if (botUpdateInterval) {
                clearInterval(botUpdateInterval);
                botUpdateInterval = null;
            }

            switch (viewName) {
                case 'home':
                    renderHomeScreen();
                    break;
                case 'leaderboard':
                    renderLeaderboardView();
                    startBotUpdates();
                    break;
                case 'profile':
                    renderProfileView();
                    break;
                case 'newsfeed':
                    renderNewsFeedView();
                    break;
                default:
                    renderHomeScreen();
            }
            window.scrollTo(0, 0); // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–≤–µ—Ä—Ö –ø—Ä–∏ —Å–º–µ–Ω–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            saveState();
        }

        // --- –†–ï–ù–î–ï–†–ò–ù–ì –°–¢–†–ê–ù–ò–¶ ---

        // 1. –î–æ–º–∞—à–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
        function renderHomeScreen() {
            clearContent();
            const content = document.getElementById('app-content');
            const availableChest = getAvailableChest();

            const xpBoostInfo = appState.user.xpBoost.active ? `
                <div class="ml-auto p-2 bg-yellow-500 text-white rounded-lg text-sm font-semibold shadow-md animate-pulse">
                    XP x${appState.user.xpBoost.multiplier} (–û—Å—Ç–∞–ª–æ—Å—å: ${appState.user.xpBoost.lessonsLeft} —É—Ä.)
                </div>
            ` : '';

            const chestContent = availableChest ? `
                <div class="flex items-center justify-between p-4 bg-paom-green-100 rounded-lg border border-paom-green-300">
                    <p class="font-medium text-gray-700">
                        –î–æ—Å—Ç—É–ø–µ–Ω —Å—É–Ω–¥—É–∫ "${availableChest.name}"!
                    </p>
                    <button
                        id="open-chest-btn"
                        data-chest-type="${availableChest.type}"
                        data-multiplier-min="${availableChest.xp[0]}"
                        data-multiplier-max="${availableChest.xp[1]}"
                        class="bg-paom-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-paom-green-700 transition duration-150 shadow-md"
                    >
                        –û—Ç–∫—Ä—ã—Ç—å
                    </button>
                </div>
            ` : `
                <p class="text-gray-500">
                    –ù–∞ —Å–µ–≥–æ–¥–Ω—è –≤—ã —É–∂–µ –æ—Ç–∫—Ä—ã–ª–∏ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å—É–Ω–¥—É–∫–∏. –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å –∑–∞–≤—Ç—Ä–∞!
                </p>
            `;

            let coursesHtml = '';
            COURSES_DATA.forEach(course => {
                const userProgress = appState.user.completedLessons[course.id] || 0;
                const totalLessons = course.lessons.length;
                const percentage = (userProgress / totalLessons) * 100;

                coursesHtml += `
                    <div class="p-4 rounded-xl shadow-lg border border-${course.color}">
                        <p class="text-3xl mb-2">${course.icon}</p>
                        <h4 class="font-bold text-lg text-gray-800">${course.title}</h4>
                        <p class="text-xs text-gray-500 mt-1">
                            ${userProgress} / ${totalLessons} —É—Ä–æ–∫–æ–≤
                        </p>
                        <div class="w-full bg-gray-200 rounded-full h-1.5 mt-2">
                            <div class="h-1.5 rounded-full" style="width: ${percentage}%; background-color: ${course.color.split('-')[0] === 'paom' ? 'var(--tw-colors-paom-green-600)' : `var(--tw-colors-${course.color.split('-')[0]}-600)`};"></div>
                        </div>
                        <button
                            data-course-id="${course.id}"
                            data-lesson-index="${userProgress}"
                            class="start-lesson-btn mt-4 w-full py-2 rounded-lg text-sm font-semibold transition duration-150 ${
                                userProgress >= totalLessons
                                    ? 'bg-gray-400 text-gray-700 cursor-not-allowed'
                                    : 'bg-paom-green-600 text-white hover:bg-paom-green-700 shadow-md'
                            }"
                            ${userProgress >= totalLessons ? 'disabled' : ''}
                        >
                            ${userProgress >= totalLessons ? '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' : '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å'}
                        </button>
                    </div>
                `;
            });

            content.innerHTML = `
                <div class="space-y-8">
                    <h2 class="text-3xl font-bold text-gray-800">
                        –ü—Ä–∏–≤–µ—Ç, ${appState.user.nickname}! üëã
                    </h2>

                    <!-- –°–µ–∫—Ü–∏—è –ë—É—Å—Ç–æ–≤ –∏ –ü—Ä–æ–≥—Ä–µ—Å—Å–∞ -->
                    <div class="flex items-center space-x-4 bg-paom-green-50 p-4 rounded-xl shadow-inner border border-paom-green-200">
                        ${getIcon('Zap', 'text-paom-green-600 w-8 h-8')}
                        <div>
                            <p class="text-xs font-semibold text-gray-600 uppercase">–û–ø—ã—Ç / –ê–ª–º–∞–∑—ã</p>
                            <p class="text-2xl font-bold text-gray-900">
                                ${appState.user.xp} XP | ${appState.user.diamonds} üíé
                            </p>
                        </div>
                        ${xpBoostInfo}
                    </div>

                    <!-- –°–µ–∫—Ü–∏—è –°—É–Ω–¥—É–∫–æ–≤ -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                            ${getIcon('Gift', 'w-6 h-6 mr-2 text-paom-green-600')} –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —Å—É–Ω–¥—É–∫–∏
                        </h3>
                        ${chestContent}
                    </div>

                    <!-- –°–µ–∫—Ü–∏—è –ö—É—Ä—Å–æ–≤ -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                            ${getIcon('BookOpen', 'w-6 h-6 mr-2 –≤text-paom-green-600')} –í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å
                        </h3>
                        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4">
                            ${coursesHtml}
                        </div>
                    </div>
                </div>
            `;
            // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ø–µ—Ä–µ–¥–∞–µ–º window.icons
            window.createIcons({ icons: window.icons });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å—É–Ω–¥—É–∫–∞
            const openChestBtn = document.getElementById('open-chest-btn');
            if (openChestBtn) {
                openChestBtn.addEventListener('click', () => {
                    const type = openChestBtn.getAttribute('data-chest-type');
                    const min = parseFloat(openChestBtn.getAttribute('data-multiplier-min'));
                    const max = parseFloat(openChestBtn.getAttribute('data-multiplier-max'));
                    handleOpenChest(type, [min, max]);
                });
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —É—Ä–æ–∫–æ–≤
            document.querySelectorAll('.start-lesson-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const courseId = button.getAttribute('data-course-id');
                    const lessonIndex = parseInt(button.getAttribute('data-lesson-index'));
                    const lessonId = COURSES_DATA.find(c => c.id === courseId).lessons[lessonIndex].id;
                    
                    currentLesson = { courseId, lessonId, currentTaskIndex: 0 };
                    renderView('lesson');
                });
            });
        }

        // 2. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –£—Ä–æ–∫–∞ (Full Screen)

        function getLessonData(courseId, lessonId) {
            const course = COURSES_DATA.find(c => c.id === courseId);
            return course ? course.lessons.find(l => l.id === lessonId) : null;
        }

        function handleLessonComplete(xpEarned, diamondsEarned) {
            const { courseId, lessonId } = currentLesson;
            const course = COURSES_DATA.find(c => c.id === courseId);
            const lessonIndex = course.lessons.findIndex(l => l.id === lessonId);
            const nextLessonIndex = lessonIndex + 1;

            let { xpBoost, completedLessons } = appState.user;
            let actualXp = xpEarned;

            if (xpBoost.active) {
                actualXp = Math.round(xpEarned * xpBoost.multiplier);
                xpBoost.lessonsLeft -= 1;
                if (xpBoost.lessonsLeft <= 0) {
                    xpBoost = { active: false, multiplier: 1, lessonsLeft: 0, bought: false };
                }
            }

            const newCompletedLessons = { ...completedLessons };
            if (!newCompletedLessons[courseId] || newCompletedLessons[courseId] < nextLessonIndex) {
                newCompletedLessons[courseId] = nextLessonIndex;
            }
            
            appState.user.xp += actualXp;
            appState.user.diamonds += diamondsEarned;
            appState.user.xpBoost = xpBoost;
            appState.user.completedLessons = newCompletedLessons;
            appState.leaderboard.score += actualXp;

            saveState();
            currentLesson = null;
            renderView('home');
            showMessage(`–£—Ä–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω! –ü–æ–ª—É—á–µ–Ω–æ ${actualXp} XP (x${appState.user.xpBoost.multiplier} –±—É—Å—Ç) –∏ ${diamondsEarned} üíé.`);
        }

        function renderLessonView() {
            document.getElementById('nav-menu').style.display = 'none'; // –°–∫—Ä—ã—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏—é
            const mainContent = document.getElementById('main-content');
            mainContent.className = "flex-grow pb-0"; // –£–±—Ä–∞—Ç—å –æ—Ç—Å—Ç—É–ø—ã
            
            const content = document.getElementById('app-content');
            content.className = "fixed inset-0 flex flex-col p-0";
            clearContent();

            const lesson = getLessonData(currentLesson.courseId, currentLesson.lessonId);
            const course = COURSES_DATA.find(c => c.id === currentLesson.courseId);
            const currentTask = lesson.tasks[currentLesson.currentTaskIndex];
            const totalTasks = lesson.tasks.length;

            let isCorrect = null;

            // –•–µ–¥–µ—Ä —É—Ä–æ–∫–∞
            const header = document.createElement('div');
            header.className = `p-4 shadow-lg flex items-center justify-between bg-${course.color} text-white`;
            header.innerHTML = `
                <button id="exit-lesson-btn" class="flex items-center font-semibold hover:opacity-80 transition">
                    ${getIcon('ChevronLeft', 'w-5 h-5 mr-1')} –í—ã–π—Ç–∏
                </button>
                <div class="font-bold text-lg">${course.title}</div>
                <div class="flex items-center space-x-2">
                    <span class="font-semibold">${currentLesson.currentTaskIndex + 1} / ${totalTasks}</span>
                </div>
            `;
            content.appendChild(header);

            // –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å –∑–∞–¥–∞–Ω–∏—è
            const mainArea = document.createElement('div');
            mainArea.id = 'lesson-main-area';
            mainArea.className = 'flex-grow p-4 sm:p-8 overflow-y-auto';
            content.appendChild(mainArea);
            
            // –§—É—Ç–µ—Ä/–ö–Ω–æ–ø–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è
            const footer = document.createElement('div');
            footer.id = 'lesson-footer';
            footer.className = 'p-4 shadow-2xl bg-white';
            footer.innerHTML = `
                <div class="max-w-3xl mx-auto">
                    <button id="action-btn" class="w-full py-4 rounded-lg font-extrabold text-white transition duration-150 shadow-lg bg-paom-green-600 hover:bg-paom-green-700 disabled:opacity-50" disabled>
                        –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
                    </button>
                </div>
            `;
            content.appendChild(footer);

            // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ø–µ—Ä–µ–¥–∞–µ–º window.icons
            window.createIcons({ icons: window.icons });

            // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI —É—Ä–æ–∫–∞
            function updateLessonUI() {
                const task = lesson.tasks[currentLesson.currentTaskIndex];
                
                let inputHtml = '';
                let inputValue = document.getElementById('lesson-input')?.value || '';

                if (task.type === 'translation' || task.type === 'fill' || task.type === 'math_input' || task.type === 'text') {
                    const inputType = task.type === 'math_input' ? 'number' : 'text';
                    inputHtml = `
                        <input
                            type="${inputType}"
                            id="lesson-input"
                            value="${inputValue}"
                            placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç –∑–¥–µ—Å—å..."
                            class="w-full px-4 py-3 border rounded-lg text-lg focus:outline-none border-gray-300 focus:border-paom-green-500"
                        />
                    `;
                } else if (task.type === 'choice' && task.options) {
                    inputHtml = `
                        <div id="choice-options" class="grid grid-cols-2 gap-3">
                            ${task.options.map(option => `
                                <button
                                    data-value="${option}"
                                    class="choice-option-btn px-4 py-3 border rounded-lg font-medium transition duration-150 bg-gray-100 text-gray-800 hover:bg-gray-200"
                                >
                                    ${option}
                                </button>
                            `).join('')}
                        </div>
                        <input type="hidden" id="lesson-input" value="${inputValue}" />
                    `;
                }

                mainArea.innerHTML = `
                    <div class="max-w-3xl mx-auto space-y-8">
                        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ -->
                        <div class="flex items-start space-x-4 bg-white p-6 rounded-xl shadow-xl border-t-4 border-paom-green-500">
                            <img src="${AVATAR_URLS[0]}" alt="–ü–µ—Ä—Å–æ–Ω–∞–∂" class="w-16 h-16 rounded-full object-cover shadow-md" onerror="this.onerror=null; this.src='https://placehold.co/100x100/4CAF50/ffffff?text=P'"/>
                            <div>
                                <p class="font-bold text-paom-green-700">${task.character}:</p>
                                <p class="text-xl text-gray-800 mt-1">${task.question}</p>
                            </div>
                        </div>

                        <!-- –û–±–ª–∞—Å—Ç—å –≤–≤–æ–¥–∞ –æ—Ç–≤–µ—Ç–∞ -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <p class="text-sm font-medium text-gray-500 mb-3">–í–∞—à –æ—Ç–≤–µ—Ç:</p>
                            ${inputHtml}
                        </div>

                        <!-- –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
                        <div id="feedback-box"></div>
                    </div>
                `;

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏
                const actionBtn = document.getElementById('action-btn');
                actionBtn.textContent = '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å';
                actionBtn.className = 'w-full py-4 rounded-lg font-extrabold text-white transition duration-150 shadow-lg bg-paom-green-600 hover:bg-paom-green-700 disabled:opacity-50';
                actionBtn.disabled = true;

                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –≤–≤–æ–¥–∞ –∏ –≤—ã–±–æ—Ä–∞
                const inputElement = document.getElementById('lesson-input');
                if (inputElement && inputElement.type !== 'hidden') {
                    inputElement.addEventListener('input', (e) => {
                        actionBtn.disabled = e.target.value.trim() === '';
                    });
                    actionBtn.disabled = inputElement.value.trim() === '';
                } else if (task.type === 'choice') {
                    document.querySelectorAll('.choice-option-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const value = e.currentTarget.getAttribute('data-value');
                            inputElement.value = value;
                            document.querySelectorAll('.choice-option-btn').forEach(b => {
                                b.classList.remove('bg-paom-green-600', 'text-white', 'shadow-md');
                                b.classList.add('bg-gray-100', 'text-gray-800', 'hover:bg-gray-200');
                            });
                            e.currentTarget.classList.add('bg-paom-green-600', 'text-white', 'shadow-md');
                            e.currentTarget.classList.remove('bg-gray-100', 'text-gray-800', 'hover:bg-gray-200');
                            actionBtn.disabled = false;
                        });
                    });
                }
            }

            function handleAction() {
                const actionBtn = document.getElementById('action-btn');
                if (actionBtn.textContent !== '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å') {
                    // –≠—Ç–æ –∫–Ω–æ–ø–∫–∞ "–î–∞–ª–µ–µ" –∏–ª–∏ "–ó–∞–≤–µ—Ä—à–∏—Ç—å"
                    currentLesson.currentTaskIndex++;
                    if (currentLesson.currentTaskIndex < totalTasks) {
                        updateLessonUI(); // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –∑–∞–¥–∞–Ω–∏—é
                    } else {
                        // –£—Ä–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω
                        const xpEarned = totalTasks * XP_PER_TASK;
                        const diamondsEarned = Math.floor(Math.random() * (DIAMONDS_PER_LESSON[1] - DIAMONDS_PER_LESSON[0] + 1)) + DIAMONDS_PER_LESSON[0];
                        handleLessonComplete(xpEarned, diamondsEarned);
                    }
                    return;
                }

                // –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏
                const inputElement = document.getElementById('lesson-input');
                const userAnswer = inputElement.value.trim().toLowerCase();
                const expectedAnswer = String(currentTask.answer).trim().toLowerCase();

                isCorrect = userAnswer === expectedAnswer;
                
                const feedbackBox = document.getElementById('feedback-box');
                const footer = document.getElementById('lesson-footer');

                if (isCorrect) {
                    feedbackBox.innerHTML = `<div class="p-4 rounded-xl shadow-md font-bold text-white bg-paom-green-500">–í–µ—Ä–Ω–æ! –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ.</div>`;
                    footer.className = 'p-4 shadow-2xl bg-paom-green-500';
                    actionBtn.textContent = currentLesson.currentTaskIndex < totalTasks - 1 ? '–î–∞–ª–µ–µ' : '–ó–∞–≤–µ—Ä—à–∏—Ç—å –£—Ä–æ–∫';
                    actionBtn.className = 'w-full py-4 rounded-lg font-extrabold text-white transition duration-150 shadow-lg bg-indigo-600 hover:bg-indigo-700';
                    actionBtn.disabled = false;
                } else {
                    feedbackBox.innerHTML = `<div class="p-4 rounded-xl shadow-md font-bold text-white bg-red-500">–ù–µ–≤–µ—Ä–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${currentTask.answer}</div>`;
                    footer.className = 'p-4 shadow-2xl bg-red-500';
                    actionBtn.textContent = currentLesson.currentTaskIndex < totalTasks - 1 ? '–î–∞–ª–µ–µ' : '–ó–∞–≤–µ—Ä—à–∏—Ç—å –£—Ä–æ–∫';
                    actionBtn.className = 'w-full py-4 rounded-lg font-extrabold text-white transition duration-150 shadow-lg bg-indigo-600 hover:bg-indigo-700';
                    actionBtn.disabled = false;
                }
                
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤–≤–æ–¥ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
                if(inputElement.type !== 'hidden') inputElement.disabled = true;
                if(document.getElementById('choice-options')) {
                    document.querySelectorAll('.choice-option-btn').forEach(b => b.disabled = true);
                }
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
            updateLessonUI();

            document.getElementById('exit-lesson-btn').addEventListener('click', () => {
                document.getElementById('nav-menu').style.display = 'flex';
                const mainContent = document.getElementById('main-content');
                mainContent.className = "flex-grow pb-20 lg:pb-0";
                renderView('home');
            });
            document.getElementById('action-btn').addEventListener('click', handleAction);
        }
        
        // 3. –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ (LeaderboardView)

        function startBotUpdates() {
            if (botUpdateInterval) return;
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—á–∫–æ–≤ –±–æ—Ç–æ–≤ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–≥–∏ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
            botUpdateInterval = setInterval(() => {
                let didChange = false;
                
                // 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—á–∫–æ–≤ –±–æ—Ç–æ–≤
                appState.leaderboard.bots = appState.leaderboard.bots.map(bot => {
                    return {
                        ...bot,
                        score: bot.score + Math.floor(Math.random() * 50) + 10,
                        status: ['–ü—Ä–æ—Ö–æ–¥–∏—Ç –ê–Ω–≥–ª–∏–π—Å–∫–∏–π', '–£—á–∏—Ç –ú–∞—Ç–µ–º–∞—Ç–∏–∫—É', '–ü–µ—Ä–µ—à–µ–ª –≤ –Ω–æ–≤—É—é –ª–∏–≥—É'][Math.floor(Math.random() * 3)],
                    };
                });

                // 2. –ò–º–∏—Ç–∞—Ü–∏—è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏–≥–∏ (—Ä–µ–¥–∫–∏–π —à–∞–Ω—Å)
                if (Math.random() < 0.05) {
                    const allPlayers = [
                        { id: 'user', nickname: appState.user.nickname, score: appState.leaderboard.score, isUser: true, avatar: appState.user.avatar },
                        ...appState.leaderboard.bots.map(b => ({ ...b, isUser: false }))
                    ].sort((a, b) => b.score - a.score);

                    const userRank = allPlayers.findIndex(p => p.isUser) + 1;
                    const currentLeagueIndex = LEAGUE_NAMES.indexOf(appState.user.currentLeague);
                    let newLeagueIndex = currentLeagueIndex;
                    let message = `–í–∞—à–∞ –ª–∏–≥–∞ (${appState.user.currentLeague}) –æ—Å—Ç–∞–ª–∞—Å—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.`;

                    // –ü–æ–≤—ã—à–µ–Ω–∏–µ
                    if (userRank <= PROMOTION_ZONE && currentLeagueIndex < LEAGUE_NAMES.length - 1) {
                        newLeagueIndex = currentLeagueIndex + 1;
                        message = `–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –≤ –ª–∏–≥—É ${LEAGUE_NAMES[newLeagueIndex]}.`;
                        didChange = true;
                    }
                    // –ü–æ–Ω–∏–∂–µ–Ω–∏–µ
                    else if (userRank > LEAGUE_SIZES - DEMOTION_ZONE && currentLeagueIndex > 0) {
                        newLeagueIndex = currentLeagueIndex - 1;
                        message = `–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤—ã –æ–ø—É—Å–∫–∞–µ—Ç–µ—Å—å –≤ –ª–∏–≥—É ${LEAGUE_NAMES[newLeagueIndex]}.`;
                        didChange = true;
                    }

                    if (didChange) {
                        const newLeague = LEAGUE_NAMES[newLeagueIndex];
                        appState.user.currentLeague = newLeague;
                        appState.leaderboard.league = newLeague;
                        appState.leaderboard.score = 0; // –°–±—Ä–æ—Å –æ—á–∫–æ–≤
                        appState.leaderboard.bots = generateRandomBots(LEAGUE_SIZES - 1, newLeague);
                        showMessage(message);
                    }
                }

                saveState();
                if (currentView === 'leaderboard') {
                    renderLeaderboardView(false); // –ü–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –±–µ–∑ –æ—á–∏—Å—Ç–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                }
            }, 5000);
        }


        function renderLeaderboardView(clear = true) {
            if (clear) clearContent();
            const content = document.getElementById('app-content');

            const allPlayers = [
                { id: 'user', nickname: appState.user.nickname, score: appState.leaderboard.score, isUser: true, avatar: appState.user.avatar, league: appState.user.currentLeague },
                ...appState.leaderboard.bots.map(b => ({ ...b, isUser: false }))
            ].sort((a, b) => b.score - a.score);

            const playersWithRank = allPlayers.map((player, index) => ({ ...player, rank: index + 1 }));

            const currentLeagueIndex = LEAGUE_NAMES.indexOf(appState.user.currentLeague);
            const nextLeagueName = LEAGUE_NAMES[currentLeagueIndex + 1];

            let playersHtml = '';
            playersWithRank.forEach(player => {
                const isUser = player.isUser;
                const rankStatus = player.rank <= PROMOTION_ZONE ? 'text-green-600 font-extrabold' : (player.rank > LEAGUE_SIZES - DEMOTION_ZONE ? 'text-red-600 font-extrabold' : 'text-gray-700 font-medium');
                const isFriend = appState.user.friends.includes(player.id);
                const isBot = !isUser;

                playersHtml += `
                    <div class="flex items-center p-4 border-b last:border-b-0 transition duration-150 ${isUser ? 'bg-yellow-50 shadow-inner' : 'hover:bg-gray-50'}">
                        <span class="w-10 text-xl text-center ${rankStatus}">${player.rank}</span>
                        <img src="${player.avatar}" alt="–ê–≤–∞—Ç–∞—Ä" class="w-10 h-10 rounded-full mr-4" onerror="this.onerror=null; this.src='https://placehold.co/100x100/4CAF50/ffffff?text=P'"/>
                        <div class="flex-grow">
                            <p class="font-semibold text-lg ${isUser ? 'text-paom-green-700' : 'text-gray-800'}">
                                ${player.nickname} ${isUser ? '(–í—ã)' : ''}
                            </p>
                            <p class="text-sm text-gray-500">${player.league || player.currentLeague}</p>
                        </div>
                        <div class="text-right mr-4">
                            <p class="text-xl font-bold text-gray-900">${player.score}</p>
                            <p class="text-xs text-gray-500">–û—á–∫–∏</p>
                        </div>
                        ${isBot && !isFriend ? `
                            <button
                                data-player-id="${player.id}"
                                class="add-friend-btn bg-paom-green-500 text-white px-3 py-1 rounded-lg text-xs hover:bg-paom-green-600 transition shadow-sm"
                            >
                                + –î—Ä—É–≥
                            </button>
                        ` : ''}
                        <button
                            data-player-id="${player.id}"
                            class="view-profile-btn ml-2 bg-gray-200 text-gray-700 px-3 py-1 rounded-lg text-xs hover:bg-gray-300 transition shadow-sm"
                        >
                            –ü—Ä–æ—Ñ–∏–ª—å
                        </button>
                    </div>
                `;
            });

            content.innerHTML = `
                <div class="space-y-6">
                    <h2 class="text-3xl font-bold text-gray-800">
                        –¢–∞–±–ª–∏—Ü–∞ –õ–∏–¥–µ—Ä–æ–≤
                    </h2>

                    <div class="bg-paom-green-600 text-white p-5 rounded-xl shadow-xl">
                        <h3 class="text-xl font-bold">–¢–µ–∫—É—â–∞—è –ª–∏–≥–∞: ${appState.user.currentLeague}</h3>
                        <p class="text-sm mt-1">–û—á–∫–∏ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è (—Ç–æ–ø ${PROMOTION_ZONE}): ${nextLeagueName ? `–ü–µ—Ä–µ—Ö–æ–¥ –≤ ${nextLeagueName}` : '–í—ã –Ω–∞ –≤–µ—Ä—à–∏–Ω–µ!'}</p>
                        <p class="text-sm text-red-100">–ó–æ–Ω–∞ –ø–æ–Ω–∏–∂–µ–Ω–∏—è (–ø–æ—Å–ª–µ–¥–Ω–∏–µ ${DEMOTION_ZONE} –º–µ—Å—Ç).</p>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        ${playersHtml}
                    </div>
                </div>
            `;

            document.querySelectorAll('.add-friend-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const botId = e.currentTarget.getAttribute('data-player-id');
                    if (!appState.user.friends.includes(botId)) {
                        appState.user.friends.push(botId);
                        saveState();
                        renderLeaderboardView(true);
                        showMessage('–ë–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π!');
                    }
                });
            });

            document.querySelectorAll('.view-profile-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const playerId = e.currentTarget.getAttribute('data-player-id');
                    const player = playersWithRank.find(p => p.id === playerId);
                    if (player) {
                        currentProfile = player;
                        renderView('profile');
                    }
                });
            });
        }

        // 4. –ü—Ä–æ—Ñ–∏–ª—å –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è/–ë–æ—Ç–∞ (ProfileView)

        function showConfirmationModal(title, message, onConfirm, confirmText = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å') {
            const container = document.getElementById('modal-container');
            container.innerHTML = `
                <div class="modal-overlay">
                    <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6 sm:p-8 transform transition-all border-t-4 border-red-600">
                        <h3 class="text-xl font-bold text-gray-800 mb-3">${title}</h3>
                        <p class="text-gray-600 mb-6">${message}</p>
                        <div class="flex justify-end space-x-3">
                            <button id="modal-cancel-btn" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100 transition duration-150">
                                –û—Ç–º–µ–Ω–∞
                            </button>
                            <button id="modal-confirm-btn" class="px-4 py-2 border border-transparent rounded-lg text-sm font-medium text-white bg-red-600 hover:bg-red-700 shadow-md transition duration-150">
                                ${confirmText}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-cancel-btn').addEventListener('click', () => container.innerHTML = '');
            document.getElementById('modal-confirm-btn').addEventListener('click', () => {
                onConfirm();
                container.innerHTML = '';
            });
        }

        function handleResetProgress() {
            const initialLeague = LEAGUE_NAMES[0];
            appState.user.xp = 0;
            appState.user.diamonds = 50;
            appState.user.currentLeague = initialLeague;
            appState.user.completedLessons = {};
            appState.user.xpBoost = { active: false, multiplier: 1, lessonsLeft: 0, bought: false };
            appState.leaderboard.league = initialLeague;
            appState.leaderboard.score = 0;
            appState.leaderboard.bots = generateRandomBots(LEAGUE_SIZES - 1, initialLeague);
            
            saveState();
            renderView('profile');
            showMessage('–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å –±—ã–ª —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω.');
        }

        function handleBuyXP(multiplier, cost) {
            if (appState.user.diamonds < cost) {
                showMessage('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–ª–º–∞–∑–æ–≤!');
                return;
            }
            if (appState.user.xpBoost.active && appState.user.xpBoost.bought) {
                showMessage('–£ –≤–∞—Å —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω –∫—É–ø–ª–µ–Ω–Ω—ã–π –±—É—Å—Ç!');
                return;
            }

            appState.user.diamonds -= cost;
            appState.user.xpBoost = { active: true, multiplier: multiplier, lessonsLeft: 3, bought: true };
            saveState();
            renderProfileView(); // –ü–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞
            showMessage(`–ö—É–ø–ª–µ–Ω –±—É—Å—Ç x${multiplier} –Ω–∞ 3 —É—Ä–æ–∫–∞ –∑–∞ ${cost} üíé!`);
        }

        function renderProfileView() {
            clearContent();
            const content = document.getElementById('app-content');
            
            const profile = currentProfile && currentProfile.id !== 'user' ? 
                appState.leaderboard.bots.find(b => b.id === currentProfile.id) || appState.user : appState.user;
            
            const isUser = profile.id === 'user' || (profile === appState.user);
            
            if (!profile || (!isUser && !appState.leaderboard.bots.find(b => b.id === profile.id))) {
                // –ï—Å–ª–∏ –±–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω (–≤—ã–±—ã–ª –∏–∑ –ª–∏–≥–∏)
                content.innerHTML = `<div class="p-8"><p class="text-red-500">–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.</p><button onclick="currentProfile = null; renderView('leaderboard')" class="mt-4 text-paom-green-600 hover:underline">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ª–∏–¥–µ—Ä–∞–º</button></div>`;
                return;
            }

            let isEditingNickname = false;

            const statCard = (title, value, color) => `
                <div class="p-4 rounded-xl shadow-md bg-${color} border border-gray-200">
                    <p class="text-sm font-medium text-gray-500">${title}</p>
                    <p class="text-2xl font-extrabold text-gray-900 mt-1">${value}</p>
                </div>
            `;

            const buyCard = (title, cost, multiplier) => {
                const isDisabled = appState.user.xpBoost.active && appState.user.xpBoost.bought;
                return `
                    <div class="p-4 rounded-xl shadow-md bg-white border-2 border-paom-green-500 flex items-center justify-between">
                        <div>
                            <p class="font-semibold text-gray-800">${title} (3 —É—Ä–æ–∫–∞)</p>
                            <p class="text-sm text-gray-500 flex items-center mt-1">
                                –°—Ç–æ–∏–º–æ—Å—Ç—å: <span class="font-bold text-paom-green-600 ml-1">${cost} üíé</span>
                            </p>
                        </div>
                        <button
                            data-multiplier="${multiplier}"
                            data-cost="${cost}"
                            class="buy-xp-btn px-4 py-2 bg-paom-green-600 text-white rounded-lg text-sm font-semibold hover:bg-paom-green-700 transition ${isDisabled ? 'bg-gray-400 cursor-not-allowed' : ''}"
                            ${isDisabled ? 'disabled' : ''}
                        >
                            ${isDisabled ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ö—É–ø–∏—Ç—å'}
                        </button>
                    </div>
                `;
            };

            const nicknameBlock = `
                <div id="nickname-display" class="flex items-center space-x-2">
                    <h3 class="text-3xl font-bold text-gray-800">${profile.nickname} ${isUser ? '' : '(–ë–æ—Ç)'}</h3>
                    ${isUser ? `<button id="edit-nickname-btn" class="ml-3 text-gray-400 hover:text-paom-green-600">${getIcon('Edit', 'w-5 h-5')}</button>` : ''}
                </div>
            `;
            
            const editingBlock = isUser ? `
                <div id="nickname-edit" class="hidden flex items-center space-x-2">
                    <input
                        type="text"
                        id="new-nickname-input"
                        value="${appState.user.nickname}"
                        class="px-3 py-1 border rounded-lg text-2xl font-bold text-gray-800 focus:outline-none focus:ring-2 focus:ring-paom-green-500"
                    />
                    <button id="save-nickname-btn" class="p-1 bg-paom-green-500 text-white rounded-full hover:bg-paom-green-600">${getIcon('Check', 'w-5 h-5')}</button>
                    <button id="cancel-nickname-btn" class="p-1 bg-gray-500 text-white rounded-full hover:bg-gray-600">${getIcon('X', 'w-5 h-5')}</button>
                </div>
            ` : '';

            content.innerHTML = `
                <div class="space-y-8">
                    <div class="flex items-center justify-between">
                        <h2 class="text-3xl font-bold text-gray-800">
                            ${isUser ? '–ú–æ–π –ü—Ä–æ—Ñ–∏–ª—å' : '–ü—Ä–æ—Ñ–∏–ª—å –ë–æ—Ç–∞'}
                        </h2>
                        <button onclick="currentProfile = null; renderView('${isUser ? 'home' : 'leaderboard'}')" class="text-paom-green-600 hover:underline flex items-center">
                            ${getIcon('X', 'w-5 h-5 mr-1')} –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                    </div>
            
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                        <!-- –ê–≤–∞—Ç–∞—Ä –∏ –ù–∏–∫–Ω–µ–π–º -->
                        <div class="flex flex-col sm:flex-row items-center sm:items-start space-y-4 sm:space-y-0 sm:space-x-6 pb-6 border-b">
                            <img src="${profile.avatar}" alt="–ê–≤–∞—Ç–∞—Ä" class="w-24 h-24 rounded-full object-cover shadow-xl border-4 border-paom-green-200" onerror="this.onerror=null; this.src='https://placehold.co/100x100/4CAF50/ffffff?text=P'"/>
                            <div class="text-center sm:text-left">
                                ${isUser ? `${nicknameBlock}${editingBlock}` : nicknameBlock}
                                <p class="text-lg text-gray-500 mt-1">${isUser ? '–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å' : profile.league + ' –õ–∏–≥–∞'}</p>
                            </div>
                        </div>

                        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                        <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                            ${statCard("–û–±—â–∏–π XP", profile.xp, "paom-green-100")}
                            ${statCard("–ê–ª–º–∞–∑—ã", profile.diamonds, "blue-100")}
                            ${statCard("–¢–µ–∫—É—â–∏–π —Å—á–µ—Ç", profile.score, "yellow-100")}
                            ${statCard("–õ–∏–≥–∞", profile.currentLeague || profile.league, "purple-100")}
                        </div>

                        ${isUser ? `
                            <!-- –°–µ–∫—Ü–∏—è –º–∞–≥–∞–∑–∏–Ω–∞ –æ–ø—ã—Ç–∞ -->
                            <div class="mt-10 pt-6 border-t border-gray-200">
                                <h3 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">${getIcon('DollarSign', 'w-6 h-6 mr-2 text-paom-green-600')} –ú–∞–≥–∞–∑–∏–Ω –û–ø—ã—Ç–∞</h3>
                                <p class="text-gray-600 mb-4">–ü–æ—Ç—Ä–∞—Ç—å—Ç–µ –∞–ª–º–∞–∑—ã –Ω–∞ —É—Å–∫–æ—Ä–µ–Ω–∏–µ –≤–∞—à–µ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.</p>

                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    ${buyCard("XP –ë—É—Å—Ç x1.5", 50, 1.5)}
                                    ${buyCard("XP –ë—É—Å—Ç x2", 100, 2)}
                                </div>
                            </div>

                            <!-- –û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞ (–°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞) -->
                            <div class="mt-10 pt-6 border-t border-red-200">
                                <h3 class="text-2xl font-semibold text-red-700 mb-4 flex items-center">${getIcon('RefreshCw', 'w-6 h-6 mr-2')} –û–ø–∞—Å–Ω–∞—è –ó–æ–Ω–∞</h3>
                                <p class="text-gray-600 mb-6">–°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —É–¥–∞–ª–∏—Ç –≤—Å–µ –≤–∞—à–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è, XP, –∞–ª–º–∞–∑—ã –∏ –ø–µ—Ä–µ–≤–µ–¥–µ—Ç –≤–∞—Å –≤ –ë—Ä–æ–Ω–∑–æ–≤—É—é –ª–∏–≥—É. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.</p>
                                <button
                                    id="reset-progress-btn"
                                    class="w-full sm:w-auto px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out"
                                >
                                    –°–±—Ä–æ—Å–∏—Ç—å –í–µ—Å—å –ü—Ä–æ–≥—Ä–µ—Å—Å
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ø–µ—Ä–µ–¥–∞–µ–º window.icons
            window.createIcons({ icons: window.icons });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–º–µ–Ω—ã –Ω–∏–∫–∞
            if (isUser) {
                const display = document.getElementById('nickname-display');
                const edit = document.getElementById('nickname-edit');
                
                document.getElementById('edit-nickname-btn').addEventListener('click', () => {
                    display.style.display = 'none';
                    edit.style.display = 'flex';
                });

                document.getElementById('cancel-nickname-btn').addEventListener('click', () => {
                    document.getElementById('new-nickname-input').value = appState.user.nickname;
                    display.style.display = 'flex';
                    edit.style.display = 'none';
                });

                document.getElementById('save-nickname-btn').addEventListener('click', () => {
                    const newNickname = document.getElementById('new-nickname-input').value.trim();
                    if (newNickname && newNickname !== appState.user.nickname) {
                        appState.user.nickname = newNickname;
                        saveState();
                        showMessage('–ù–∏–∫–Ω–µ–π–º —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω!');
                    }
                    display.style.display = 'flex';
                    edit.style.display = 'none';
                    renderProfileView(); // –ü–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
                });

                document.getElementById('reset-progress-btn').addEventListener('click', () => {
                    showConfirmationModal(
                        "–°–±—Ä–æ—Å–∏—Ç—å –ü—Ä–æ–≥—Ä–µ—Å—Å?",
                        "–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞–≤—Å–µ–≥–¥–∞ —É–¥–∞–ª–∏—Ç –≤–∞—à XP, –∞–ª–º–∞–∑—ã –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è. –í—ã –Ω–∞—á–Ω–µ—Ç–µ —Å –ë—Ä–æ–Ω–∑–æ–≤–æ–π –ª–∏–≥–∏.",
                        handleResetProgress,
                        "–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞"
                    );
                });
                
                document.querySelectorAll('.buy-xp-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const multiplier = parseFloat(e.currentTarget.getAttribute('data-multiplier'));
                        const cost = parseInt(e.currentTarget.getAttribute('data-cost'));
                        handleBuyXP(multiplier, cost);
                    });
                });
            }
        }
        
        // 5. –õ–µ–Ω—Ç–∞ –ù–æ–≤–æ—Å—Ç–µ–π (NewsFeedView)

        function renderNewsFeedView() {
            clearContent();
            const content = document.getElementById('app-content');
            
            const friendActivity = appState.leaderboard.bots
                .filter(bot => appState.user.friends.includes(bot.id))
                .map(friend => ({
                    id: friend.id,
                    nickname: friend.nickname,
                    avatar: friend.avatar,
                    status: friend.status,
                    date: new Date(Date.now() - Math.random() * 86400000).toLocaleTimeString(),
                })).sort((a, b) => new Date(b.date) - new Date(a.date));

            let newsHtml = '';
            appState.newsFeed.updates.forEach(item => {
                newsHtml += `
                    <div class="p-3 border-b last:border-b-0">
                        <p class="font-semibold text-gray-800">${item.text}</p>
                        <p class="text-xs text-gray-500 mt-1">${item.date}</p>
                    </div>
                `;
            });
            
            let friendsHtml = '';
            if (friendActivity.length > 0) {
                friendActivity.forEach(friend => {
                    friendsHtml += `
                        <div data-player-id="${friend.id}" class="friend-activity-item flex items-center p-3 border-b last:border-b-0 hover:bg-gray-50 rounded-lg transition cursor-pointer">
                            <img src="${friend.avatar}" alt="–ê–≤–∞—Ç–∞—Ä" class="w-10 h-10 rounded-full mr-4" onerror="this.onerror=null; this.src='https://placehold.co/100x100/4CAF50/ffffff?text=P'"/>
                            <div class='flex-grow'>
                                <p class="font-semibold text-gray-800">${friend.nickname}</p>
                                <p class="text-sm text-gray-600">${friend.status}</p>
                            </div>
                            <span class="text-xs text-gray-400">${friend.date}</span>
                        </div>
                    `;
                });
            } else {
                friendsHtml = `<p class="text-center text-gray-500 p-8">–í–∞—à —Å–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–æ–≤ –∏–∑ –¢–∞–±–ª–∏—Ü—ã –ª–∏–¥–µ—Ä–æ–≤!</p>`;
            }


            content.innerHTML = `
                <div class="space-y-6">
                    <h2 class="text-3xl font-bold text-gray-800">
                        –õ–µ–Ω—Ç–∞ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                    </h2>

                    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∫–ª–∞–¥–æ–∫ -->
                    <div class="flex bg-gray-200 rounded-xl p-1 shadow-inner">
                        <button id="news-tab-btn" class="flex-1 py-2 rounded-lg font-semibold transition bg-white text-paom-green-600 shadow-md">
                            –ù–æ–≤–æ—Å—Ç–∏
                        </button>
                        <button id="friends-tab-btn" class="flex-1 py-2 rounded-lg font-semibold transition text-gray-600">
                            –î—Ä—É–∑—å—è
                        </button>
                    </div>

                    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ -->
                    <div id="newsfeed-content" class="bg-white rounded-xl shadow-lg border border-gray-100 p-4">
                        <div id="news-content-area">${newsHtml}</div>
                        <div id="friends-content-area" class="hidden">${friendsHtml}</div>
                    </div>
                </div>
            `;
            
            const newsTab = document.getElementById('news-tab-btn');
            const friendsTab = document.getElementById('friends-tab-btn');
            const newsArea = document.getElementById('news-content-area');
            const friendsArea = document.getElementById('friends-content-area');
            
            function setActiveTab(tab) {
                if (tab === 'news') {
                    newsTab.className = 'flex-1 py-2 rounded-lg font-semibold transition bg-white text-paom-green-600 shadow-md';
                    friendsTab.className = 'flex-1 py-2 rounded-lg font-semibold transition text-gray-600';
                    newsArea.classList.remove('hidden');
                    friendsArea.classList.add('hidden');
                } else {
                    friendsTab.className = 'flex-1 py-2 rounded-lg font-semibold transition bg-white text-paom-green-600 shadow-md';
                    newsTab.className = 'flex-1 py-2 rounded-lg font-semibold transition text-gray-600';
                    friendsArea.classList.remove('hidden');
                    newsArea.classList.add('hidden');
                }
            }

            newsTab.addEventListener('click', () => setActiveTab('news'));
            friendsTab.addEventListener('click', () => setActiveTab('friends'));
            
            document.querySelectorAll('.friend-activity-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const playerId = e.currentTarget.getAttribute('data-player-id');
                    const player = friendActivity.find(f => f.id === playerId);
                    if(player) {
                        currentProfile = player;
                        renderView('profile');
                    }
                });
            });
        }


        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---

        window.onload = function() {
            appState = loadState();
            
            if (appState.user.isRegistered) {
                renderView('home');
            } else {
                renderAuthScreen();
            }
        };
    </script>
</body>
</html>
