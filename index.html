import React, { useState, useEffect, useMemo, useRef } from 'react';
import { initializeApp } from "firebase/app";
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged, 
  User 
} from "firebase/auth";
import { 
  getFirestore, 
  doc, 
  setDoc, 
  updateDoc,
  onSnapshot, 
  getDoc
} from "firebase/firestore";
import { 
  Palette, 
  Crown, 
  Shield, 
  Activity, 
  User as UserIcon, 
  Loader2 
} from 'lucide-react';

// --- КОНФИГУРАЦИЯ FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyAWV097BE56m2YVNi2D494dyXK41j9V5bE",
  authDomain: "messanger-b0b91.firebaseapp.com",
  projectId: "messanger-b0b91",
  storageBucket: "messanger-b0b91.firebasestorage.app",
  messagingSenderId: "895029700922",
  appId: "1:895029700922:web:35b5f3999f2b3641aa4803",
  measurementId: "G-RQ7GYZPT2G"
};

// --- ИНИЦИАЛИЗАЦИЯ ---
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ID приложения для изоляции данных в базе
const APP_ID = 'pixel-wars-v1';
const GRID_SIZE = 12; // 12x12 = 144 клетки
const COOLDOWN_MS = 800; // Задержка между ходами

// Доступные цвета для игроков
const PLAYER_COLORS = [
  '#ef4444', // Red
  '#f97316', // Orange
  '#eab308', // Yellow
  '#22c55e', // Green
  '#06b6d4', // Cyan
  '#3b82f6', // Blue
  '#a855f7', // Purple
  '#ec4899', // Pink
];

// --- ТИПЫ ---
interface PixelData {
  c: string; // color (hex)
  u: string; // userId
  n: string; // userName
  t: number; // timestamp
}

interface GameState {
  cells: Record<string, PixelData>; // "0_0": { ... }
}

interface LeaderboardEntry {
  uid: string;
  name: string;
  count: number;
  color: string;
}

// --- КОМПОНЕНТ ---
export default function PixelWars() {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);
  
  // Состояние игры
  const [grid, setGrid] = useState<Record<string, PixelData>>({});
  const [selectedColor, setSelectedColor] = useState(PLAYER_COLORS[5]);
  const [playerName, setPlayerName] = useState("");
  const [lastMoveTime, setLastMoveTime] = useState(0);
  const [cooldownProgress, setCooldownProgress] = useState(0);

  // Ссылки для анимации и логики
  const audioRef = useRef<HTMLAudioElement | null>(null);
  const requestRef = useRef<number>();

  // --- 1. АВТОРИЗАЦИЯ ---
  useEffect(() => {
    const init = async () => {
      try {
        await signInAnonymously(auth);
      } catch (e) {
        console.error("Auth failed:", e);
      }
    };
    init();

    return onAuthStateChanged(auth, (u) => {
      setUser(u);
      if (u) {
        // Генерируем случайное имя для новичка
        const randomName = `PixelWarriro-${u.uid.slice(0,3)}`;
        setPlayerName(localStorage.getItem('pixel_name') || randomName);
        setLoading(false);
      }
    });
  }, []);

  // --- 2. СИНХРОНИЗАЦИЯ ПОЛЯ (REAL-TIME) ---
  useEffect(() => {
    if (!user) return;

    // Ссылка на единый документ с состоянием поля
    const boardRef = doc(db, 'artifacts', APP_ID, 'public', 'gamestate');

    const unsubscribe = onSnapshot(boardRef, (docSnap) => {
      if (docSnap.exists()) {
        const data = docSnap.data() as GameState;
        setGrid(data.cells || {});
      } else {
        // Если документа нет, создаем пустой
        setDoc(boardRef, { cells: {} });
      }
    }, (error) => {
      console.error("Sync error:", error);
    });

    return () => unsubscribe();
  }, [user]);

  // --- 3. ЛОГИКА ИГРЫ ---

  // Обработка клика по клетке
  const handleCellClick = async (index: number) => {
    if (!user) return;

    const now = Date.now();
    if (now - lastMoveTime < COOLDOWN_MS) return; // Проверка кулдауна

    // Визуальный эффект кулдауна
    setLastMoveTime(now);
    animateCooldown();

    const cellId = `c${index}`;
    const boardRef = doc(db, 'artifacts', APP_ID, 'public', 'gamestate');

    // Оптимистичное обновление UI (чтобы не ждать сеть)
    const newPixel: PixelData = {
      c: selectedColor,
      u: user.uid,
      n: playerName,
      t: now
    };
    
    setGrid(prev => ({
      ...prev,
      [cellId]: newPixel
    }));

    try {
      // Атомарное обновление конкретного поля в Firestore (Dot notation)
      // "cells.c5": { ... } обновляет только клетку 5, не перезаписывая всё поле
      await updateDoc(boardRef, {
        [`cells.${cellId}`]: newPixel
      });
      
      // Сохраняем имя локально
      localStorage.setItem('pixel_name', playerName);
    } catch (e) {
      console.error("Move failed:", e);
      // Если ошибка (например, документа нет), пробуем создать
      // В реальном проеке лучше обрабатывать это иначе
    }
  };

  // Анимация полоски кулдауна
  const animateCooldown = () => {
    const startTime = Date.now();
    
    const animate = () => {
      const elapsed = Date.now() - startTime;
      const progress = Math.min(elapsed / COOLDOWN_MS, 1) * 100;
      setCooldownProgress(progress);

      if (progress < 100) {
        requestRef.current = requestAnimationFrame(animate);
      }
    };
    
    requestRef.current = requestAnimationFrame(animate);
  };

  // --- 4. ВЫЧИСЛЕНИЕ ЛИДЕРБОРДА ---
  const leaderboard = useMemo(() => {
    const stats: Record<string, LeaderboardEntry> = {};
    
    // Проходим по всем клеткам и считаем владельцев
    Object.values(grid).forEach(pixel => {
      if (!stats[pixel.u]) {
        stats[pixel.u] = {
          uid: pixel.u,
          name: pixel.n,
          count: 0,
          color: pixel.c
        };
      }
      stats[pixel.u].count += 1;
      // Обновляем имя и цвет, если они изменились у игрока
      stats[pixel.u].name = pixel.n; 
      stats[pixel.u].color = pixel.c;
    });

    return Object.values(stats).sort((a, b) => b.count - a.count);
  }, [grid]);

  // Вычисляем процент владения для текущего игрока
  const myStats = leaderboard.find(l => l.uid === user?.uid);
  const totalCells = GRID_SIZE * GRID_SIZE;
  const myPercent = myStats ? Math.round((myStats.count / totalCells) * 100) : 0;

  // --- RENDER ---
  if (loading) {
    return (
      <div className="flex h-screen w-full items-center justify-center bg-gray-900 text-white">
        <Loader2 className="h-10 w-10 animate-spin text-cyan-500" />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-950 text-gray-100 font-sans p-4 md:p-8 flex flex-col items-center">
      
      {/* HEADER */}
      <div className="w-full max-w-4xl mb-6 flex flex-col md:flex-row items-center justify-between gap-4 bg-gray-900/50 p-6 rounded-2xl border border-gray-800 shadow-xl backdrop-blur-sm">
        <div className="flex items-center gap-4">
          <div className="h-12 w-12 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-cyan-900/50">
            <Activity className="text-white h-7 w-7" />
          </div>
          <div>
            <h1 className="text-2xl font-black tracking-tight text-white">
              PIXEL <span className="text-cyan-400">WARS</span>
            </h1>
            <p className="text-xs text-gray-400 font-mono">Real-time Territory Control</p>
          </div>
        </div>

        <div className="flex items-center gap-4 bg-gray-950/50 p-2 rounded-xl border border-gray-800">
          <UserIcon className="h-5 w-5 text-gray-500 ml-2" />
          <input
            type="text"
            value={playerName}
            onChange={(e) => setPlayerName(e.target.value)}
            className="bg-transparent border-none outline-none text-gray-200 font-medium w-32 placeholder-gray-600"
            placeholder="Your Name"
            maxLength={10}
          />
          <div className="h-8 px-3 rounded-lg flex items-center justify-center bg-gray-800 text-sm font-bold border border-gray-700">
            {myPercent}% Owned
          </div>
        </div>
      </div>

      <div className="w-full max-w-5xl flex flex-col lg:flex-row gap-8 items-start justify-center">
        
        {/* GAME BOARD SECTION */}
        <div className="flex flex-col gap-4 items-center">
          
          {/* Main Grid */}
          <div 
            className="grid gap-[1px] bg-gray-800 p-2 rounded-xl shadow-2xl shadow-black/50 border border-gray-800 relative overflow-hidden"
            style={{ 
              gridTemplateColumns: `repeat(${GRID_SIZE}, 1fr)`,
              width: 'min(90vw, 500px)',
              height: 'min(90vw, 500px)'
            }}
          >
            {Array.from({ length: GRID_SIZE * GRID_SIZE }).map((_, i) => {
              const cellId = `c${i}`;
              const cellData = grid[cellId];
              const isOwned = cellData?.u === user?.uid;

              return (
                <button
                  key={i}
                  onClick={() => handleCellClick(i)}
                  className="w-full h-full relative group transition-all duration-300 hover:brightness-110 focus:outline-none"
                  style={{
                    backgroundColor: cellData ? cellData.c : '#1f2937', // Gray-800 default
                  }}
                >
                  {/* Hover Effect */}
                  <div className="absolute inset-0 bg-white opacity-0 group-hover:opacity-10 transition-opacity" />
                  
                  {/* Owner Indicator (Little dot if needed, or subtle border) */}
                  {isOwned && (
                    <div className="absolute inset-0 border-2 border-white/20" />
                  )}
                </button>
              );
            })}
          </div>

          {/* Controls */}
          <div className="w-full max-w-[500px] bg-gray-900 p-4 rounded-xl border border-gray-800 flex flex-col gap-4">
            
            {/* Color Picker */}
            <div className="flex flex-col gap-2">
              <div className="flex items-center gap-2 text-sm text-gray-400 mb-1">
                <Palette className="w-4 h-4" />
                <span>Select Color</span>
              </div>
              <div className="flex justify-between gap-2">
                {PLAYER_COLORS.map(color => (
                  <button
                    key={color}
                    onClick={() => setSelectedColor(color)}
                    className={`w-8 h-8 rounded-full transition-transform hover:scale-110 flex items-center justify-center ${
                      selectedColor === color ? 'ring-2 ring-white scale-110' : 'opacity-70 hover:opacity-100'
                    }`}
                    style={{ backgroundColor: color }}
                  >
                    {selectedColor === color && <div className="w-2 h-2 bg-white rounded-full" />}
                  </button>
                ))}
              </div>
            </div>

            {/* Cooldown Bar */}
            <div className="h-2 bg-gray-800 rounded-full overflow-hidden w-full mt-2">
              <div 
                className={`h-full transition-all duration-100 ease-linear ${
                  cooldownProgress >= 99 ? 'bg-green-500' : 'bg-cyan-500'
                }`}
                style={{ width: `${cooldownProgress}%` }}
              />
            </div>
            <div className="text-center text-[10px] text-gray-500 uppercase tracking-widest">
              {cooldownProgress >= 99 ? 'Ready to Capture' : 'Recharging...'}
            </div>
          </div>
        </div>

        {/* LEADERBOARD SECTION */}
        <div className="w-full lg:w-72 bg-gray-900 rounded-xl border border-gray-800 overflow-hidden shadow-xl flex flex-col h-[500px]">
          <div className="p-4 border-b border-gray-800 bg-gray-800/50 flex items-center gap-2">
            <Crown className="w-5 h-5 text-yellow-500" />
            <span className="font-bold text-gray-200">Dominators</span>
          </div>
          
          <div className="flex-1 overflow-y-auto p-2 space-y-2">
            {leaderboard.length === 0 ? (
              <div className="text-center py-10 text-gray-600 text-sm">
                Map is empty.<br/>Be the first!
              </div>
            ) : (
              leaderboard.map((entry, idx) => (
                <div 
                  key={entry.uid}
                  className={`p-3 rounded-lg flex items-center justify-between border transition-colors ${
                    entry.uid === user?.uid 
                      ? 'bg-white/5 border-gray-600' 
                      : 'bg-gray-800/40 border-transparent hover:bg-gray-800'
                  }`}
                >
                  <div className="flex items-center gap-3">
                    <div className="font-mono text-gray-500 w-4 text-sm">#{idx + 1}</div>
                    <div className="flex flex-col">
                      <span className="font-bold text-sm text-gray-300 truncate w-24">
                        {entry.name || 'Unknown'}
                      </span>
                      <div className="flex items-center gap-1">
                        <div 
                          className="w-2 h-2 rounded-full" 
                          style={{ backgroundColor: entry.color }}
                        />
                        <span className="text-[10px] text-gray-500">Warrior</span>
                      </div>
                    </div>
                  </div>
                  
                  <div className="flex items-center gap-1 bg-gray-950 px-2 py-1 rounded text-xs font-mono text-gray-400 border border-gray-800">
                    <Shield className="w-3 h-3" />
                    {entry.count}
                  </div>
                </div>
              ))
            )}
          </div>

          <div className="p-3 bg-gray-950 border-t border-gray-800 text-center text-xs text-gray-600">
             Total Pixels: {GRID_SIZE * GRID_SIZE}
          </div>
        </div>

      </div>
    </div>
  );
}
