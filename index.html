<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paom Tic Tac Toe</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (–¥–ª—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ JSX –≤ –±—Ä–∞—É–∑–µ—Ä–µ) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- –°—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π -->
    <style>
        .drop-shadow-glow { filter: drop-shadow(0 0 10px rgba(currentColor, 0.5)); }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-slate-950 text-white overflow-hidden">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // –ò–º–ø–æ—Ä—Ç—ã Firebase (–∏—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–¥—É–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é —á–µ—Ä–µ–∑ CDN)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            updateDoc, 
            collection, 
            onSnapshot, 
            addDoc, 
            query, 
            where, 
            getDocs
        } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- –ò–ö–û–ù–ö–ò (Inline SVG Components) ---
        const Icon = ({ path, className, size = 24, color = "currentColor" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            Trophy: (p) => <Icon {...p} path={<><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></>} />,
            User: (p) => <Icon {...p} path={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />,
            Settings: (p) => <Icon {...p} path={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>} />,
            ShoppingBag: (p) => <Icon {...p} path={<><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></>} />,
            Newspaper: (p) => <Icon {...p} path={<><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"/><path d="M18 14h-8"/><path d="M15 18h-5"/><path d="M10 6h8v4h-8V6Z"/></>} />,
            Cpu: (p) => <Icon {...p} path={<><rect x="4" y="4" width="16" height="16" rx="2"/><rect x="9" y="9" width="6" height="6"/><path d="M15 2v2"/><path d="M15 20v2"/><path d="M2 15h2"/><path d="M2 9h2"/><path d="M20 15h2"/><path d="M20 9h2"/><path d="M9 2v2"/><path d="M9 20v2"/></>} />,
            Users: (p) => <Icon {...p} path={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />,
            LogOut: (p) => <Icon {...p} path={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>} />,
            X: (p) => <Icon {...p} path={<><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>} />,
            Check: (p) => <Icon {...p} path={<polyline points="20 6 9 17 4 12"/>} />,
            Loader2: (p) => <Icon {...p} path={<path d="M21 12a9 9 0 1 1-6.219-8.56"/>} />,
            Diamond: (p) => <Icon {...p} path={<path d="M6 3h12l4 6-10 13L2 9Z"/>} />,
            Swords: (p) => <Icon {...p} path={<><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/><line x1="13" x2="19" y1="19" y2="13"/><line x1="16" x2="20" y1="16" y2="20"/><line x1="19" x2="21" y1="21" y2="19"/><polyline points="14.5 6.5 18 3 21 3 21 6 17.5 9.5"/><line x1="5" x2="9" y1="14" y2="18"/><line x1="7" x2="4" y1="17" y2="20"/><line x1="3" x2="5" y1="19" y2="21"/></>} />
        };

        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        
        // 1. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–µ—Ä–µ–º –í–ê–®–£ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
        let firebaseConfig = {
          apiKey: "AIzaSyAWV097BE56m2YVNi2D494dyXK41j9V5bE",
          authDomain: "messanger-b0b91.firebaseapp.com",
          projectId: "messanger-b0b91",
          storageBucket: "messanger-b0b91.firebasestorage.app",
          messagingSenderId: "895029700922",
          appId: "1:895029700922:web:35b5f3999f2b3641aa4803",
          measurementId: "G-RQ7GYZPT2G"
        };

        // 2. –ï—Å–ª–∏ –º—ã –≤ —Å—Ä–µ–¥–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞, –ø–æ–¥–º–µ–Ω—è–µ–º –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω—É—é (—á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–æ —Å–µ–π—á–∞—Å)
        if (typeof window.__firebase_config !== 'undefined') {
             try {
                const envConfig = JSON.parse(window.__firebase_config);
                if (envConfig && envConfig.apiKey) {
                    firebaseConfig = envConfig;
                    console.log("Using Environment Config");
                }
             } catch(e) { console.warn("Env config parse error", e); }
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const getAppId = () => {
            return typeof window.__app_id !== 'undefined' ? window.__app_id : 'paom-tic-tac-toe-public';
        };

        // --- –ö–û–ù–°–¢–ê–ù–¢–´ ---
        const DEFAULT_QUESTS = [
            { id: 'q1', desc: '–í—ã–∏–≥—Ä–∞—Ç—å 3 –º–∞—Ç—á–∞ –≤ —Ä–∞–Ω–≥–æ–≤–æ–º', target: 3, current: 0, reward: 50, claimed: false },
            { id: 'q2', desc: '–°—ã–≥—Ä–∞—Ç—å 5 –∏–≥—Ä —Å –ò–ò', target: 5, current: 0, reward: 30, claimed: false },
            { id: 'q3', desc: '–ö—É–ø–∏—Ç—å 1 –ø—Ä–µ–¥–º–µ—Ç', target: 1, current: 0, reward: 20, claimed: false }
        ];

        const SHOP_ITEMS = [
            { id: 'default_av', name: '–ö–ª–∞—Å—Å–∏–∫–∞ (–ê–≤–∞—Ç–∞—Ä)', type: 'avatar', price: 0, icon: 'üòä' },
            { id: 'robot_av', name: '–ö–∏–±–æ—Ä–≥ (–ê–≤–∞—Ç–∞—Ä)', type: 'avatar', price: 100, icon: 'ü§ñ' },
            { id: 'ninja_av', name: '–ù–∏–Ω–¥–∑—è (–ê–≤–∞—Ç–∞—Ä)', type: 'avatar', price: 250, icon: 'ü•∑' },
            { id: 'default_bd', name: '–°–µ—Ä—ã–π (–î–æ—Å–∫–∞)', type: 'board', price: 0, color: 'bg-gray-800' },
            { id: 'blue_bd', name: '–ù–µ–æ–Ω –°–∏–Ω–∏–π (–î–æ—Å–∫–∞)', type: 'board', price: 150, color: 'bg-blue-900' },
            { id: 'red_bd', name: '–õ–∞–≤–∞ (–î–æ—Å–∫–∞)', type: 'board', price: 300, color: 'bg-red-900' },
        ];

        const NEWS_UPDATES = [
            { ver: '1.1', title: '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –†–∞–Ω–≥–æ–≤—ã–π —Å –±–æ—Ç–∞–º–∏', content: '–î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏–≥—Ä–∞—Ç—å –Ω–∞ —Ä–µ–π—Ç–∏–Ω–≥ –ø—Ä–æ—Ç–∏–≤ –ò–ò, –µ—Å–ª–∏ –Ω–µ—Ç –∏–≥—Ä–æ–∫–æ–≤. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –±–∞–≥–∏ –º–∞–≥–∞–∑–∏–Ω–∞.' },
            { ver: '1.0', title: '–†–µ–ª–∏–∑ Paom.Tic.Tac.Toe', content: '–ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –∏–≥—Ä—ã! –î–æ—Å—Ç—É–ø–Ω—ã: –†–∞–Ω–≥–æ–≤—ã–µ –º–∞—Ç—á–∏, –ò–≥—Ä–∞ —Å –ò–ò (Gemini), –ú–∞–≥–∞–∑–∏–Ω, –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è.' }
        ];

        // --- –ü–†–ò–õ–û–ñ–ï–ù–ò–ï ---
        function App() {
            const [user, setUser] = React.useState(null);
            const [profile, setProfile] = React.useState(null);
            const [currentScreen, setCurrentScreen] = React.useState('auth');
            const [loading, setLoading] = React.useState(false);
            const [errorMsg, setErrorMsg] = React.useState('');
            
            // Auth State
            const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [isRegistering, setIsRegistering] = React.useState(false);

            // Game State
            const [gameMode, setGameMode] = React.useState('ai');
            const [board, setBoard] = React.useState(Array(9).fill(null));
            const [winner, setWinner] = React.useState(null);
            const [matchId, setMatchId] = React.useState(null);
            const [opponentName, setOpponentName] = React.useState('Bot');
            const [isMyTurn, setIsMyTurn] = React.useState(true);
            const [mySymbol, setMySymbol] = React.useState('X');
            const [aiThinking, setAiThinking] = React.useState(false);

            React.useEffect(() => {
                const initAuth = async () => {
                    const token = window.__initial_auth_token;
                    if (token) {
                        try { await signInWithCustomToken(auth, token); } catch(e) { console.error(e); }
                    }
                };
                initAuth();
                const unsub = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if (u) {
                        setCurrentScreen('menu');
                        loadUserProfile(u.uid);
                    } else {
                        setCurrentScreen('auth');
                        setProfile(null);
                    }
                });
                return () => unsub();
            }, []);

            const loadUserProfile = (uid) => {
                const appId = getAppId();
                const docRef = doc(db, 'artifacts', appId, 'users', uid, 'profile', 'data');
                
                return onSnapshot(docRef, async (snap) => {
                    if (snap.exists()) {
                        const data = snap.data();
                        // Check daily reset
                        const today = new Date().toDateString();
                        if (data.lastLogin !== today) {
                            const newQuests = DEFAULT_QUESTS.map(q => ({...q}));
                            await updateDoc(docRef, { quests: newQuests, lastLogin: today });
                        }
                        setProfile(data);
                    } else {
                        const newProfile = {
                            nickname: `Player${Math.floor(Math.random()*1000)}`,
                            elo: 1000,
                            diamonds: 50,
                            avatar: 'default_av',
                            boardSkin: 'default_bd',
                            inventory: ['default_av', 'default_bd'],
                            settings: { geminiKey: '', rankedWithBots: false },
                            quests: DEFAULT_QUESTS,
                            lastLogin: new Date().toDateString()
                        };
                        await setDoc(docRef, newProfile);
                    }
                }, (err) => console.error("Profile load error", err));
            };

            const handleAuth = async (e) => {
                e.preventDefault();
                setLoading(true);
                setErrorMsg('');
                try {
                    if (isRegistering) {
                        await createUserWithEmailAndPassword(auth, email, password);
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) {
                    setErrorMsg(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleLogout = () => signOut(auth);

            const updateQuestProgress = async (type, amount = 1) => {
                if (!user || !profile) return;
                const appId = getAppId();
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data');
                
                const updatedQuests = profile.quests.map(q => {
                    if (q.claimed) return q;
                    let match = false;
                    if (type === 'win_ranked' && q.id === 'q1') match = true;
                    if (type === 'play_ai' && q.id === 'q2') match = true;
                    if (type === 'buy_item' && q.id === 'q3') match = true;

                    if (match) {
                        return { ...q, current: Math.min(q.current + amount, q.target) };
                    }
                    return q;
                });

                await updateDoc(docRef, { quests: updatedQuests });
            };

            const claimQuest = async (questId) => {
                if (!user || !profile) return;
                const quest = profile.quests.find(q => q.id === questId);
                if (!quest || quest.claimed || quest.current < quest.target) return;

                const appId = getAppId();
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data');
                
                const updatedQuests = profile.quests.map(q => q.id === questId ? { ...q, claimed: true } : q);
                
                await updateDoc(docRef, { 
                    quests: updatedQuests,
                    diamonds: profile.diamonds + quest.reward
                });
            };

            const calculateWinner = (squares) => {
                const lines = [
                    [0, 1, 2], [3, 4, 5], [6, 7, 8],
                    [0, 3, 6], [1, 4, 7], [2, 5, 8],
                    [0, 4, 8], [2, 4, 6],
                ];
                for (let i = 0; i < lines.length; i++) {
                    const [a, b, c] = lines[i];
                    if (squares[a] && squares[a] === squares[b] && squares[a] === squares[c]) {
                        return squares[a];
                    }
                }
                return squares.includes(null) ? null : 'Draw';
            };

            const startGame = async (mode, friendId) => {
                setGameMode(mode);
                setBoard(Array(9).fill(null));
                setWinner(null);
                setMatchId(null);
                
                if (mode === 'ai') {
                    setOpponentName("Gemini AI");
                    setMySymbol('X');
                    setIsMyTurn(true);
                    setCurrentScreen('game');
                } else if (mode === 'ranked') {
                    setLoading(true);
                    await findRankedMatch();
                } else if (mode === 'friend') {
                    alert("–í –¥–µ–º–æ —Ä–µ–∂–∏–º–µ –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ '–†–∞–Ω–≥–æ–≤—ã–π –º–∞—Ç—á' (—Å–æ–∑–¥–∞–Ω–∏–µ –ø—É–±–ª–∏—á–Ω–æ–π –∫–æ–º–Ω–∞—Ç—ã).");
                }
            };

            const findRankedMatch = async () => {
                if (profile?.settings.rankedWithBots) {
                    setOpponentName("Bot (Ranked)");
                    setMySymbol('X');
                    setIsMyTurn(true);
                    setCurrentScreen('game');
                    setLoading(false);
                    return;
                }

                const appId = getAppId();
                const matchesRef = collection(db, 'artifacts', appId, 'public', 'data', 'matches');
                
                try {
                    const q = query(matchesRef, where("status", "==", "waiting"));
                    const querySnapshot = await getDocs(q);
                    
                    let foundMatch = null;
                    querySnapshot.forEach((doc) => {
                        if (doc.data().player1Id !== user.uid) foundMatch = doc;
                    });

                    if (foundMatch) {
                        const matchDoc = foundMatch;
                        await updateDoc(doc(matchesRef, matchDoc.id), {
                            player2Id: user.uid,
                            player2Name: profile?.nickname || 'Player 2',
                            status: 'active',
                            currentTurn: 'X'
                        });
                        setMatchId(matchDoc.id);
                        setMySymbol('O');
                        setOpponentName(matchDoc.data().player1Name);
                        setIsMyTurn(false);
                        subscribeToMatch(matchDoc.id);
                    } else {
                        const newMatch = {
                            player1Id: user.uid,
                            player1Name: profile?.nickname || 'Player 1',
                            status: 'waiting',
                            board: Array(9).fill(null),
                            currentTurn: 'X',
                            winner: null,
                            createdAt: Date.now()
                        };
                        const docRef = await addDoc(matchesRef, newMatch);
                        setMatchId(docRef.id);
                        setMySymbol('X');
                        setOpponentName("–ü–æ–∏—Å–∫...");
                        setIsMyTurn(true);
                        subscribeToMatch(docRef.id);
                    }
                } catch (err) {
                    console.error("Matchmaking error:", err);
                    alert("–û—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.");
                    setLoading(false);
                }
            };

            const subscribeToMatch = (id) => {
                const appId = getAppId();
                setLoading(false);
                setCurrentScreen('game');

                onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'matches', id), async (docSnap) => {
                    if (!docSnap.exists()) return;
                    const data = docSnap.data();

                    setBoard(data.board);
                    
                    if (mySymbol === 'X' && data.player2Name && opponentName === "–ü–æ–∏—Å–∫...") {
                        setOpponentName(data.player2Name);
                    }
                    setIsMyTurn(data.currentTurn === mySymbol);

                    if (data.winner) {
                        setWinner(data.winner);
                        handleGameEnd(data.winner);
                    } else {
                        const w = calculateWinner(data.board);
                        if (w && !data.winner && isMyTurn) {
                            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matches', id), { winner: w });
                        }
                    }
                });
            };

            const handleClick = async (i) => {
                if (board[i] || winner || !isMyTurn) return;

                const newBoard = [...board];
                newBoard[i] = mySymbol;
                setBoard(newBoard);
                setIsMyTurn(false);

                if (gameMode === 'ai' || (gameMode === 'ranked' && profile?.settings.rankedWithBots && opponentName.includes("Bot"))) {
                    const w = calculateWinner(newBoard);
                    if (w) {
                        setWinner(w);
                        handleGameEnd(w);
                        return;
                    }
                    setAiThinking(true);
                    makeAiMove(newBoard);
                } else if (matchId) {
                    const appId = getAppId();
                    const nextTurn = mySymbol === 'X' ? 'O' : 'X';
                    const w = calculateWinner(newBoard);
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'matches', matchId), {
                        board: newBoard,
                        currentTurn: nextTurn,
                        winner: w || null
                    });
                }
            };

            const makeAiMove = async (currentBoard) => {
                try {
                    let moveIndex = -1;
                    if (profile?.settings.geminiKey) {
                        const prompt = `Play Tic Tac Toe. You are 'O'. The board is represented as an array of 9 elements (0-8), where null is empty, 'X' is opponent, 'O' is you. Current board: ${JSON.stringify(currentBoard)}. Return ONLY the index (0-8) of your next move. Valid moves are indices with null.`;
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${profile.settings.geminiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });
                        const data = await response.json();
                        const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        const parsed = parseInt(text?.trim() || "-1");
                        if (!isNaN(parsed) && currentBoard[parsed] === null) moveIndex = parsed;
                    }

                    if (moveIndex === -1) {
                        const emptyIndices = currentBoard.map((v, k) => v === null ? k : null).filter(v => v !== null);
                        if (emptyIndices.length > 0) moveIndex = emptyIndices[Math.floor(Math.random() * emptyIndices.length)];
                    }

                    if (moveIndex !== -1) {
                        setTimeout(() => {
                            const aiBoard = [...currentBoard];
                            aiBoard[moveIndex] = 'O';
                            setBoard(aiBoard);
                            setAiThinking(false);
                            setIsMyTurn(true);
                            const w = calculateWinner(aiBoard);
                            if (w) {
                                setWinner(w);
                                handleGameEnd(w);
                            }
                        }, 600);
                    }
                } catch (e) {
                    console.error("AI Error", e);
                    setAiThinking(false);
                    setIsMyTurn(true);
                }
            };

            const handleGameEnd = async (w) => {
                if (!profile || !user) return;
                const isWin = w === mySymbol;
                const isDraw = w === 'Draw';
                const isLoss = !isWin && !isDraw;

                const appId = getAppId();
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data');
                
                let eloChange = 0;
                if (gameMode === 'ranked' || (gameMode === 'ranked' && profile.settings.rankedWithBots)) {
                    if (isWin) eloChange = 25;
                    if (isLoss) eloChange = -25;
                }

                if (isWin && gameMode === 'ranked') updateQuestProgress('win_ranked');
                if (gameMode === 'ai') updateQuestProgress('play_ai');

                const newElo = Math.max(0, profile.elo + eloChange);
                await updateDoc(docRef, { elo: newElo });
            };

            // --- SCREENS ---
            const AuthScreen = () => (
                <div className="flex flex-col items-center justify-center min-h-screen bg-slate-900 text-white p-4">
                    <div className="w-full max-w-md bg-slate-800 p-8 rounded-2xl shadow-2xl border border-slate-700">
                        <h1 className="text-4xl font-bold text-center mb-2 bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">Paom ID</h1>
                        <p className="text-center text-slate-400 mb-8">–í—Ö–æ–¥ –≤ Paom.Tic.Tac.Toe</p>
                        {errorMsg && <div className="bg-red-500/20 text-red-200 p-3 rounded mb-4 text-sm">{errorMsg}</div>}
                        <form onSubmit={handleAuth} className="space-y-4">
                            <div>
                                <label className="block text-xs font-medium text-slate-400 mb-1">EMAIL</label>
                                <input type="email" required className="w-full bg-slate-900 border border-slate-700 rounded p-3" placeholder="name@example.com" value={email} onChange={(e) => setEmail(e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-xs font-medium text-slate-400 mb-1">–ü–ê–†–û–õ–¨</label>
                                <input type="password" required className="w-full bg-slate-900 border border-slate-700 rounded p-3" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value={password} onChange={(e) => setPassword(e.target.value)} />
                            </div>
                            <button type="submit" disabled={loading} className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl flex justify-center items-center shadow-lg">
                                {loading ? <Icons.Loader2 className="animate-spin" /> : (isRegistering ? '–°–æ–∑–¥–∞—Ç—å Paom ID' : '–í–æ–π—Ç–∏')}
                            </button>
                        </form>
                        <div className="mt-6 text-center">
                            <button onClick={() => setIsRegistering(!isRegistering)} className="text-sm text-slate-400 hover:text-white underline underline-offset-4">
                                {isRegistering ? '–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏' : '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è'}
                            </button>
                        </div>
                    </div>
                </div>
            );

            const MainMenu = () => (
                <div className="flex flex-col h-screen bg-slate-900 text-white overflow-hidden">
                    <div className="p-4 bg-slate-800/50 flex justify-between items-center backdrop-blur-sm border-b border-slate-700/50">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-lg shadow-inner">
                                {SHOP_ITEMS.find(i => i.id === profile?.avatar)?.icon || 'üë§'}
                            </div>
                            <div>
                                <div className="font-bold">{profile?.nickname}</div>
                                <div className="text-xs text-yellow-400 flex items-center gap-1"><Icons.Trophy size={12} /> {profile?.elo} ELO</div>
                            </div>
                        </div>
                        <div className="flex items-center gap-2 bg-slate-900 px-3 py-1 rounded-full border border-slate-700">
                            <Icons.Diamond size={14} className="text-cyan-400" /><span className="font-mono">{profile?.diamonds}</span>
                        </div>
                    </div>
                    <div className="flex-1 p-6 flex flex-col items-center justify-center gap-4 relative">
                        <div className="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none">
                            <div className="absolute top-10 left-10 w-32 h-32 bg-blue-500 rounded-full blur-3xl"></div>
                            <div className="absolute bottom-10 right-10 w-64 h-64 bg-purple-500 rounded-full blur-3xl"></div>
                        </div>
                        <button onClick={() => startGame('ranked')} className="w-full max-w-sm bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 text-white p-6 rounded-2xl shadow-lg flex items-center justify-between group transition-all transform hover:scale-105">
                            <div className="text-left"><div className="text-2xl font-black italic">–ò–ì–†–ê–¢–¨</div><div className="text-blue-200 text-sm">–†–∞–Ω–≥–æ–≤—ã–π –º–∞—Ç—á</div></div>
                            <Icons.Swords size={32} className="group-hover:rotate-12 transition-transform" />
                        </button>
                        <div className="grid grid-cols-2 gap-4 w-full max-w-sm">
                            <button onClick={() => startGame('ai')} className="bg-slate-800 p-4 rounded-xl border border-slate-700 hover:border-blue-500 flex flex-col items-center gap-2"><Icons.Cpu size={24} className="text-emerald-400" /><span className="font-bold text-sm">–ü—Ä–æ—Ç–∏–≤ –ò–ò</span></button>
                            <button onClick={() => startGame('friend')} className="bg-slate-800 p-4 rounded-xl border border-slate-700 hover:border-blue-500 flex flex-col items-center gap-2"><Icons.Users size={24} className="text-pink-400" /><span className="font-bold text-sm">–° –î—Ä—É–≥–æ–º</span></button>
                            <button onClick={() => setCurrentScreen('shop')} className="bg-slate-800 p-4 rounded-xl border border-slate-700 hover:border-blue-500 flex flex-col items-center gap-2"><Icons.ShoppingBag size={24} className="text-yellow-400" /><span className="font-bold text-sm">–ú–∞–≥–∞–∑–∏–Ω</span></button>
                            <button onClick={() => setCurrentScreen('news')} className="bg-slate-800 p-4 rounded-xl border border-slate-700 hover:border-blue-500 flex flex-col items-center gap-2"><Icons.Newspaper size={24} className="text-slate-400" /><span className="font-bold text-sm">–ù–æ–≤–æ—Å—Ç–∏</span></button>
                        </div>
                        <div className="w-full max-w-sm mt-4 bg-slate-800/80 rounded-xl p-4 border border-slate-700">
                            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</h3>
                            <div className="space-y-2">
                                {profile?.quests.slice(0, 2).map(q => (
                                    <div key={q.id} className="flex justify-between items-center text-sm">
                                        <span className="truncate flex-1 text-slate-300">{q.desc}</span>
                                        <div className="flex items-center gap-2">
                                            <span className="text-xs text-slate-500">{q.current}/{q.target}</span>
                                            {q.current >= q.target && !q.claimed ? (
                                                <button onClick={() => claimQuest(q.id)} className="text-xs bg-yellow-500 text-black px-2 py-1 rounded font-bold animate-pulse">Claim</button>
                                            ) : q.claimed ? <Icons.Check size={14} className="text-green-500" /> : (
                                                <div className="w-14 h-1 bg-slate-700 rounded-full overflow-hidden"><div className="h-full bg-blue-500" style={{width: `${(q.current/q.target)*100}%`}}></div></div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <button onClick={() => setCurrentScreen('profile')} className="w-full mt-3 text-xs text-center text-slate-500 hover:text-white">–í—Å–µ –∑–∞–¥–∞–Ω–∏—è & –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                        </div>
                    </div>
                </div>
            );

            const GameScreen = () => {
                const status = winner ? (winner === 'Draw' ? "–ù–∏—á—å—è!" : `–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${winner}`) : aiThinking ? "–ò–ò –¥—É–º–∞–µ—Ç..." : (isMyTurn ? "–¢–≤–æ–π —Ö–æ–¥" : `–•–æ–¥ ${opponentName}`);
                const boardStyle = SHOP_ITEMS.find(i => i.id === profile?.boardSkin)?.color || 'bg-gray-800';
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen bg-slate-950 text-white p-4">
                        <div className="w-full max-w-md mb-8 flex justify-between items-end">
                            <div className="flex flex-col"><span className="text-xs text-slate-500">–í—ã –∏–≥—Ä–∞–µ—Ç–µ –∑–∞</span><span className="text-2xl font-black text-blue-400">{mySymbol}</span></div>
                            <div className="text-center"><div className="text-3xl font-bold mb-1">{status}</div>{matchId && <div className="text-xs font-mono text-slate-600">ID: {matchId.slice(0,6)}...</div>}</div>
                            <div className="flex flex-col items-end"><span className="text-xs text-slate-500">–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫</span><span className="text-lg font-bold text-red-400 max-w-[100px] truncate">{opponentName}</span></div>
                        </div>
                        <div className={`grid grid-cols-3 gap-3 p-3 rounded-2xl shadow-2xl ${boardStyle}`}>
                            {board.map((sq, i) => (
                                <button key={i} onClick={() => handleClick(i)} className={`w-24 h-24 rounded-xl bg-slate-900/50 backdrop-blur-sm flex items-center justify-center text-5xl font-black transition-all ${!sq && !winner && isMyTurn ? 'hover:bg-slate-800 cursor-pointer' : 'cursor-default'}`}>
                                    {sq === 'X' && <span className="text-blue-400 drop-shadow-glow">X</span>}{sq === 'O' && <span className="text-red-400 drop-shadow-glow">O</span>}
                                </button>
                            ))}
                        </div>
                        {winner && (
                            <div className="mt-8 flex gap-4 animate-in fade-in slide-in-from-bottom-4">
                                <button onClick={() => setCurrentScreen('menu')} className="bg-slate-700 hover:bg-slate-600 text-white px-8 py-3 rounded-xl font-bold">–í –º–µ–Ω—é</button>
                                <button onClick={() => startGame(gameMode)} className="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-xl font-bold shadow-lg">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                            </div>
                        )}
                        {!winner && !isMyTurn && !aiThinking && gameMode === 'ranked' && <div className="mt-4 flex items-center gap-2 text-slate-500 text-sm animate-pulse"><Icons.Loader2 size={16} className="animate-spin" /> –û–∂–∏–¥–∞–Ω–∏–µ...</div>}
                    </div>
                );
            };

            const ShopScreen = () => (
                <div className="min-h-screen bg-slate-900 text-white p-4">
                    <div className="flex items-center justify-between mb-6">
                        <button onClick={() => setCurrentScreen('menu')} className="p-2 hover:bg-slate-800 rounded-full"><Icons.X /></button>
                        <div className="flex items-center gap-2 bg-slate-800 px-4 py-2 rounded-full"><Icons.Diamond size={16} className="text-cyan-400" /><span className="font-bold">{profile?.diamonds}</span></div>
                    </div>
                    <h2 className="text-2xl font-bold mb-4 px-2">–ú–∞–≥–∞–∑–∏–Ω</h2>
                    <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                        {SHOP_ITEMS.map(item => {
                            const isOwned = profile?.inventory.includes(item.id);
                            const isEquipped = profile?.avatar === item.id || profile?.boardSkin === item.id;
                            return (
                                <div key={item.id} className="bg-slate-800 p-4 rounded-xl border border-slate-700 flex flex-col items-center gap-3">
                                    <div className={`w-16 h-16 rounded-full flex items-center justify-center text-3xl ${item.color || 'bg-slate-700'}`}>{item.icon || (item.type === 'board' ? 'üé®' : '?')}</div>
                                    <div className="text-center"><div className="font-bold text-sm">{item.name}</div>{!isOwned && <div className="text-cyan-400 text-xs flex items-center justify-center gap-1 mt-1"><Icons.Diamond size={10} /> {item.price}</div>}</div>
                                    {isOwned ? (
                                        <button onClick={async () => {
                                            const appId = getAppId();
                                            const update = item.type === 'avatar' ? { avatar: item.id } : { boardSkin: item.id };
                                            await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data'), update);
                                        }} disabled={isEquipped} className={`w-full py-2 rounded-lg text-xs font-bold ${isEquipped ? 'bg-green-600/20 text-green-400' : 'bg-slate-700 hover:bg-slate-600'}`}>{isEquipped ? '–í—ã–±—Ä–∞–Ω–æ' : '–í—ã–±—Ä–∞—Ç—å'}</button>
                                    ) : (
                                        <button onClick={async () => {
                                            if ((profile?.diamonds || 0) >= item.price) {
                                                const appId = getAppId();
                                                await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data'), { inventory: [...(profile?.inventory || []), item.id], diamonds: (profile?.diamonds || 0) - item.price });
                                                updateQuestProgress('buy_item');
                                            } else { alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–ª–º–∞–∑–æ–≤!"); }
                                        }} className="w-full bg-cyan-600 hover:bg-cyan-500 py-2 rounded-lg text-xs font-bold">–ö—É–ø–∏—Ç—å</button>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );

            const ProfileSettingsScreen = () => {
                const [localNick, setLocalNick] = React.useState(profile?.nickname || '');
                const [localKey, setLocalKey] = React.useState(profile?.settings.geminiKey || '');

                const saveSettings = async () => {
                    if (!user) return;
                    const appId = getAppId();
                    await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data'), { nickname: localNick, 'settings.geminiKey': localKey, 'settings.rankedWithBots': profile?.settings.rankedWithBots });
                    alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!");
                };

                const toggleBotRanked = async () => {
                    if (!user) return;
                    const appId = getAppId();
                    await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data'), { 'settings.rankedWithBots': !profile?.settings.rankedWithBots });
                }

                return (
                    <div className="min-h-screen bg-slate-900 text-white p-4">
                        <div className="flex items-center gap-4 mb-6"><button onClick={() => setCurrentScreen('menu')} className="p-2 hover:bg-slate-800 rounded-full"><Icons.X /></button><h2 className="text-xl font-bold">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2></div>
                        <div className="space-y-6">
                            <div className="bg-slate-800 p-4 rounded-xl">
                                <h3 className="font-bold text-yellow-400 mb-4 flex items-center gap-2"><Icons.Trophy size={18} /> –ó–∞–¥–∞–Ω–∏—è</h3>
                                <div className="space-y-3">
                                    {profile?.quests.map(q => (
                                        <div key={q.id} className="bg-slate-900/50 p-3 rounded-lg flex justify-between items-center">
                                            <div><div className="text-sm font-medium">{q.desc}</div><div className="text-xs text-slate-500 mt-1">{q.current}/{q.target}</div></div>
                                            {q.claimed ? <div className="text-green-500 text-xs font-bold">–ü–æ–ª—É—á–µ–Ω–æ</div> : q.current >= q.target ? <button onClick={() => claimQuest(q.id)} className="bg-yellow-500 text-black px-3 py-1 rounded text-xs font-bold">–ó–∞–±—Ä–∞—Ç—å</button> : <div className="text-slate-600 text-xs">{q.reward} üíé</div>}
                                        </div> 
                                    ))}
                                </div>
                            </div>
                            <div className="bg-slate-800 p-4 rounded-xl space-y-4">
                                <h3 className="font-bold text-blue-400 flex items-center gap-2"><Icons.Settings size={18} /> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                                <div><label className="block text-xs text-slate-400 mb-1">–ù–∏–∫–Ω–µ–π–º</label><input value={localNick} onChange={e => setLocalNick(e.target.value)} className="w-full bg-slate-900 p-2 rounded border border-slate-700" /></div>
                                <div><label className="block text-xs text-slate-400 mb-1">Gemini API Key</label><input value={localKey} type="password" onChange={e => setLocalKey(e.target.value)} className="w-full bg-slate-900 p-2 rounded border border-slate-700" /></div>
                                <div className="flex items-center justify-between p-2 bg-slate-900 rounded border border-slate-700"><span className="text-sm">–†–∞–Ω–≥–æ–≤—ã–π —Å –±–æ—Ç–∞–º–∏</span><button onClick={toggleBotRanked} className={`w-12 h-6 rounded-full transition-colors relative ${profile?.settings.rankedWithBots ? 'bg-green-500' : 'bg-slate-600'}`}><div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-all ${profile?.settings.rankedWithBots ? 'left-7' : 'left-1'}`}></div></button></div>
                                <button onClick={saveSettings} className="w-full bg-blue-600 py-2 rounded font-bold hover:bg-blue-500">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                <div className="pt-4 border-t border-slate-700"><button onClick={handleLogout} className="w-full text-red-400 text-sm flex items-center justify-center gap-2 hover:bg-slate-900 py-2 rounded"><Icons.LogOut size={16}/> –í—ã–π—Ç–∏</button></div>
                            </div>
                        </div>
                    </div>
                );
            };

            const NewsScreen = () => (
                <div className="min-h-screen bg-slate-900 text-white p-4">
                    <div className="flex items-center gap-4 mb-6"><button onClick={() => setCurrentScreen('menu')} className="p-2 hover:bg-slate-800 rounded-full"><Icons.X /></button><h2 className="text-xl font-bold">–û–±–Ω–æ–≤–ª–µ–Ω–∏—è</h2></div>
                    <div className="space-y-4">{NEWS_UPDATES.map((news, idx) => <div key={idx} className="bg-slate-800 p-5 rounded-xl border-l-4 border-blue-500 shadow-lg"><div className="flex justify-between items-start mb-2"><h3 className="font-bold text-lg">{news.title}</h3><span className="bg-slate-900 px-2 py-1 rounded text-xs font-mono text-blue-400">v{news.ver}</span></div><p className="text-slate-300 text-sm leading-relaxed">{news.content}</p></div>)}</div>
                </div>
            );

            if (loading && currentScreen === 'auth') return <div className="min-h-screen bg-slate-950 flex items-center justify-center text-white"><Icons.Loader2 className="animate-spin" size={48} /></div>;

            return (
                <div className="font-sans">
                    {currentScreen === 'auth' && <AuthScreen />}
                    {currentScreen === 'menu' && <MainMenu />}
                    {currentScreen === 'game' && <GameScreen />}
                    {currentScreen === 'shop' && <ShopScreen />}
                    {currentScreen === 'profile' && <ProfileSettingsScreen />}
                    {currentScreen === 'settings' && <ProfileSettingsScreen />}
                    {currentScreen === 'news' && <NewsScreen />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
