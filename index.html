<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Крестики-Нолики Мультиплеер</title>
    
    <!-- PERFORMANCE OPTIMIZATIONS -->
    <!-- Ускоряем соединение с серверами Google и Firebase -->
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://identitytoolkit.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Загружаем модули Firebase заранее, параллельно, а не последовательно -->
    <link rel="modulepreload" href="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js">
    <link rel="modulepreload" href="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js">
    <link rel="modulepreload" href="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js">

    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Критические стили для лоадера, чтобы он появился мгновенно до загрузки Tailwind */
        #loading-view {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #0f172a; /* slate-900 */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
            color: #e2e8f0;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(99, 102, 241, 0.3);
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen bg-slate-900 text-slate-100 flex flex-col items-center justify-center p-4">

    <!-- LOADING VIEW -->
    <div id="loading-view">
        <div class="spinner"></div>
        <p class="text-indigo-300 animate-pulse font-sans">Подключение к серверу...</p>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="app-container" class="w-full max-w-md hidden fade-in">
        
        <!-- MENU VIEW -->
        <div id="menu-view" class="hidden">
            <div class="bg-slate-800 rounded-2xl shadow-2xl overflow-hidden border border-slate-700 p-8 text-center">
                <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-indigo-400 to-cyan-400 bg-clip-text text-transparent">
                    Крестики-Нолики
                </h1>
                <p class="text-slate-400 mb-8">Мультиплеер</p>

                <div class="space-y-4">
                    <button id="btn-create" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-3 px-6 rounded-lg transition-all flex items-center justify-center gap-2 group">
                        <!-- Play Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                        Создать игру
                    </button>

                    <div class="relative my-4">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-slate-600"></div>
                        </div>
                        <div class="relative flex justify-center text-sm">
                            <span class="px-2 bg-slate-800 text-slate-500">или войди</span>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <input id="input-code" type="text" placeholder="Код комнаты" maxlength="5"
                            class="flex-1 bg-slate-900 border border-slate-600 text-white rounded-lg px-4 py-2 focus:outline-none focus:border-indigo-500 font-mono text-center tracking-widest uppercase placeholder:normal-case placeholder:tracking-normal">
                        <button id="btn-join" disabled class="bg-slate-700 hover:bg-slate-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-semibold py-2 px-4 rounded-lg transition-all">
                            Войти
                        </button>
                    </div>
                    
                    <div id="menu-error" class="hidden mt-4 p-3 bg-red-900/50 border border-red-700 rounded text-red-200 text-sm"></div>
                </div>
            </div>
        </div>

        <!-- GAME VIEW -->
        <div id="game-view" class="hidden w-full">
            
            <!-- Header -->
            <div class="flex justify-between items-center mb-6 bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-sm">
                <div>
                    <span class="text-xs text-slate-400 uppercase tracking-wider block">Комната</span>
                    <div class="flex items-center gap-2">
                        <span id="display-room-code" class="text-2xl font-mono font-bold text-white tracking-widest"></span>
                        <button id="btn-copy" class="p-1.5 hover:bg-slate-700 rounded-md transition-colors text-indigo-400" title="Скопировать">
                            <!-- Copy Icon -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                        </button>
                    </div>
                </div>
                <button id="btn-leave" class="p-2 hover:bg-red-900/30 text-red-400 rounded-lg transition-colors" title="Выйти">
                    <!-- LogOut Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                </button>
            </div>

            <!-- Status Area -->
            <div class="text-center mb-6">
                <div id="player-role-badge" class="inline-block px-4 py-1 bg-slate-800 rounded-full text-sm text-slate-400 mb-2 border border-slate-700">
                    <!-- Populated by JS -->
                </div>
                <h2 id="game-status" class="text-2xl font-bold flex items-center justify-center gap-2 min-h-[2rem]">
                    <!-- Status Text -->
                </h2>
            </div>

            <!-- Waiting for Opponent -->
            <div id="waiting-screen" class="hidden bg-indigo-900/20 border border-indigo-500/30 rounded-xl p-6 text-center animate-pulse mb-6">
                <!-- Users Icon -->
                <svg class="mx-auto text-indigo-400 mb-2" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                <p class="text-indigo-200">Отправьте код комнаты другу</p>
                <p id="waiting-code" class="text-3xl font-bold mt-2 text-white font-mono tracking-widest"></p>
            </div>

            <!-- Game Board -->
            <div id="game-board" class="aspect-square w-full bg-slate-800 rounded-2xl p-4 grid grid-cols-3 gap-3 shadow-2xl border border-slate-700 hidden">
                <!-- Cells generated by JS -->
            </div>

            <!-- Restart Button -->
            <button id="btn-restart" class="hidden w-full mt-6 bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition-transform active:scale-95 flex items-center justify-center gap-2">
                <!-- Refresh Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>
                Играть снова
            </button>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const defaultFirebaseConfig = {
            apiKey: "AIzaSyAWV097BE56m2YVNi2D494dyXK41j9V5bE",
            authDomain: "messanger-b0b91.firebaseapp.com",
            projectId: "messanger-b0b91",
            storageBucket: "messanger-b0b91.firebasestorage.app",
            messagingSenderId: "895029700922",
            appId: "1:895029700922:web:35b5f3999f2b3641aa4803",
            measurementId: "G-RQ7GYZPT2G"
        };

        const firebaseConfig = typeof window !== 'undefined' && window.__firebase_config 
            ? JSON.parse(window.__firebase_config) 
            : defaultFirebaseConfig;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const APP_ID = typeof window !== 'undefined' && window.__app_id ? window.__app_id : 'tic-tac-toe-universal';

        // --- STATE ---
        let user = null;
        let roomCode = null;
        let gameData = null;
        let unsubscribeGame = null;

        // --- DOM ELEMENTS ---
        const views = {
            loading: document.getElementById('loading-view'),
            menu: document.getElementById('menu-view'),
            game: document.getElementById('game-view'),
            container: document.getElementById('app-container')
        };

        const els = {
            createBtn: document.getElementById('btn-create'),
            joinBtn: document.getElementById('btn-join'),
            joinInput: document.getElementById('input-code'),
            menuError: document.getElementById('menu-error'),
            roomCodeDisplay: document.getElementById('display-room-code'),
            copyBtn: document.getElementById('btn-copy'),
            leaveBtn: document.getElementById('btn-leave'),
            roleBadge: document.getElementById('player-role-badge'),
            statusText: document.getElementById('game-status'),
            waitingScreen: document.getElementById('waiting-screen'),
            waitingCode: document.getElementById('waiting-code'),
            board: document.getElementById('game-board'),
            restartBtn: document.getElementById('btn-restart')
        };

        // --- HELPERS ---
        const generateRoomCode = () => Math.floor(1000 + Math.random() * 9000).toString();
        
        const checkWinner = (board) => {
            const lines = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8],
                [0, 3, 6], [1, 4, 7], [2, 5, 8],
                [0, 4, 8], [2, 4, 6]
            ];
            for (let line of lines) {
                const [a, b, c] = line;
                if (board[a] && board[a] === board[b] && board[a] === board[c]) return board[a];
            }
            return null;
        };
        const checkDraw = (board) => board.every(cell => cell !== null);

        // --- AUTH ---
        const initAuth = async () => {
            try {
                if (typeof window !== 'undefined' && window.__initial_auth_token) {
                    await signInWithCustomToken(auth, window.__initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth error:", err);
                showError("Ошибка авторизации.");
            }
        };

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) {
                views.loading.classList.add('hidden');
                views.container.classList.remove('hidden');
                showMenu();
            }
        });

        initAuth();

        // --- GAME LOGIC ---

        const subscribeToGame = (code) => {
            if (unsubscribeGame) unsubscribeGame();
            const gameRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'games', code);

            unsubscribeGame = onSnapshot(gameRef, (snap) => {
                if (snap.exists()) {
                    gameData = snap.data();
                    renderGame();
                } else {
                    // Game deleted or doesn't exist
                    gameData = null;
                    if (roomCode) leaveGame(); // Force leave if in game
                }
            }, (err) => {
                console.error("Firestore error:", err);
                showError("Ошибка соединения.");
            });
        };

        const createGame = async () => {
            if (!user) return;
            setLoading(true);
            const newCode = generateRoomCode();
            const initialGame = {
                board: Array(9).fill(null),
                xPlayer: user.uid,
                oPlayer: null,
                turn: 'X',
                winner: null,
                createdAt: new Date().toISOString(),
                status: 'waiting'
            };

            try {
                await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'games', newCode), initialGame);
                roomCode = newCode;
                subscribeToGame(roomCode);
                showGame();
            } catch (err) {
                console.error(err);
                showError("Не удалось создать игру.");
            } finally {
                setLoading(false);
            }
        };

        const joinGame = async () => {
            const code = els.joinInput.value.trim();
            if (!user || !code) return;
            setLoading(true);

            try {
                const gameRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'games', code);
                const snap = await getDoc(gameRef);

                if (snap.exists()) {
                    const data = snap.data();
                    
                    if (data.xPlayer === user.uid || data.oPlayer === user.uid) {
                        // Rejoin
                        roomCode = code;
                        subscribeToGame(roomCode);
                        showGame();
                    } else if (!data.oPlayer) {
                        // Join new
                        await updateDoc(gameRef, { oPlayer: user.uid, status: 'playing' });
                        roomCode = code;
                        subscribeToGame(roomCode);
                        showGame();
                    } else {
                        showError("Комната заполнена.");
                    }
                } else {
                    showError("Комната не найдена.");
                }
            } catch (err) {
                console.error(err);
                showError("Ошибка входа.");
            } finally {
                setLoading(false);
            }
        };

        const makeMove = async (index) => {
            if (!gameData || !user) return;
            
            const isX = gameData.xPlayer === user.uid;
            const isO = gameData.oPlayer === user.uid;
            
            if (!isX && !isO) return; 
            if (gameData.winner) return;
            if (gameData.board[index]) return;
            if ((isX && gameData.turn !== 'X') || (isO && gameData.turn !== 'O')) return;

            const newBoard = [...gameData.board];
            newBoard[index] = isX ? 'X' : 'O';
            const winner = checkWinner(newBoard);
            const isDraw = !winner && checkDraw(newBoard);
            const nextTurn = gameData.turn === 'X' ? 'O' : 'X';

            try {
                await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'games', roomCode), {
                    board: newBoard,
                    turn: nextTurn,
                    winner: winner ? winner : (isDraw ? 'draw' : null),
                    status: (winner || isDraw) ? 'finished' : 'playing'
                });
            } catch (err) {
                console.error("Move error", err);
            }
        };

        const resetGame = async () => {
            if (!gameData || !roomCode) return;
            try {
                await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'games', roomCode), {
                    board: Array(9).fill(null),
                    turn: 'X',
                    winner: null,
                    status: 'playing'
                });
            } catch(e) { console.error(e); }
        };

        const leaveGame = () => {
            if (unsubscribeGame) unsubscribeGame();
            roomCode = null;
            gameData = null;
            unsubscribeGame = null;
            els.joinInput.value = '';
            showMenu();
        };

        // --- UI UPDATES ---

        const showMenu = () => {
            views.menu.classList.remove('hidden');
            views.game.classList.add('hidden');
            els.menuError.classList.add('hidden');
        };

        const showGame = () => {
            views.menu.classList.add('hidden');
            views.game.classList.remove('hidden');
            els.roomCodeDisplay.innerText = roomCode;
        };

        const showError = (msg) => {
            els.menuError.innerText = msg;
            els.menuError.classList.remove('hidden');
            setTimeout(() => els.menuError.classList.add('hidden'), 5000);
        };

        const setLoading = (isLoading) => {
            els.createBtn.disabled = isLoading;
            els.joinBtn.disabled = isLoading;
            els.createBtn.innerHTML = isLoading ? 'Загрузка...' : `
                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                 Создать игру
            `;
        };

        const renderGame = () => {
            if (!gameData) return;

            // 1. Role Badge
            let role = 'Зритель';
            let roleClass = 'text-gray-400';
            if (gameData.xPlayer === user.uid) { role = 'X'; roleClass = 'text-cyan-400'; }
            else if (gameData.oPlayer === user.uid) { role = 'O'; roleClass = 'text-purple-400'; }
            
            els.roleBadge.innerHTML = `Вы играете за <span class="font-bold ${roleClass}">${role}</span>`;

            // 2. Status
            let statusHTML = '';
            if (gameData.status === 'waiting') {
                statusHTML = 'Ожидание игрока...';
                els.waitingScreen.classList.remove('hidden');
                els.waitingCode.innerText = roomCode;
                els.board.classList.add('hidden');
                els.restartBtn.classList.add('hidden');
            } else {
                els.waitingScreen.classList.add('hidden');
                els.board.classList.remove('hidden');
                
                if (gameData.winner === 'draw') {
                    statusHTML = '<span class="text-white">Ничья!</span>';
                    els.restartBtn.classList.remove('hidden');
                } else if (gameData.winner) {
                    statusHTML = `<span class="text-yellow-400">Победил ${gameData.winner}!</span>`;
                    els.restartBtn.classList.remove('hidden');
                } else {
                    statusHTML = `<span class="text-white">Ход игрока: ${gameData.turn}</span>`;
                    els.restartBtn.classList.add('hidden');
                }
            }
            els.statusText.innerHTML = statusHTML;

            // 3. Board
            els.board.innerHTML = '';
            gameData.board.forEach((cell, idx) => {
                const btn = document.createElement('button');
                btn.className = `
                    relative rounded-xl flex items-center justify-center transition-all duration-200
                    ${cell ? 'bg-slate-700' : 'bg-slate-750 border-2 border-slate-700 border-dashed'}
                    ${!cell && !gameData.winner && gameData.status === 'playing' ? 'hover:bg-slate-700 cursor-pointer' : ''}
                `;
                
                if (cell === 'X') {
                    btn.innerHTML = `<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-400"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`;
                } else if (cell === 'O') {
                    btn.innerHTML = `<svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-purple-400"><circle cx="12" cy="12" r="10"/></svg>`;
                }
                
                btn.disabled = !!cell || !!gameData.winner || gameData.status !== 'playing';
                btn.onclick = () => makeMove(idx);
                els.board.appendChild(btn);
            });
        };

        // --- EVENT LISTENERS ---
        els.createBtn.onclick = createGame;
        els.joinBtn.onclick = joinGame;
        els.leaveBtn.onclick = leaveGame;
        els.restartBtn.onclick = resetGame;
        
        els.joinInput.oninput = (e) => {
            els.joinBtn.disabled = e.target.value.trim().length === 0;
        };

        els.copyBtn.onclick = () => {
            const textArea = document.createElement("textarea");
            textArea.value = roomCode;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert("Код скопирован: " + roomCode);
        };

    </script>
</body>
</html>
