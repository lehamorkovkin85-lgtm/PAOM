<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RuApp</title>
    <!-- Подключение Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Настройка шрифта Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* Стильный градиентный фон для проявления стекломорфизма */
            background: linear-gradient(135deg, #10b981 0%, #064e3b 100%); 
        }
        /* Добавляем blur для эффекта стекла, работает лучше, чем только Tailwind */
        .glass-blur {
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }
        /* Стилизация полосы прокрутки для лучшего вида */
        #messages-container::-webkit-scrollbar {
            width: 8px;
        }
        #messages-container::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.4); /* Светлый полупрозрачный */
            border-radius: 10px;
        }
    </style>
    <!-- Конфигурация Tailwind для адаптивного дизайна -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // WhatsApp-like цвета
                        'primary': '#075E54', // Темный бирюзовый (Шапка)
                        'secondary': '#25D366', // Яркий зеленый (Акцент/Сообщения)
                        'light-secondary': '#DCF8C6' // Светло-зеленый (Фон своих сообщений)
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Главный контейнер мессенджера со стекломорфизмом -->
    <div class="glass-blur bg-white/10 shadow-2xl rounded-3xl w-full max-w-5xl flex flex-col h-[90vh] ring-1 ring-white/30">
        
        <!-- Шапка -->
        <header class="p-4 bg-primary text-white rounded-t-3xl shadow-xl flex justify-between items-center">
            <h1 class="text-xl font-bold">RuApp</h1>
            <div class="flex items-center space-x-4">
                <div id="user-info" class="text-sm bg-secondary px-3 py-1 rounded-full truncate max-w-[50%] sm:max-w-none shadow-md">
                    <span id="username-display">Загрузка...</span>
                </div>
                <button id="logout-button" class="text-xs text-white/70 hover:text-white transition duration-150">Выйти</button>
            </div>
        </header>

        <!-- Основная область: Боковая панель + Чат -->
        <div class="flex flex-row flex-grow overflow-hidden">
            
            <!-- Левая панель (Список чатов) -->
            <div id="chat-sidebar" class="w-full sm:w-1/3 max-w-xs border-r border-white/20 bg-white/10 glass-blur flex-shrink-0 overflow-y-auto">
                <div class="p-3 text-lg font-semibold text-white/90 border-b border-white/20">Чаты</div>
                
                <!-- Элемент чата -->
                <div id="general-chat-item" class="p-3 flex items-center space-x-3 cursor-pointer bg-white/20 border-l-4 border-secondary transition duration-150">
                    <div class="w-10 h-10 bg-secondary rounded-full flex items-center justify-center text-white font-bold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 2a8 8 0 100 16 8 8 0 000-16zM4.053 13.91l4.004-4.004a.75.75 0 000-1.06l-4.004-4.004a.75.75 0 00-1.06 1.06L7.94 10l-4.947 4.947a.75.75 0 001.06 1.06z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div>
                        <div class="font-bold text-white">Общий чат</div>
                        <div class="text-xs text-white/70 truncate">Сообщения всех пользователей</div>
                    </div>
                </div>
                <!-- Здесь будут добавляться другие чаты -->
            </div>

            <!-- Правая панель (Область сообщений) -->
            <div id="chat-main" class="flex flex-col flex-grow">
                 <!-- Контейнер для сообщений -->
                <div id="messages-container" class="flex-grow overflow-y-auto p-4 space-y-4">
                    <!-- Сообщения будут добавляться сюда JS -->
                    <div id="loading-spinner" class="text-center p-8">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-secondary mx-auto"></div>
                        <p class="mt-2 text-white/70">Подключение к RuApp...</p>
                    </div>
                </div>

                <!-- Форма для отправки сообщений -->
                <div class="p-4 bg-white/10 glass-blur border-t border-white/20">
                    <form id="message-form" class="flex space-x-3">
                        <input
                            type="text"
                            id="message-input"
                            placeholder="Введите ваше сообщение..."
                            required
                            autocomplete="off"
                            class="flex-grow p-3 bg-white/50 border border-white/50 rounded-full text-gray-800 placeholder-gray-600 focus:ring-secondary focus:border-secondary transition duration-150 shadow-inner"
                        >
                        <button
                            type="submit"
                            id="send-button"
                            class="bg-secondary text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-green-600 transition duration-150 disabled:bg-gray-400"
                            disabled
                        >
                            Отправить
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно Аутентификации (Registration/Login) -->
    <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="glass-blur bg-white/10 p-8 rounded-3xl shadow-2xl max-w-sm w-full ring-1 ring-white/30 text-white">
            <h2 id="auth-title" class="text-3xl font-bold mb-6 text-center text-secondary">Вход / Регистрация</h2>
            
            <form id="auth-form" class="space-y-4">
                <input
                    type="text"
                    id="auth-username"
                    placeholder="Ваше имя пользователя"
                    required
                    autocomplete="username"
                    class="w-full p-3 bg-white/50 border border-white/50 rounded-lg text-gray-800 placeholder-gray-600 focus:ring-secondary focus:border-secondary transition duration-150 shadow-inner"
                >
                <input
                    type="email"
                    id="auth-email"
                    placeholder="Email"
                    required
                    autocomplete="email"
                    class="w-full p-3 bg-white/50 border border-white/50 rounded-lg text-gray-800 placeholder-gray-600 focus:ring-secondary focus:border-secondary transition duration-150 shadow-inner"
                >
                <input
                    type="password"
                    id="auth-password"
                    placeholder="Пароль"
                    required
                    autocomplete="current-password"
                    class="w-full p-3 bg-white/50 border border-white/50 rounded-lg text-gray-800 placeholder-gray-600 focus:ring-secondary focus:border-secondary transition duration-150 shadow-inner"
                >
                
                <p id="auth-error-message" class="text-sm text-red-400 font-medium"></p>

                <button
                    type="submit"
                    id="auth-submit-button"
                    class="w-full bg-secondary text-white font-bold py-3 rounded-lg shadow-xl hover:bg-green-600 transition duration-150"
                >
                    Зарегистрироваться
                </button>
            </form>
            
            <button
                id="toggle-auth-mode"
                class="w-full mt-4 text-sm text-white/70 hover:text-white transition duration-150"
            >
                Уже есть аккаунт? Войти
            </button>
        </div>
    </div>

    <!-- Модальное окно для ошибок (заменяет alert()) -->
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-xl max-w-sm w-full">
            <h3 class="text-lg font-bold text-red-600 mb-4">Ошибка</h3>
            <p id="error-message" class="text-gray-700"></p>
            <button onclick="document.getElementById('error-modal').classList.add('hidden'); document.getElementById('error-modal').classList.remove('flex');" class="mt-4 w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700">Закрыть</button>
        </div>
    </div>

    <!-- Подключение Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, orderBy, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Глобальные переменные Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let configFromCanvas = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

        // === ВАЖНО: ЗНАЧЕНИЯ КОНФИГУРАЦИИ FIREBASE (ПРЕДОСТАВЛЕНЫ ПОЛЬЗОВАТЕЛЕМ) ===
        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAWV097BE56m2YVNi2D494dyXK41j9V5bE", 
            authDomain: "messanger-b0b91.firebaseapp.com",
            projectId: "messanger-b0b91",
            storageBucket: "messanger-b0b91.firebasestorage.app",
            messagingSenderId: "895029700922",
            appId: "1:895029700922:web:184790c791e66978aa4803"
            // measurementId: "G-8YMP1TY2HW" -- Удалено, не требуется для базовой работы
        };
        // ===========================================================================================

        // Используем конфигурацию Canvas, если она предоставлена, иначе используем ручную.
        const effectiveConfig = Object.keys(configFromCanvas).length > 0 ? configFromCanvas : MANUAL_FIREBASE_CONFIG;
        
        let db;
        let auth;
        let currentUserId = null;
        let currentUsername = 'Гость';
        let isReady = false;

        // Элементы DOM
        const messagesContainer = document.getElementById('messages-container');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const usernameDisplay = document.getElementById('username-display');
        const loadingSpinner = document.getElementById('loading-spinner');
        const logoutButton = document.getElementById('logout-button');
        
        // Элементы Аутентификации
        const authModal = document.getElementById('auth-modal');
        const authForm = document.getElementById('auth-form');
        const authTitle = document.getElementById('auth-title');
        const authUsernameInput = document.getElementById('auth-username');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authSubmitButton = document.getElementById('auth-submit-button');
        const toggleAuthModeButton = document.getElementById('toggle-auth-mode');
        const authErrorMessage = document.getElementById('auth-error-message');
        
        let isRegisterMode = true;

        // Установка уровня логирования для отладки Firestore
        setLogLevel('debug');

        // --- Утилиты UI ---

        /**
         * Показывает кастомное модальное окно с сообщением об ошибке.
         * @param {string} message Сообщение об ошибке.
         */
        function showError(message) {
            console.error(message);
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-modal').classList.remove('hidden');
            document.getElementById('error-modal').classList.add('flex');
        }
        
        /**
         * Обновляет UI после входа пользователя.
         * @param {Object} user Объект пользователя Firebase.
         */
        function updateUI(user) {
            currentUserId = user.uid;
            currentUsername = user.displayName || 'Пользователь';
            usernameDisplay.textContent = currentUsername;
            isReady = true;
            sendButton.disabled = false;
            loadingSpinner.classList.add('hidden');
            hideAuthModal();
            setupMessageListener();
        }

        function showAuthModal() {
            authModal.classList.remove('hidden');
            authModal.classList.add('flex');
            messagesContainer.innerHTML = ''; // Очистка чата при выходе
            loadingSpinner.classList.remove('hidden');
            loadingSpinner.innerHTML = '<p class="mt-2 text-white/70">Пожалуйста, войдите или зарегистрируйтесь.</p>';
        }

        function hideAuthModal() {
            authModal.classList.add('hidden');
            authModal.classList.remove('flex');
            authErrorMessage.textContent = '';
        }

        // --- Логика Аутентификации ---

        /**
         * Обработчик переключения режима (Вход/Регистрация).
         */
        toggleAuthModeButton.addEventListener('click', () => {
            isRegisterMode = !isRegisterMode;
            if (isRegisterMode) {
                authTitle.textContent = 'Регистрация';
                authSubmitButton.textContent = 'Зарегистрироваться';
                toggleAuthModeButton.textContent = 'Уже есть аккаунт? Войти';
                authUsernameInput.classList.remove('hidden');
            } else {
                authTitle.textContent = 'Вход';
                authSubmitButton.textContent = 'Войти';
                toggleAuthModeButton.textContent = 'Нет аккаунта? Зарегистрироваться';
                authUsernameInput.classList.add('hidden');
            }
            authErrorMessage.textContent = '';
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            const username = authUsernameInput.value;

            authSubmitButton.disabled = true;
            authErrorMessage.textContent = '';

            try {
                if (isRegisterMode) {
                    if (!username) {
                        authErrorMessage.textContent = 'Пожалуйста, введите имя пользователя.';
                        return;
                    }
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await updateProfile(userCredential.user, { displayName: username });
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                let msg = 'Произошла ошибка аутентификации.';
                if (error.code === 'auth/email-already-in-use') msg = 'Этот email уже зарегистрирован.';
                else if (error.code === 'auth/invalid-email') msg = 'Некорректный формат email.';
                else if (error.code === 'auth/weak-password') msg = 'Пароль должен быть не менее 6 символов.';
                else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') msg = 'Неверный email или пароль.';
                
                authErrorMessage.textContent = msg;
                console.error("Auth Error:", error);
            } finally {
                authSubmitButton.disabled = false;
            }
        });

        // Обработчик кнопки выхода
        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                showError("Ошибка при выходе: " + error.message);
            }
        });


        // --- Инициализация и Слушатель Состояний ---

        async function initializeFirebase() {
            try {
                // В этом случае, так как мы вставили данные, проверка на "YOUR_API_KEY" не сработает,
                // и приложение попытается инициализироваться с вашими ключами.
                
                // Если конфигурация все еще пуста (например, при запуске в оригинальной среде без Canvas config),
                // используем ручную проверку. 
                if (!effectiveConfig.apiKey || effectiveConfig.apiKey.includes('YOUR_API_KEY')) {
                     throw new Error("Конфигурация Firebase не найдена или не заполнена.");
                }

                const app = initializeApp(effectiveConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Слушатель состояния аутентификации
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        updateUI(user);
                    } else {
                        isReady = false;
                        sendButton.disabled = true;
                        usernameDisplay.textContent = 'Вы не вошли';
                        showAuthModal();
                    }
                });
            } catch (error) {
                // Обрабатываем как ошибку конфигурации, так и ошибки инициализации Firebase
                showError(`Ошибка инициализации Firebase: ${error.message}`);
                loadingSpinner.innerHTML = '<p class="text-red-600">Не удалось подключиться к Firebase.</p>';
            }
        }

        // --- Логика Чата ---

        /**
         * Отображает одно сообщение в контейнере чата.
         * @param {Object} message Объект сообщения.
         */
        function displayMessage(message) {
            const isSelf = message.userId === currentUserId;
            const messageElement = document.createElement('div');
            messageElement.classList.add('flex', isSelf ? 'justify-end' : 'justify-start');

            // --- Стили стекломорфизма для пузырей сообщений ---
            const bubbleClasses = isSelf
                ? 'bg-light-secondary text-gray-900 ml-auto rounded-tl-xl rounded-bl-xl rounded-br-xl shadow-md' // Свои сообщения: светло-зеленый (имитация WhatsApp)
                : 'bg-white/30 text-white glass-blur mr-auto rounded-tr-xl rounded-br-xl rounded-bl-xl ring-1 ring-white/40 shadow-xl'; // Чужие сообщения: стеклянный эффект
            
            // Форматирование времени
            const date = message.createdAt?.toDate ? message.createdAt.toDate() : new Date();
            const timeString = date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            
            // Сокращаем UID для отображения, если имя пользователя отсутствует
            const senderName = message.username || `${message.userId.substring(0, 4)}...`;

            messageElement.innerHTML = `
                <div class="max-w-xs sm:max-w-md lg:max-w-lg p-3 ${bubbleClasses}">
                    <div class="text-xs font-semibold mb-1 ${isSelf ? 'text-primary' : 'text-secondary'}">
                        ${isSelf ? 'Вы' : senderName}
                    </div>
                    <p class="break-words">${message.text}</p>
                    <div class="text-right text-xs mt-1 ${isSelf ? 'text-gray-600' : 'text-white/80'}">
                        ${timeString}
                    </div>
                </div>
            `;
            messagesContainer.appendChild(messageElement);
        }

        /**
         * Настраивает слушатель Firestore для получения сообщений в реальном времени.
         */
        function setupMessageListener() {
            if (!isReady || !currentUserId) return;

            // Путь к коллекции: /artifacts/{appId}/public/data/messages
            const messagesCollectionPath = `/artifacts/${appId}/public/data/messages`;
            const messagesRef = collection(db, messagesCollectionPath);

            // Запрос: все сообщения, отсортированные по времени создания (createdAt)
            // ВАЖНО: При использовании orderBy('createdAt', 'asc') может потребоваться индекс Firestore. 
            // Мы оставляем его для корректной работы, но помним о потенциальной ошибке индекса.
            const q = query(messagesRef, orderBy('createdAt', 'asc'));

            // Слушатель в реальном времени
            onSnapshot(q, (snapshot) => {
                // Очистка контейнера при первой загрузке
                messagesContainer.innerHTML = '';
                
                let hasNewMessages = false;
                
                snapshot.docs.forEach(doc => {
                    const message = doc.data();
                    if (message.createdAt) {
                        displayMessage({
                            id: doc.id,
                            userId: message.userId,
                            username: message.username, // Теперь используем имя
                            text: message.text,
                            createdAt: message.createdAt
                        });
                        hasNewMessages = true;
                    }
                });

                // Прокрутка вниз к последнему сообщению
                if (hasNewMessages) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }, (error) => {
                showError(`Ошибка при получении сообщений в реальном времени: ${error.message}`);
            });
        }

        /**
         * Отправляет новое сообщение в Firestore.
         * @param {Event} e Событие отправки формы.
         */
        async function sendMessage(e) {
            e.preventDefault();
            if (!isReady) return;

            const text = messageInput.value.trim();
            if (!text) return;

            sendButton.disabled = true;

            try {
                const messagesCollectionPath = `/artifacts/${appId}/public/data/messages`;
                const messagesRef = collection(db, messagesCollectionPath);

                await addDoc(messagesRef, {
                    userId: currentUserId,
                    username: currentUsername, // Отправляем имя пользователя
                    text: text,
                    createdAt: serverTimestamp(), // Firestore добавит временную метку на сервере
                });

                messageInput.value = ''; // Очистка поля ввода

            } catch (error) {
                showError(`Ошибка при отправке сообщения: ${error.message}`);
            } finally {
                sendButton.disabled = false;
                messageInput.focus();
            }
        }

        // Навешивание обработчика событий на форму
        messageForm.addEventListener('submit', sendMessage);

        // Запуск инициализации при загрузке страницы
        window.addEventListener('load', initializeFirebase);
    </script>
</body>
</html>
