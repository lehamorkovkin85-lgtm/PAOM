<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paom.Study - –£—á–µ–±–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à—Ä–∏—Ñ—Ç–∞ Inter –∏ –∑–µ–ª–µ–Ω–æ–π —Ü–≤–µ—Ç–æ–≤–æ–π –ø–∞–ª–∏—Ç—Ä—ã -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root {
            --color-primary: #34D399; /* Emerald 400 */
            --color-secondary: #059669; /* Emerald 600 */
            --color-dark: #064E3B; /* Emerald 900 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4; /* Lightest green background */
        }
        .app-bg {
            background-color: #f0fdf4;
        }
        .btn-primary {
            background-color: var(--color-primary);
            color: var(--color-dark);
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: var(--color-secondary);
            color: white;
        }
        .nav-item {
            color: var(--color-dark);
            transition: background-color 0.2s, color 0.2s;
        }
        .nav-item.active {
            background-color: var(--color-secondary);
            color: white;
            font-weight: 600;
        }
        .nav-item:not(.active):hover {
            background-color: #A7F3D0; /* Emerald 200 */
        }
        .league-card {
            background-color: #D1FAE5; /* Emerald 100 */
            border-left: 5px solid var(--color-primary);
        }
    </style>
</head>
<body class="min-h-screen">

<div id="app" class="flex flex-col md:flex-row min-h-screen">
    <!-- –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
    <nav id="sidebar" class="w-full md:w-56 bg-white shadow-xl flex flex-col p-4 md:p-0">
        <div class="text-xl font-bold text-center py-4 text-emerald-900 border-b border-emerald-100">paom.study</div>
        <div id="nav-list" class="flex md:flex-col flex-wrap justify-center md:space-y-1 space-x-2 md:space-x-0 p-2 overflow-x-auto md:overflow-x-hidden">
            <!-- –≠–ª–µ–º–µ–Ω—Ç—ã –º–µ–Ω—é –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã JS -->
        </div>

        <div class="mt-auto p-4 border-t border-emerald-100">
            <div class="flex items-center justify-center text-lg font-semibold text-emerald-800">
                <span id="diamond-count" class="mr-2">0</span>
                <!-- –ò–∫–æ–Ω–∫–∞ –∞–ª–º–∞–∑–∞ -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#064E3B" class="w-5 h-5">
                    <path fill-rule="evenodd" d="M11.667 2.158c.175-.175.46-.175.635 0L22.585 13.11c.175.175.175.46 0 .635l-3.218 3.218c-.175.175-.46.175-.635 0L12 6.077 5.267 16.963c-.175.175-.46.175 0-.635L11.667 2.158Z" clip-rule="evenodd" />
                    <path d="M11.833 21.842c-.175.175-.46.175-.635 0L1.415 10.89c-.175-.175-.175-.46 0-.635l3.218-3.218c.175-.175.46-.175.635 0L12 17.923l6.733-10.886c.175-.175.46-.175.635 0l3.218 3.218c.175.175.46 0 .635L11.833 21.842Z" />
                </svg>
            </div>
        </div>
    </nav>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ -->
    <main id="content" class="flex-grow p-4 md:p-8 app-bg">
        <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–æ –∑–¥–µ—Å—å -->
    </main>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π/–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π -->
<div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
    <div id="custom-modal" class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transition-all duration-300">
        <h3 id="modal-title" class="text-xl font-bold mb-4 text-emerald-900">–°–æ–æ–±—â–µ–Ω–∏–µ</h3>
        <p id="modal-message" class="mb-6 text-gray-700"></p>
        <div class="flex justify-end space-x-3">
            <button id="modal-cancel-btn" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition duration-150 hidden">–û—Ç–º–µ–Ω–∞</button>
            <button id="modal-confirm-btn" class="px-4 py-2 rounded-lg btn-primary hover:bg-emerald-600 hover:text-white transition duration-150">–û–ö</button>
        </div>
    </div>
</div>

<script>
    // ===============================================
    // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –°–¢–ê–¢–ò–ß–ï–°–ö–ò–ï –î–ê–ù–ù–´–ï
    // ===============================================

    const CONFIG = {
        XP_PER_CORRECT: 10,
        DIAMONDS_PER_LESSON: 3,
        BOT_COUNT: 20,
        LESSONS_PER_COURSE: 20,
        QUESTIONS_PER_LESSON: 12,
        XP_MULTIPLIER_SHOP: 2,
        DIAMOND_SHOP_PRICE: 50,
        MAX_LEVEL: 10,
        LEAGUES: [
            { name: "–ë—Ä–æ–Ω–∑–æ–≤–∞—è", minPoints: 0, requiredPoints: 100 },
            { name: "–°–µ—Ä–µ–±—Ä—è–Ω–∞—è", minPoints: 100, requiredPoints: 300 },
            { name: "–ó–æ–ª–æ—Ç–∞—è", minPoints: 300, requiredPoints: 600 },
            { name: "–ü–ª–∞—Ç–∏–Ω–æ–≤–∞—è", minPoints: 600, requiredPoints: 1000 },
            { name: "–ê–ª–º–∞–∑–Ω–∞—è", minPoints: 1000, requiredPoints: 1500 },
            { name: "–ú–∞—Å—Ç–µ—Ä", minPoints: 1500, requiredPoints: 2200 },
            { name: "–ì—Ä–∞–Ω–¥–º–∞—Å—Ç–µ—Ä", minPoints: 2200, requiredPoints: 3000 },
            { name: "–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è", minPoints: 3000, requiredPoints: Infinity },
        ]
    };

    const COURSES = {
        english: { name: "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫ üá¨üáß", color: "blue" },
        chess: { name: "–®–∞—Ö–º–∞—Ç—ã ‚ôüÔ∏è", color: "gray" },
        geography: { name: "–ì–µ–æ–≥—Ä–∞—Ñ–∏—è üó∫Ô∏è", color: "orange" },
        math: { name: "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ üßÆ", color: "red" },
        music: { name: "–ú—É–∑—ã–∫–∞ üé∂", color: "yellow" },
    };

    const CHARACTERS = [
        { name: "–ü—Ä–æ—Ñ–µ—Å—Å–æ—Ä –≠—Ä—É–¥–∏—Ç", bio: "–û–ø—ã—Ç–Ω—ã–π –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫, –∑–Ω–∞—é—â–∏–π –≤—Å–µ.", avatar: "üë®‚Äçüè´" },
        { name: "–ê–ª–∏—Å–∞", bio: "–≠–Ω–µ—Ä–≥–∏—á–Ω–∞—è –ø–æ–º–æ—â–Ω–∏—Ü–∞.", avatar: "üëß" },
        { name: "–†–æ–±–æ—Ç –£—á–∏—Ç–µ–ª—å", bio: "–í—Å–µ–≥–¥–∞ —Ç–æ—á–µ–Ω –∏ –±–µ—Å–ø—Ä–∏—Å—Ç—Ä–∞—Å—Ç–µ–Ω.", avatar: "ü§ñ" },
        { name: "–ú–∞–≥–∏—Å—Ç—Ä –ú—É–∑—ã–∫–∏", bio: "–ì—É—Ä—É –≥–∞—Ä–º–æ–Ω–∏–∏ –∏ —Ä–∏—Ç–º–∞.", avatar: "üßë‚Äçüé§" },
    ];

    const AVATAR_OPTIONS = [
        { id: 1, icon: "üöÄ", price: 0 }, { id: 2, icon: "üí°", price: 0 },
        { id: 3, icon: "ü¶â", price: 100 }, { id: 4, icon: "üëë", price: 200 },
        { id: 5, icon: "ü¶ä", price: 300 }, { id: 6, icon: "ü¶Ñ", price: 400 },
    ];

    const SHOP_ITEMS = [
        { id: 'xp2_1', name: '–£—Å–∫–æ—Ä–∏—Ç–µ–ª—å XP x2 (1 —É—Ä.)', price: 50, type: 'xp', multiplier: 2, lessons: 1 },
        { id: 'xp2_3', name: '–£—Å–∫–æ—Ä–∏—Ç–µ–ª—å XP x2 (3 —É—Ä.)', price: 120, type: 'xp', multiplier: 2, lessons: 3 },
        { id: 'xp3_1', name: '–£—Å–∫–æ—Ä–∏—Ç–µ–ª—å XP x3 (1 —É—Ä.)', price: 100, type: 'xp', multiplier: 3, lessons: 1 },
    ];
    
    // ===============================================
    // –°–û–°–¢–û–Ø–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø –ò –£–ü–†–ê–í–õ–ï–ù–ò–ï –•–†–ê–ù–ò–õ–ò–©–ï–ú
    // ===============================================

    let appState = {};
    let currentView = 'courses';
    let currentQuiz = null;

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID (–¥–ª—è –±–æ—Ç–æ–≤ –∏ –¥—Ä—É–∑–µ–π).
     * @returns {string} –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
     */
    function generateId() {
        return Math.random().toString(36).substring(2, 9);
    }

    /**
     * –í—ã—á–∏—Å–ª—è–µ—Ç —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ XP.
     * @param {number} xp –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ XP.
     * @returns {{level: number, xpToNext: number, xpInCurrent: number, totalXpForLevel: number}}
     */
    function calculateLevel(xp) {
        let level = 1;
        let totalXpForLevel = 0;

        for (let l = 1; l <= CONFIG.MAX_LEVEL; l++) {
            const required = l * 1000;
            if (xp < required) {
                level = l;
                const xpInCurrent = xp - totalXpForLevel;
                const xpToNext = required - xpInCurrent;
                return { level, xpToNext, xpInCurrent, totalXpForLevel: required };
            }
            totalXpForLevel = required;
        }
        return { level: CONFIG.MAX_LEVEL, xpToNext: 0, xpInCurrent: xp, totalXpForLevel: totalXpForLevel };
    }

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â—É—é –ª–∏–≥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
     * @param {number} points –û—á–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
     * @returns {{index: number, name: string, requiredPoints: number, pointsInCurrent: number}|null}
     */
    function getLeagueInfo(points) {
        let currentLeague = CONFIG.LEAGUES[0];
        let index = 0;
        
        for (let i = 0; i < CONFIG.LEAGUES.length; i++) {
            if (points >= CONFIG.LEAGUES[i].minPoints) {
                currentLeague = CONFIG.LEAGUES[i];
                index = i;
            }
        }

        const requiredPoints = currentLeague.requiredPoints;
        const pointsInCurrent = points - currentLeague.minPoints;

        return { index, name: currentLeague.name, requiredPoints, pointsInCurrent, minPoints: currentLeague.minPoints };
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
     */
    function initializeState() {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–±—Ä–æ—Å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –ª–∏–º–∏—Ç–æ–≤ (—Å—É–Ω–¥—É–∫–∏, –±–æ—Ç—ã)
        const today = new Date().toDateString();
        const lastLogin = localStorage.getItem('lastLoginDate');

        if (lastLogin !== today) {
            // –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Å–±—Ä–æ—Å
            localStorage.setItem('lastLoginDate', today);
            
            // –°–±—Ä–æ—Å –æ—Ç–∫—Ä—ã—Ç–∏—è —Å—É–Ω–¥—É–∫–æ–≤
            if (appState.chests) {
                appState.chests.todayOpened = false;
                console.log("–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Å–±—Ä–æ—Å —Å—É–Ω–¥—É–∫–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω.");
            }
        }
        
        const defaultState = {
            user: {
                id: generateId(),
                nickname: "–ù–æ–≤—ã–π –£—á–µ–Ω–∏–∫",
                avatarId: 1,
                diamonds: 50,
                leaguePoints: 0, // –û—á–∫–∏ –¥–ª—è –ª–∏–≥–∏
                totalXP: 0, // –û–±—â–µ–µ XP –¥–ª—è —É—Ä–æ–≤–Ω—è
                xpMultiplierLessonsLeft: 0,
                xpMultiplierValue: 1,
                completedLessons: {}, // { courseId: [lessonId, ...] }
                ownedAvatars: [1, 2], // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –≤–ª–∞–¥–µ–µ—Ç –ø–µ—Ä–≤—ã–º–∏ –¥–≤—É–º—è
            },
            leaderboard: {
                bots: generateBots(CONFIG.BOT_COUNT),
            },
            chests: {
                lastChestOpenDate: null,
                todayOpened: false, // –û—Ç–∫—Ä—ã—Ç –ª–∏ —Å–µ–≥–æ–¥–Ω—è —Ö–æ—Ç—å –æ–¥–∏–Ω —Å—É–Ω–¥—É–∫
            },
            friends: [], // –°–ø–∏—Å–æ–∫ ID –±–æ—Ç–æ–≤-–¥—Ä—É–∑–µ–π
            lastLoginDate: today,
            lastBotUpdateDate: null,
            questionsCache: {}, // –ö–≠–®: –î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤ —É—Ä–æ–∫–æ–≤
        };

        const loadedState = localStorage.getItem('paomStudyState');
        appState = loadedState ? JSON.parse(loadedState) : defaultState;
        
        // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, ownedAvatars –∏ questionsCache)
        Object.assign(appState, defaultState, appState);
        Object.assign(appState.user, defaultState.user, appState.user);
        
        // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –±–æ—Ç—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∏ –¥–≤–∏–≥–∞—é—Ç—Å—è
        updateBotsProgress();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ–±—ã —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±—ã–ª–∏ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è
        Object.assign(appState.user, defaultState.user, appState.user);
        
        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ª–∏–≥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        checkLeaguePromotion(appState.user.leaguePoints);
    }

    /**
     * –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ localStorage.
     */
    function saveState() {
        localStorage.setItem('paomStudyState', JSON.stringify(appState));
        updateDiamondDisplay(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∞–ª–º–∞–∑–æ–≤ –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
        renderView(currentView);
    }
    
    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –∞–ª–º–∞–∑–æ–≤ –≤ –º–µ–Ω—é.
     */
    function updateDiamondDisplay() {
        const diamondCountElement = document.getElementById('diamond-count');
        if (diamondCountElement) {
            diamondCountElement.textContent = appState.user.diamonds;
        }
    }

    // ===============================================
    // –õ–û–ì–ò–ö–ê –ë–û–¢–û–í –ò –õ–ò–î–ï–†–ë–û–†–î–ê
    // ===============================================

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ –±–æ—Ç–æ–≤.
     * @param {number} count –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–æ—Ç–æ–≤.
     * @returns {Array<object>} –°–ø–∏—Å–æ–∫ –±–æ—Ç–æ–≤.
     */
    function generateBots(count) {
        const bots = [];
        const botNames = ["–ê–¥–∞–º", "–ï–≤–∞", "–ò–ª–æ–Ω", "–ê–π—Ä–∏—Å", "–ù—å—é—Ç–æ–Ω", "–ì–∞–ª–∏–ª–µ–æ", "–ö—é—Ä–∏", "–¢–µ—Å–ª–∞", "–ê—Ä–∏—Å—Ç–æ—Ç–µ–ª—å", "–ü–ª–∞—Ç–æ–Ω"];

        for (let i = 0; i < count; i++) {
            const nickname = `${botNames[i % botNames.length]} B${i+1}`;
            
            let leagueIndex;
            if (i < count / 2) {
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–º–µ—â–∞–µ–º –ø–µ—Ä–≤—É—é –ø–æ–ª–æ–≤–∏–Ω—É –±–æ—Ç–æ–≤ –≤ –ë—Ä–æ–Ω–∑–æ–≤—É—é –õ–∏–≥—É (–∏–Ω–¥–µ–∫—Å 0) –¥–ª—è –Ω–∞—á–∞–ª—å–Ω–æ–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏
                leagueIndex = 0; 
            } else {
                // –°–ª—É—á–∞–π–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –±–æ—Ç–æ–≤ –ø–æ –≤—Å–µ–º –ª–∏–≥–∞–º
                leagueIndex = Math.floor(Math.random() * CONFIG.LEAGUES.length);
            }

            const min = CONFIG.LEAGUES[leagueIndex].minPoints;
            const max = CONFIG.LEAGUES[leagueIndex].requiredPoints;
            
            // –ï—Å–ª–∏ —ç—Ç–æ –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è –ª–∏–≥–∞ (Infinity), –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –±–æ–ª—å—à–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω
            const pointRange = isFinite(max) ? (max - min) : 1000;
            const initialPoints = Math.floor(Math.random() * pointRange) + min;

            bots.push({
                id: `bot_${i}`,
                nickname: nickname,
                avatarId: Math.floor(Math.random() * AVATAR_OPTIONS.length) + 1,
                leaguePoints: initialPoints,
                leagueIndex: leagueIndex,
            });
        }
        return bots;
    }

    /**
     * –ü—Ä–æ–¥–≤–∏–≥–∞–µ—Ç/–¥–µ–≥—Ä–∞–¥–∏—Ä—É–µ—Ç –±–æ—Ç–æ–≤ —Å–ª—É—á–∞–π–Ω—ã–º –æ–±—Ä–∞–∑–æ–º.
     */
    function updateBotsProgress() {
        const today = new Date().toDateString();
        // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π —Ä–∞–∑ —Å–µ–≥–æ–¥–Ω—è
        if (appState.lastBotUpdateDate === today) return; 

        appState.leaderboard.bots.forEach(bot => {
            // –ë–æ—Ç—ã –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –æ—Ç 50 –¥–æ 200 –æ—á–∫–æ–≤ –≤ –¥–µ–Ω—å
            const pointsGained = Math.floor(Math.random() * 150) + 50;
            bot.leaguePoints += pointsGained;

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é –ª–∏–≥—É –±–æ—Ç–∞
            let botLeagueInfo = getLeagueInfo(bot.leaguePoints);
            bot.leagueIndex = botLeagueInfo.index;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–≤—ã—à–µ–Ω–∏–µ/–ø–æ–Ω–∏–∂–µ–Ω–∏–µ (–¥–ª—è —Ä–µ–∞–ª–∏–∑–º–∞, –±–æ—Ç—ã –º–æ–≥—É—Ç –ø–µ—Ä–µ–π—Ç–∏ –≤ –¥—Ä—É–≥—É—é –ª–∏–≥—É)
            // –ü–æ–≤—ã—à–µ–Ω–∏–µ
            if (botLeagueInfo.index < CONFIG.LEAGUES.length - 1 && bot.leaguePoints >= botLeagueInfo.requiredPoints) {
                bot.leagueIndex++;
                bot.leaguePoints = CONFIG.LEAGUES[bot.leagueIndex].minPoints;
            } 
            // –ü–æ–Ω–∏–∂–µ–Ω–∏–µ (—Å–ª—É—á–∞–π–Ω–æ–µ)
            else if (botLeagueInfo.index > 0 && Math.random() < 0.05 && bot.leaguePoints < botLeagueInfo.minPoints) {
                bot.leagueIndex--;
                bot.leaguePoints = CONFIG.LEAGUES[bot.leagueIndex].minPoints;
            }
        });
        
        appState.lastBotUpdateDate = today;
        saveState();
    }
    
    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–≤—ã—à–µ–Ω–∏–µ –ª–∏–≥–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
     * @param {number} newPoints –ù–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—á–∫–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
     */
    function checkLeaguePromotion(newPoints) {
        const oldLeagueInfo = getLeagueInfo(appState.user.leaguePoints);
        const newLeagueInfo = getLeagueInfo(newPoints);
        
        appState.user.leaguePoints = newPoints;
        
        if (newLeagueInfo.index > oldLeagueInfo.index) {
            // –ü–æ–≤—ã—à–µ–Ω–∏–µ
            // –û—á–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –¥–æ –º–∏–Ω–∏–º—É–º–∞ –Ω–æ–≤–æ–π –ª–∏–≥–∏
            appState.user.leaguePoints = newLeagueInfo.minPoints; 
            
            showModal('–ü–æ–≤—ã—à–µ–Ω–∏–µ –ª–∏–≥–∏!', 
                      `–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –ø–µ—Ä–µ—à–ª–∏ –≤ –ª–∏–≥—É "${newLeagueInfo.name}"! –í–∞—à–∏ –æ—á–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã –¥–æ ${newLeagueInfo.minPoints}.`,
                      null, '–û—Ç–ª–∏—á–Ω–æ!');
        }
        saveState();
    }
    
    // ===============================================
    // –ì–ï–ù–ï–†–ê–¶–ò–Ø –£–†–û–ö–û–í (–û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢)
    // ===============================================

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–¥–∏–Ω —Å–ª—É—á–∞–π–Ω—ã–π –≤–æ–ø—Ä–æ—Å –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –∫—É—Ä—Å–∞.
     * (–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
     * @param {string} courseId ID –∫—É—Ä—Å–∞.
     * @returns {object} –û–±—ä–µ–∫—Ç –≤–æ–ø—Ä–æ—Å–∞.
     */
    function _generateRandomQuestion(courseId) {
        let question = { type: 'mcq', text: '', options: [], correct: '' };

        switch (courseId) {
            case 'english':
                const vocab = [
                    { en: "Book", ru: "–ö–Ω–∏–≥–∞" }, { en: "Table", ru: "–°—Ç–æ–ª" }, 
                    { en: "Run", ru: "–ë–µ–≥–∞—Ç—å" }, { en: "Fast", ru: "–ë—ã—Å—Ç—Ä—ã–π" },
                    { en: "Computer", ru: "–ö–æ–º–ø—å—é—Ç–µ—Ä" }, { en: "Smile", ru: "–£–ª—ã–±–∫–∞" },
                ];
                
                // 50% - MCQ (–ü–µ—Ä–µ–≤–æ–¥), 50% - Input (–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ)
                if (Math.random() < 0.5) {
                    // Type 1: Translation RU -> EN (MCQ)
                    const item = vocab[Math.floor(Math.random() * vocab.length)];
                    question.type = 'mcq';
                    question.text = `–ö–∞–∫ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è —Å–ª–æ–≤–æ "${item.ru}"?`;
                    question.correct = item.en;
                    
                    question.options = [item.en, ...vocab.filter(v => v.en !== item.en).map(v => v.en)]
                        .sort(() => Math.random() - 0.5)
                        .slice(0, 4);
                    if (!question.options.includes(item.en)) question.options[0] = item.en; // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
                } else {
                    // Type 2: Fill in the Blank (Input) - –£–ª—É—á—à–µ–Ω–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
                    const inputSentences = [
                        // Verb: Multiple synonyms for 'run'
                        { en: "I like to [run] in the morning.", ru: "–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è [–±–µ–≥–∞—Ç—å] —É—Ç—Ä–æ–º.", answers: ["run", "jog", "sprint"] }, 
                        // Noun: Ambiguous object for work (as requested by user)
                        { en: "She has a new [computer] for work.", ru: "–£ –Ω–µ–µ –Ω–æ–≤—ã–π [–∫–æ–º–ø—å—é—Ç–µ—Ä] –¥–ª—è —Ä–∞–±–æ—Ç—ã.", answers: ["computer", "laptop", "tablet", "project", "boss"] }, 
                        // Adjective: Multiple weather descriptions
                        { en: "The weather is very [cold] today.", ru: "–ü–æ–≥–æ–¥–∞ –æ—á–µ–Ω—å [—Ö–æ–ª–æ–¥–Ω–∞—è] —Å–µ–≥–æ–¥–Ω—è.", answers: ["cold", "warm", "nice", "rainy", "sunny"] }, 
                        // Adverb/Pronoun: Multiple location adverbs
                        { en: "We should go [there] now.", ru: "–ú—ã –¥–æ–ª–∂–Ω—ã –ø–æ–π—Ç–∏ [—Ç—É–¥–∞] —Å–µ–π—á–∞—Å.", answers: ["there", "home", "out", "outside"] }, 
                        // Preposition: Multiple prepositions
                        { en: "He is [at] the house.", ru: "–û–Ω [–≤] –¥–æ–º–µ.", answers: ["at", "in", "near", "by"] }, 
                        // Verb: Multiple synonyms for 'eat'
                        { en: "They want to [eat] pizza tonight.", ru: "–û–Ω–∏ —Ö–æ—Ç—è—Ç [—Å—ä–µ—Å—Ç—å] –ø–∏—Ü—Ü—É —Å–µ–≥–æ–¥–Ω—è –≤–µ—á–µ—Ä–æ–º.", answers: ["eat", "order", "make", "cook"] }, 
                    ];
                    const sentence = inputSentences[Math.floor(Math.random() * inputSentences.length)];
                    
                    const match = sentence.en.match(/\[(.*?)\]/);
                    if (!match) return _generateRandomQuestion(courseId); // –ù–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫

                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–∏—Å–æ–∫ –æ—Ç–≤–µ—Ç–æ–≤
                    question.type = 'input';
                    question.text = `–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ–ø—É—Å–∫: "${sentence.en.replace(/\[(.*?)\]/, '___')}" (–Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º)`;
                    question.correct = sentence.answers[0]; // –û—Å–Ω–æ–≤–Ω–æ–π –æ—Ç–≤–µ—Ç –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏/–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    question.acceptableAnswers = sentence.answers; // –ú–∞—Å—Å–∏–≤ –≤—Å–µ—Ö –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
                }
                break;

            case 'chess':
                const pieces = { P: '–ü–µ—à–∫–∞', N: '–ö–æ–Ω—å', B: '–°–ª–æ–Ω', R: '–õ–∞–¥—å—è', Q: '–§–µ—Ä–∑—å', K: '–ö–æ—Ä–æ–ª—å' };
                const pieceKeys = Object.keys(pieces);
                const randomPiece = pieceKeys[Math.floor(Math.random() * pieceKeys.length)];

                // Type 1: Piece name (MCQ)
                question.type = 'mcq';
                question.text = `–ö–∞–∫–∞—è —Ñ–∏–≥—É—Ä–∞ –æ–±–æ–∑–Ω–∞—á–∞–µ—Ç—Å—è –±—É–∫–≤–æ–π "${randomPiece}"?`;
                question.correct = pieces[randomPiece];
                
                question.options = [pieces[randomPiece], ...pieceKeys.filter(p => p !== randomPiece).map(p => pieces[p])]
                    .sort(() => Math.random() - 0.5)
                    .slice(0, 4);
                if (!question.options.includes(pieces[randomPiece])) question.options[0] = pieces[randomPiece];

                // Type 2: Basic Notation (Input, less common)
                if (Math.random() < 0.3) {
                    const files = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
                    const ranks = ['1', '2', '3', '4', '5', '6', '7', '8'];
                    const square = files[Math.floor(Math.random() * 8)] + ranks[Math.floor(Math.random() * 8)];
                    question.type = 'input';
                    question.text = `–í–≤–µ–¥–∏—Ç–µ —à–∞—Ö–º–∞—Ç–Ω–æ–µ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Ö–æ–¥–∞ –ö–æ—Ä–æ–ª—è –Ω–∞ –∫–ª–µ—Ç–∫—É ${square}. (–ù–∞–ø—Ä–∏–º–µ—Ä: Ke4)`;
                    question.correct = 'K' + square; // –ü—Ä–æ—Å—Ç–æ –±–∞–∑–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä
                }
                break;

            case 'geography':
                const capitals = [
                    { country: "–§—Ä–∞–Ω—Ü–∏—è üá´üá∑", capital: "–ü–∞—Ä–∏–∂" }, 
                    { country: "–Ø–ø–æ–Ω–∏—è üáØüáµ", capital: "–¢–æ–∫–∏–æ" },
                    { country: "–ë—Ä–∞–∑–∏–ª–∏—è üáßüá∑", capital: "–ë—Ä–∞–∑–∏–ª–∏–∞" },
                    { country: "–ï–≥–∏–ø–µ—Ç üá™üá¨", capital: "–ö–∞–∏—Ä" },
                    { country: "–ö–∞–Ω–∞–¥–∞ üá®üá¶", capital: "–û—Ç—Ç–∞–≤–∞" },
                ];
                const capItem = capitals[Math.floor(Math.random() * capitals.length)];
                
                // Type 1: Capital Matching (MCQ)
                question.type = 'mcq';
                question.text = `–ö–∞–∫–∞—è —Å—Ç–æ–ª–∏—Ü–∞ —É —Å—Ç—Ä–∞–Ω—ã ${capItem.country}?`;
                question.correct = capItem.capital;
                
                question.options = [capItem.capital, ...capitals.filter(c => c.capital !== capItem.capital).map(c => c.capital)]
                    .sort(() => Math.random() - 0.5)
                    .slice(0, 4);
                if (!question.options.includes(capItem.capital)) question.options[0] = capItem.capital;
                break;

            case 'math':
                const op = ['+', '-', '*', '/'][Math.floor(Math.random() * 4)];
                let num1 = Math.floor(Math.random() * 20) + 1;
                let num2 = Math.floor(Math.random() * 10) + 1;
                let result;
                
                // Ensure division is clean for simplicity
                if (op === '/') {
                    result = num1;
                    num1 = result * num2;
                } else {
                    result = eval(`${num1} ${op} ${num2}`);
                }
                
                // Type 1: Simple Arithmetic (MCQ)
                question.type = 'mcq';
                question.text = `–ß–µ–º—É —Ä–∞–≤–Ω–æ ${num1} ${op} ${num2}?`;
                question.correct = String(result);
                
                question.options = [question.correct];
                while (question.options.length < 4) {
                    const falseAnswer = String(result + (Math.random() > 0.5 ? 1 : -1) * (Math.floor(Math.random() * 5) + 1));
                    if (!question.options.includes(falseAnswer)) question.options.push(falseAnswer);
                }
                question.options.sort(() => Math.random() - 0.5);

                // Type 2: Simple Algebra (Input, less common)
                if (Math.random() < 0.3) {
                    const x = Math.floor(Math.random() * 5) + 1;
                    const a = Math.floor(Math.random() * 5) + 1;
                    const b = a * x + 7;
                    question.type = 'input';
                    question.text = `–†–µ—à–∏—Ç–µ —É—Ä–∞–≤–Ω–µ–Ω–∏–µ: ${a}x + 7 = ${b}. –í–≤–µ–¥–∏—Ç–µ x.`;
                    question.correct = String(x);
                }
                break;

            case 'music':
                const notes = ["–î–æ", "–†–µ", "–ú–∏", "–§–∞", "–°–æ–ª—å", "–õ—è", "–°–∏"];
                const instruments = ["–ì–∏—Ç–∞—Ä–∞", "–§–æ—Ä—Ç–µ–ø–∏–∞–Ω–æ", "–°–∫—Ä–∏–ø–∫–∞", "–ë–∞—Ä–∞–±–∞–Ω—ã"];
                
                if (Math.random() < 0.5) {
                    // Type 1: Note Identification (MCQ)
                    const note = notes[Math.floor(Math.random() * notes.length)];
                    question.type = 'mcq';
                    question.text = `–ö–∞–∫–∞—è –Ω–æ—Ç–∞ –∏–¥–µ—Ç –ø–æ—Å–ª–µ ${notes[notes.indexOf(note) === notes.length - 1 ? 0 : notes.indexOf(note) + 1]}?`;
                    question.correct = note;
                    
                    question.options = [note, ...notes.filter(n => n !== note)]
                        .sort(() => Math.random() - 0.5)
                        .slice(0, 4);
                    if (!question.options.includes(note)) question.options[0] = note;
                } else {
                    // Type 2: Instrument Matching (MCQ)
                    const instrument = instruments[Math.floor(Math.random() * instruments.length)];
                    question.type = 'mcq';
                    question.text = `–ö–∞–∫–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç—Ä—É–Ω—ã?`;
                    question.correct = instrument;
                    
                    question.options = [instrument, ...instruments.filter(i => i !== instrument)]
                        .sort(() => Math.random() - 0.5)
                        .slice(0, 4);
                    if (!question.options.includes(instrument)) question.options[0] = instrument;
                }
                break;
        }

        // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –∏–º–µ—é—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è
        return {
            ...question,
            courseId: courseId,
        };
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –∏–ª–∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –≤–µ—Å—å —Å–ø–∏—Å–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è —É—Ä–æ–∫–∞ –∏–∑ –∫—ç—à–∞.
     * @param {string} courseId ID –∫—É—Ä—Å–∞.
     * @param {string} lessonId ID —É—Ä–æ–∫–∞.
     * @returns {Array<object>} –ú–∞—Å—Å–∏–≤ –≤–æ–ø—Ä–æ—Å–æ–≤.
     */
    function generateLessonQuestions(courseId, lessonId) {
        const cacheKey = `${courseId}-${lessonId}`;
        
        // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
        if (appState.questionsCache[cacheKey]) {
            console.log(`–í–æ–ø—Ä–æ—Å—ã –¥–ª—è ${cacheKey} –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –∫—ç—à–∞.`);
            return appState.questionsCache[cacheKey];
        }

        // 2. –ï—Å–ª–∏ –≤ –∫—ç—à–µ –Ω–µ—Ç, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —É—Ä–æ–∫
        const questions = [];
        const numQuestions = CONFIG.QUESTIONS_PER_LESSON;
        
        for (let i = 1; i <= numQuestions; i++) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞
            const q = _generateRandomQuestion(courseId);
            // –î–æ–±–∞–≤–ª—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞, –∏—Å–ø–æ–ª—å–∑—É—è –∫–ª—é—á –∫—ç—à–∞ –∏ –∏–Ω–¥–µ–∫—Å –≤–æ–ø—Ä–æ—Å–∞
            q.id = `${cacheKey}-${i}`; 
            questions.push(q);
        }
        
        // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à –∏ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
        appState.questionsCache[cacheKey] = questions;
        saveState();
        
        console.log(`–í–æ–ø—Ä–æ—Å—ã –¥–ª—è ${cacheKey} —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –∏ –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω—ã.`);
        return questions;
    }

    // ===============================================
    // –õ–û–ì–ò–ö–ê –°–£–ù–î–£–ö–û–í
    // ===============================================

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å—É–Ω–¥—É–∫–æ–≤.
     * @returns {Array<object>} –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—É–Ω–¥—É–∫–æ–≤ —Å –∏—Ö —Å—Ç–∞—Ç—É—Å–æ–º.
     */
    function getAvailableChests() {
        const now = new Date();
        const hours = now.getHours();
        const availableChests = [];
        const chestOpenedToday = appState.chests.lastChestOpenDate === now.toDateString();

        // –°—É–Ω–¥—É–∫ –†–∞–Ω–Ω–µ–π –ü—Ç–∞—à–∫–∏ (6:00 - 12:00)
        const earlyBirdAvailable = hours >= 6 && hours < 12;
        availableChests.push({
            id: 'early_bird',
            name: '–°—É–Ω–¥—É–∫ –†–∞–Ω–Ω–µ–π –ü—Ç–∞—à–∫–∏ üåÖ',
            description: '–û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å 6:00 –¥–æ 12:00. –ú–æ–∂–µ—Ç –≤—ã–ø–∞—Å—Ç—å x2 –∏–ª–∏ x3 –æ–ø—ã—Ç.',
            timeWindow: '06:00 - 12:00',
            available: earlyBirdAvailable && !chestOpenedToday,
            multiplierOptions: [2, 3],
        });

        // –°—É–Ω–¥—É–∫ –ü–æ–ª—É–Ω–æ—á–Ω–∏–∫–∞ (18:00 - 0:00)
        const nightOwlAvailable = hours >= 18 && hours < 24;
        availableChests.push({
            id: 'night_owl',
            name: '–°—É–Ω–¥—É–∫ –ü–æ–ª—É–Ω–æ—á–Ω–∏–∫–∞ ü¶â',
            description: '–û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å 18:00 –¥–æ 0:00. –ú–æ–∂–µ—Ç –≤—ã–ø–∞—Å—Ç—å x2 –∏–ª–∏ x3 –æ–ø—ã—Ç.',
            timeWindow: '18:00 - 00:00',
            available: nightOwlAvailable && !chestOpenedToday,
            multiplierOptions: [2, 3],
        });

        // –û–±—ã—á–Ω—ã–π —Å—É–Ω–¥—É–∫ (–û—Å—Ç–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è)
        const standardAvailable = !earlyBirdAvailable && !nightOwlAvailable;
        availableChests.push({
            id: 'standard',
            name: '–û–±—ã—á–Ω—ã–π –°—É–Ω–¥—É–∫ üì¶',
            description: '–û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –¥—Ä—É–≥–∏–µ —Å—É–Ω–¥—É–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ú–æ–∂–µ—Ç –≤—ã–ø–∞—Å—Ç—å x1.5 –∏–ª–∏ x2 –æ–ø—ã—Ç.',
            timeWindow: '12:00 - 18:00 –∏ 00:00 - 06:00',
            available: standardAvailable && !chestOpenedToday,
            multiplierOptions: [1.5, 2],
        });
        
        return availableChests;
    }
    
    /**
     * –û—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å—É–Ω–¥—É–∫ –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –º–Ω–æ–∂–∏—Ç–µ–ª—å XP.
     * @param {object} chestInfo –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—É–Ω–¥—É–∫–µ.
     */
    function openChest(chestInfo) {
        if (!chestInfo.available) {
            showModal('–û—à–∏–±–∫–∞', '–≠—Ç–æ—Ç —Å—É–Ω–¥—É–∫ —Å–µ–π—á–∞—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –≤—ã —É–∂–µ –æ—Ç–∫—Ä—ã–ª–∏ —Å—É–Ω–¥—É–∫ —Å–µ–≥–æ–¥–Ω—è.', null, '–ü–æ–Ω—è—Ç–Ω–æ');
            return;
        }

        const multiplier = chestInfo.multiplierOptions[Math.floor(Math.random() * chestInfo.multiplierOptions.length)];
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª—å
        appState.user.xpMultiplierValue = multiplier;
        appState.user.xpMultiplierLessonsLeft = 1; // –ú–Ω–æ–∂–∏—Ç–µ–ª—å –¥–µ–π—Å—Ç–≤—É–µ—Ç –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–∫
        appState.chests.lastChestOpenDate = new Date().toDateString();
        
        saveState();
        
        showModal('üéâ –°—É–Ω–¥—É–∫ –æ—Ç–∫—Ä—ã—Ç!', 
                  `–í—ã –ø–æ–ª—É—á–∏–ª–∏ –º–Ω–æ–∂–∏—Ç–µ–ª—å XP **x${multiplier}** –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–∫! –ú–Ω–æ–∂–∏—Ç–µ–ª—å –ø—Ä–∏–º–µ–Ω–µ–Ω.`, 
                  null, '–°—É–ø–µ—Ä!');
    }

    // ===============================================
    // –†–ï–ù–î–ï–†–ò–ù–ì UI –ò –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –í–ò–î–û–í
    // ===============================================

    /**
     * –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ.
     * @param {string} title –ó–∞–≥–æ–ª–æ–≤–æ–∫.
     * @param {string} message –°–æ–æ–±—â–µ–Ω–∏–µ.
     * @param {function|null} onConfirm –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏.
     * @param {string} confirmText –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.
     * @param {string} cancelText –¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –æ—Ç–º–µ–Ω—ã (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞).
     */
    function showModal(title, message, onConfirm = null, confirmText = '–û–ö', cancelText = null) {
        const backdrop = document.getElementById('modal-backdrop');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        modalTitle.textContent = title;
        modalMessage.innerHTML = message;
        modalConfirmBtn.textContent = confirmText;
        modalCancelBtn.textContent = cancelText || '';
        
        modalCancelBtn.onclick = () => { backdrop.classList.add('hidden'); };

        if (onConfirm) {
            modalConfirmBtn.onclick = () => {
                onConfirm();
                backdrop.classList.add('hidden');
            };
        } else {
            modalConfirmBtn.onclick = () => { backdrop.classList.add('hidden'); };
        }
        
        if (cancelText) {
            modalCancelBtn.classList.remove('hidden');
        } else {
            modalCancelBtn.classList.add('hidden');
        }

        backdrop.classList.remove('hidden');
    }

    /**
     * –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –±–æ–∫–æ–≤–æ–≥–æ –º–µ–Ω—é.
     */
    function renderNavBar() {
        const navList = document.getElementById('nav-list');
        navList.innerHTML = '';

        const navItems = [
            { id: 'courses', name: '–ö—É—Ä—Å—ã üéì' },
            { id: 'leaderboard', name: '–õ–∏–¥–µ—Ä–±–æ—Ä–¥ üèÜ' },
            { id: 'friends', name: '–î—Ä—É–∑—å—è ü§ù' },
            { id: 'shop', name: '–ú–∞–≥–∞–∑–∏–Ω üõçÔ∏è' },
            { id: 'chests', name: '–°—É–Ω–¥—É–∫–∏ üéÅ' },
            { id: 'profile', name: '–ü—Ä–æ—Ñ–∏–ª—å üë§' },
        ];

        navItems.forEach(item => {
            const button = document.createElement('button');
            button.className = `nav-item w-full text-left p-3 rounded-lg ${currentView === item.id ? 'active' : ''}`;
            button.textContent = item.name;
            button.onclick = () => renderView(item.id);
            
            const wrapper = document.createElement('div');
            wrapper.className = 'w-full md:w-auto my-1';
            wrapper.appendChild(button);
            navList.appendChild(wrapper);
        });
        
        updateDiamondDisplay();
    }

    /**
     * –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –≤–∏–¥—ã.
     * @param {string} viewId ID –≤–∏–¥–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.
     */
    function renderView(viewId) {
        currentView = viewId;
        renderNavBar();
        const content = document.getElementById('content');
        content.innerHTML = '';

        switch (viewId) {
            case 'courses':
                renderCoursesView(content);
                break;
            case 'lesson':
                renderLessonView(content);
                break;
            case 'leaderboard':
                renderLeaderboardView(content);
                break;
            case 'friends':
                renderFriendsView(content);
                break;
            case 'shop':
                renderShopView(content);
                break;
            case 'chests':
                renderChestsView(content);
                break;
            case 'profile':
                renderProfileView(content);
                break;
            default:
                content.innerHTML = '<h2 class="text-2xl font-bold text-gray-500">–í–∏–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω.</h2>';
        }
        window.scrollTo(0, 0);
    }
    
    // ===============================================
    // –†–ï–ù–î–ï–†–´ –†–ê–ó–î–ï–õ–û–í
    // ===============================================

    /**
     * –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤–∏–¥–∞ "–ö—É—Ä—Å—ã".
     * @param {HTMLElement} container –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞.
     */
    function renderCoursesView(container) {
        container.innerHTML = `<h2 class="text-3xl font-extrabold mb-6 text-emerald-900">–í–∞—à–∏ –∫—É—Ä—Å—ã</h2>`;

        const coursesList = document.createElement('div');
        coursesList.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';

        Object.entries(COURSES).forEach(([id, course]) => {
            const totalLessons = CONFIG.LESSONS_PER_COURSE;
            const completedCount = (appState.user.completedLessons[id] || []).length;
            const nextLesson = completedCount + 1;
            const progress = Math.round((completedCount / totalLessons) * 100);

            const card = document.createElement('div');
            card.className = 'bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition duration-300 border-b-4 border-emerald-500';
            card.innerHTML = `
                <h3 class="text-2xl font-bold text-gray-800 mb-2">${course.name}</h3>
                <p class="text-sm text-gray-500 mb-4">–ù–∞–π–¥–µ–Ω–æ ${totalLessons} —É—Ä–æ–∫–æ–≤</p>
                
                <div class="mb-4">
                    <p class="text-sm font-medium text-emerald-700">–ü—Ä–æ–≥—Ä–µ—Å—Å: ${completedCount}/${totalLessons} (${progress}%)</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="h-2.5 rounded-full bg-emerald-500" style="width: ${progress}%"></div>
                    </div>
                </div>

                <button 
                    class="w-full btn-primary px-4 py-2 rounded-lg font-semibold shadow-md"
                    onclick="renderLessonSelectView('${id}', '${course.name}')"
                >
                    ${completedCount >= totalLessons ? '–ü—Ä–æ–π–¥–µ–Ω–æ' : `–£—Ä–æ–∫ ${nextLesson}`}
                </button>
            `;
            coursesList.appendChild(card);
        });

        container.appendChild(coursesList);
    }
    
    /**
     * –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤–∏–¥–∞ "–í—ã–±–æ—Ä —É—Ä–æ–∫–∞".
     * @param {string} courseId ID –∫—É—Ä—Å–∞.
     * @param {string} courseName –ò–º—è –∫—É—Ä—Å–∞.
     */
    function renderLessonSelectView(courseId, courseName) {
        currentView = 'courses'; // –ù–µ –º–µ–Ω—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –≤–∏–¥, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
        const content = document.getElementById('content');
        content.innerHTML = `<h2 class="text-3xl font-extrabold mb-6 text-emerald-900">${courseName}</h2>`;
        
        const completedLessons = appState.user.completedLessons[courseId] || [];
        const lessonsContainer = document.createElement('div');
        lessonsContainer.className = 'grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4';

        for (let i = 1; i <= CONFIG.LESSONS_PER_COURSE; i++) {
            const lessonId = String(i);
            const isCompleted = completedLessons.includes(lessonId);
            const isLocked = i > completedLessons.length + 1;

            const button = document.createElement('button');
            button.className = `p-4 rounded-xl shadow-md transition duration-200 text-center font-bold text-xl h-24 flex items-center justify-center flex-col`;
            
            if (isCompleted) {
                button.classList.add('bg-emerald-500', 'text-white', 'hover:bg-emerald-600');
                button.innerHTML = `–£—Ä–æ–∫ ${i} <span class="text-sm">‚úÖ</span>`;
                button.onclick = () => startQuiz(courseId, lessonId, courseName);
            } else if (isLocked) {
                button.classList.add('bg-gray-300', 'text-gray-600', 'cursor-not-allowed');
                button.innerHTML = `–£—Ä–æ–∫ ${i} <span class="text-sm">üîí</span>`;
            } else {
                button.classList.add('btn-primary', 'hover:bg-emerald-600');
                button.innerHTML = `–£—Ä–æ–∫ ${i} <span class="text-sm">–ù–∞—á–∞—Ç—å</span>`;
                button.onclick = () => startQuiz(courseId, lessonId, courseName);
            }
            
            lessonsContainer.appendChild(button);
        }

        content.appendChild(lessonsContainer);
    }

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏ –Ω–∞—á–∏–Ω–∞–µ—Ç —Ç–µ—Å—Ç.
     * @param {string} courseId ID –∫—É—Ä—Å–∞.
     * @param {string} lessonId ID —É—Ä–æ–∫–∞.
     * @param {string} courseName –ò–º—è –∫—É—Ä—Å–∞.
     */
    function startQuiz(courseId, lessonId, courseName) {
        currentQuiz = {
            courseId,
            lessonId,
            courseName,
            questions: generateLessonQuestions(courseId, lessonId), // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
            currentQIndex: 0,
            correctCount: 0,
            incorrectCount: 0,
            xpMultiplier: appState.user.xpMultiplierValue,
            character: CHARACTERS[Math.floor(Math.random() * CHARACTERS.length)],
        };
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª—å –ø–æ—Å–ª–µ –µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        if (appState.user.xpMultiplierLessonsLeft > 0) {
            appState.user.xpMultiplierLessonsLeft--;
            if (appState.user.xpMultiplierLessonsLeft === 0) {
                appState.user.xpMultiplierValue = 1;
            }
        }
        saveState();
        renderView('lesson');
    }

    /**
     * –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤–∏–¥–∞ "–£—Ä–æ–∫/–¢–µ—Å—Ç".
     * @param {HTMLElement} container –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞.
     */
    function renderLessonView(container) {
        if (!currentQuiz) {
            return renderView('courses');
        }

        const q = currentQuiz.questions[currentQuiz.currentQIndex];
        const total = currentQuiz.questions.length;

        // –ü–∞–Ω–µ–ª—å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        container.innerHTML = `
            <div class="flex flex-col md:flex-row justify-between items-start mb-6 border-b pb-4 border-emerald-200">
                <div>
                    <h2 class="text-3xl font-extrabold text-emerald-900">${currentQuiz.courseName} - –£—Ä–æ–∫ ${currentQuiz.lessonId}</h2>
                    <p class="text-lg text-emerald-600">
                        –í–æ–ø—Ä–æ—Å ${currentQuiz.currentQIndex + 1} –∏–∑ ${total}
                        ${currentQuiz.xpMultiplier > 1 ? `<span class="bg-yellow-300 text-yellow-900 px-2 py-0.5 rounded-full text-sm font-semibold ml-2">XP x${currentQuiz.xpMultiplier}</span>` : ''}
                    </p>
                </div>
                <button onclick="renderView('courses')" class="mt-4 md:mt-0 px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
            </div>
            
            <!-- –ë–ª–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ -->
            <div class="flex items-start bg-emerald-100 p-4 rounded-xl shadow-inner mb-8">
                <span class="text-4xl mr-4">${currentQuiz.character.avatar}</span>
                <div>
                    <p class="font-bold text-emerald-800">${currentQuiz.character.name}:</p>
                    <p class="text-gray-700">–î–∞–≤–∞–π —Ä–∞–∑–±–µ—Ä–µ–º —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å! –ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω.</p>
                </div>
            </div>

            <!-- –ë–ª–æ–∫ –≤–æ–ø—Ä–æ—Å–∞ -->
            <div id="question-block" class="bg-white p-8 rounded-xl shadow-lg mb-8">
                <p class="text-xl font-semibold mb-6 text-gray-800">${q.text}</p>
                <div id="answer-options" class="space-y-4">
                    <!-- –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤/–ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
                </div>
                <div id="feedback-message" class="mt-4 text-center text-lg font-bold"></div>
                <button id="next-q-btn" class="mt-6 w-full btn-primary px-4 py-3 rounded-lg font-semibold shadow-md hidden" onclick="processNextQuestion()">–î–∞–ª–µ–µ</button>
            </div>
        `;
        
        const answerOptions = document.getElementById('answer-options');
        
        if (q.type === 'mcq') {
            q.options.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'w-full text-left p-3 rounded-lg border border-emerald-300 bg-white hover:bg-emerald-50 transition duration-150 text-gray-800';
                btn.textContent = option;
                // –î–ª—è MCQ –≤—ã–∑—ã–≤–∞–µ–º checkAnswer —Ç–æ–ª—å–∫–æ —Å userAnswer –∏ correctAnswer
                btn.onclick = () => checkAnswer(option, q.correct);
                answerOptions.appendChild(btn);
            });
        } else if (q.type === 'input') {
            // –ü–µ—Ä–µ–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å (–¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)
            const acceptableAnswersJson = q.acceptableAnswers ? JSON.stringify(q.acceptableAnswers) : 'null';

            answerOptions.innerHTML = `
                <input type="text" id="answer-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç –∑–¥–µ—Å—å" class="w-full p-3 border-2 border-emerald-300 rounded-lg focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500">
                <button id="submit-btn" class="w-full btn-primary px-4 py-3 rounded-lg font-semibold shadow-md mt-4" 
                    onclick="checkAnswer(document.getElementById('answer-input').value, '${q.correct}', ${acceptableAnswersJson})">
                    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
                </button>
            `;
        }
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
     * @param {string} userAnswer –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
     * @param {string} [correctAnswer] –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –∏–ª–∏ –¥–ª—è MCQ).
     * @param {Array<string>|null} [acceptableAnswers=null] –ú–∞—Å—Å–∏–≤ –≤—Å–µ—Ö –ø—Ä–∏–µ–º–ª–µ–º—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤.
     */
    function checkAnswer(userAnswer, correctAnswer, acceptableAnswers = null) {
        const normalizedUserAnswer = userAnswer.trim().toLowerCase();
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–±–æ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        let correctAnswersSet = acceptableAnswers || [correctAnswer];

        const isCorrect = correctAnswersSet.map(a => a.toLowerCase()).includes(normalizedUserAnswer);
        
        const feedback = document.getElementById('feedback-message');
        const options = document.getElementById('answer-options');
        const nextBtn = document.getElementById('next-q-btn');
        const submitBtn = document.getElementById('submit-btn');

        options.querySelectorAll('button, input').forEach(el => el.disabled = true);
        if (submitBtn) submitBtn.disabled = true;

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Ç–≤–µ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (–≤—Å–µ –¥–æ–ø—É—Å—Ç–∏–º—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Å–∫–æ–ª—å–∫–æ)
        const displayedCorrectAnswer = acceptableAnswers ? acceptableAnswers.join(', ') : correctAnswer;

        if (isCorrect) {
            feedback.className = 'mt-4 text-center text-lg font-bold text-green-600';
            feedback.textContent = '‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!';
            currentQuiz.correctCount++;
        } else {
            feedback.className = 'mt-4 text-center text-lg font-bold text-red-600';
            feedback.innerHTML = `‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ü—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è –≤–∞—Ä–∏–∞–Ω—Ç—ã: <span class="text-emerald-700 font-normal">${displayedCorrectAnswer}</span>`;
            currentQuiz.incorrectCount++;
        }

        nextBtn.classList.remove('hidden');
    }

    /**
     * –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ç–µ—Å—Ç.
     */
    function processNextQuestion() {
        currentQuiz.currentQIndex++;

        if (currentQuiz.currentQIndex < currentQuiz.questions.length) {
            renderView('lesson');
        } else {
            // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞
            finishQuiz();
        }
    }

    /**
     * –ó–∞–≤–µ—Ä—à–∞–µ—Ç —Ç–µ—Å—Ç, –Ω–∞—á–∏—Å–ª—è–µ—Ç –Ω–∞–≥—Ä–∞–¥—ã –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
     */
    function finishQuiz() {
        const totalXP = currentQuiz.correctCount * CONFIG.XP_PER_CORRECT * currentQuiz.xpMultiplier;
        const totalDiamonds = CONFIG.DIAMONDS_PER_LESSON;
        const leaguePointsGained = Math.round(totalXP / 5);

        appState.user.totalXP += totalXP;
        appState.user.diamonds += totalDiamonds;
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–∏–≥–∏
        const newLeaguePoints = appState.user.leaguePoints + leaguePointsGained;
        checkLeaguePromotion(newLeaguePoints);
        
        // –û—Ç–º–µ—Ç–∫–∞ —É—Ä–æ–∫–∞ –∫–∞–∫ –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–≥–æ
        if (!appState.user.completedLessons[currentQuiz.courseId]) {
            appState.user.completedLessons[currentQuiz.courseId] = [];
        }
        if (!appState.user.completedLessons[currentQuiz.courseId].includes(currentQuiz.lessonId)) {
            appState.user.completedLessons[currentQuiz.courseId].push(currentQuiz.lessonId);
        }
        
        saveState();

        showModal('–£—Ä–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω!', 
                  `<div class="space-y-2">
                    <p class="text-xl font-bold text-emerald-600">üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</p>
                    <p>–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: <span class="font-semibold text-green-600">${currentQuiz.correctCount}</span></p>
                    <p>–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: <span class="font-semibold text-red-600">${currentQuiz.incorrectCount}</span></p>
                    <p>–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ XP: <span class="font-semibold text-yellow-700">+${totalXP} XP</span> (x${currentQuiz.xpMultiplier})</p>
                    <p>–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –∞–ª–º–∞–∑–æ–≤: <span class="font-semibold text-emerald-700">+${totalDiamonds} üíé</span></p>
                    <p>–û—á–∫–∏ –ª–∏–≥–∏: <span class="font-semibold text-purple-700">+${leaguePointsGained}</span></p>
                  </div>`, 
                  () => renderView('courses'), '–ö –∫—É—Ä—Å–∞–º');

        currentQuiz = null; // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç–µ—Å—Ç–∞
    }

    /**
     * –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤–∏–¥–∞ "–õ–∏–¥–µ—Ä–±–æ—Ä–¥".
     * @param {HTMLElement} container –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞.
     */
    function renderLeaderboardView(container) {
        container.innerHTML = `<h2 class="text-3xl font-extrabold mb-6 text-emerald-900">–õ–∏–¥–µ—Ä–±–æ—Ä–¥</h2>`;

        const userLeagueInfo = getLeagueInfo(appState.user.leaguePoints);
        const userLeagueIndex = userLeagueInfo.index;

        container.innerHTML += `<div class="p-4 bg-emerald-100 rounded-xl shadow-inner mb-6">
            <p class="font-semibold text-emerald-800">–í—ã –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç–µ —Å–≤–æ—é —Ç–µ–∫—É—â—É—é –ª–∏–≥—É:</p>
            <h3 class="text-2xl font-bold text-emerald-900">${userLeagueInfo.name} –õ–∏–≥–∞</h3>
            ${userLeagueInfo.name !== CONFIG.LEAGUES[CONFIG.LEAGUES.length - 1].name ? 
                `<p class="text-sm text-gray-600">–ù–∞–±–µ—Ä–∏—Ç–µ ${userLeagueInfo.requiredPoints - userLeagueInfo.minPoints} –æ—á–∫–æ–≤, —á—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –≤ —Å–ª–µ–¥—É—é—â—É—é –ª–∏–≥—É!</p>` :
                `<p class="text-sm text-gray-600">–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –≤–µ—Ä—à–∏–Ω—ã! –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —É–¥–µ—Ä–∂–∏–≤–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é.</p>`
            }
        </div>`;

        const allContestants = [
            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            { 
                id: appState.user.id, 
                nickname: appState.user.nickname, 
                isUser: true, 
                leaguePoints: appState.user.leaguePoints, 
                avatarId: appState.user.avatarId,
            },
            // –ë–æ—Ç—ã
            ...appState.leaderboard.bots
        ];

        // 1. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è: –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ —Ç–µ–∫—É—â–µ–π –ª–∏–≥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const leagueContestants = allContestants.filter(c => {
            // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ª–∏–≥—É –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞, —á—Ç–æ–±—ã —Ñ–∏–ª—å—Ç—Ä –±—ã–ª —Ç–æ—á–Ω—ã–º
            const contestantInfo = getLeagueInfo(c.leaguePoints);
            return contestantInfo.index === userLeagueIndex;
        });

        // 2. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –æ—á–∫–∞–º –ª–∏–≥–∏
        leagueContestants.sort((a, b) => b.leaguePoints - a.leaguePoints);
        
        const currentLeagueData = CONFIG.LEAGUES[userLeagueIndex];

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –¢–û–õ–¨–ö–û —Ç–µ–∫—É—â–µ–π –ª–∏–≥–∏
        const leagueCard = document.createElement('div');
        leagueCard.className = 'league-card p-4 rounded-xl shadow-md mb-8';
        leagueCard.innerHTML = `<h3 class="text-xl font-bold text-emerald-900 mb-4">${currentLeagueData.name} –õ–∏–≥–∞ (–¢—É—Ä–Ω–∏—Ä–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞)</h3>`;
        
        const table = document.createElement('div');
        table.className = 'space-y-2';

        if (leagueContestants.length === 0) {
            table.innerHTML = '<p class="text-gray-600 p-3">–í —ç—Ç–æ–π –ª–∏–≥–µ –ø–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤. –ù–∞—á–Ω–∏—Ç–µ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—á–∫–∏!</p>';
        } else {
            leagueContestants.forEach((c, index) => {
                const isFriend = appState.friends.includes(c.id);
                const avatarIcon = AVATAR_OPTIONS.find(a => a.id === c.avatarId)?.icon || 'üë§';

                const row = document.createElement('div');
                row.className = `flex items-center p-3 rounded-lg transition duration-150 ${c.isUser ? 'bg-emerald-300 shadow-xl' : 'bg-white hover:bg-gray-50'}`;
                
                row.innerHTML = `
                    <span class="font-bold text-lg w-8 text-center">${index + 1}</span>
                    <span class="text-2xl mr-3">${avatarIcon}</span>
                    <div class="flex-grow">
                        <span class="font-semibold ${c.isUser ? 'text-emerald-900' : 'text-gray-800'}">${c.nickname} ${c.isUser ? '(–í—ã)' : ''}</span>
                    </div>
                    <span class="font-bold text-lg text-emerald-700">${c.leaguePoints} –æ—á–∫–æ–≤</span>
                `;
                
                if (!c.isUser) {
                    const friendBtn = document.createElement('button');
                    friendBtn.className = `ml-4 px-3 py-1 rounded-full text-sm font-semibold transition duration-150 ${isFriend ? 'bg-gray-400 text-white' : 'btn-primary'}`;
                    friendBtn.textContent = isFriend ? '‚úÖ –î—Ä—É–≥' : '‚ûï –î–æ–±–∞–≤–∏—Ç—å';
                    friendBtn.disabled = isFriend;
                    friendBtn.onclick = () => addFriend(c.id);
                    row.appendChild(friendBtn);
                }
                
                table.appendChild(row);
            });
        }
        
        leagueCard.appendChild(table);
        container.appendChild(leagueCard);
    }

    /**
     * –î–æ–±–∞–≤–ª—è–µ—Ç –±–æ—Ç–∞ –≤ –¥—Ä—É–∑—å—è.
     * @param {string} botId ID –±–æ—Ç–∞.
     */
    function addFriend(botId) {
        if (!appState.friends.includes(botId)) {
            appState.friends.push(botId);
            saveState();
            showModal('–î—Ä—É–≥ –¥–æ–±–∞–≤–ª–µ–Ω', '–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≤–∞—à —Å–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π.', null, '–û–ö');
        }
    }
    
    /**
     * –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤–∏–¥–∞ "–î—Ä—É–∑—å—è".
     * @param {HTMLElement} container –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞.
     */
    function renderFriendsView(container) {
        container.innerHTML = `<h2 class="text-3xl font-extrabold mb-6 text-emerald-900">–°–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π</h2>`;

        if (appState.friends.length === 0) {
            container.innerHTML += `<p class="text-gray-600">–í–∞—à —Å–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–æ–≤ —Å –õ–∏–¥–µ—Ä–±–æ—Ä–¥–∞!</p>`;
            return;
        }

        const friendsList = appState.leaderboard.bots
            .filter(bot => appState.friends.includes(bot.id))
            .map(bot => ({
                ...bot,
                leagueName: getLeagueInfo(bot.leaguePoints).name,
                avatar: AVATAR_OPTIONS.find(a => a.id === bot.avatarId)?.icon || 'üë§',
            }))
            .sort((a, b) => b.leaguePoints - a.leaguePoints);

        const listContainer = document.createElement('div');
        listContainer.className = 'space-y-3';

        friendsList.forEach(friend => {
            const card = document.createElement('div');
            card.className = 'flex items-center justify-between bg-white p-4 rounded-xl shadow-md';
            card.innerHTML = `
                <div class="flex items-center">
                    <span class="text-3xl mr-4">${friend.avatar}</span>
                    <div>
                        <p class="font-semibold text-gray-800">${friend.nickname}</p>
                        <p class="text-sm text-gray-500">${friend.leagueName} –õ–∏–≥–∞</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="font-bold text-lg text-emerald-700">${friend.leaguePoints} –æ—á–∫–æ–≤</span>
                    <button onclick="removeFriend('${friend.id}')" class="text-red-500 hover:text-red-700 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M16.5 4.5a.75.75 0 0 1 .75-.75h2.25a.75.75 0 0 1 0 1.5H18v11.75a3 3 0 0 1-3 3H9.75a3 3 0 0 1-3-3V5.25h-.75a.75.75 0 0 1 0-1.5h2.25a.75.75 0 0 1 .75.75V18a1.5 1.5 0 0 0 1.5 1.5h3a1.5 1.5 0 0 0 1.5-1.5V5.25h1.5a.75.75 0 0 1 .75-.75Zm-5.25 2.25a.75.75 0 0 0-1.5 0v10.5a.75.75 0 0 0 1.5 0V6.75Zm5.25 0a.75.75 0 0 0-1.5 0v10.5a.75.75 0 0 0 1.5 0V6.75Z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            `;
            listContainer.appendChild(card);
        });

        container.appendChild(listContainer);
    }
    
    /**
     * –£–¥–∞–ª—è–µ—Ç –¥—Ä—É–≥–∞.
     * @param {string} friendId ID –¥—Ä—É–≥–∞.
     */
    function removeFriend(friendId) {
        showModal('–£–¥–∞–ª–∏—Ç—å –¥—Ä—É–≥–∞', `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –¥—Ä—É–≥–∞?`, 
            () => {
                appState.friends = appState.friends.filter(id => id !== friendId);
                saveState();
                renderView('friends');
            }, '–î–∞, —É–¥–∞–ª–∏—Ç—å', '–û—Ç–º–µ–Ω–∞');
    }

    /**
     * –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤–∏–¥–∞ "–ú–∞–≥–∞–∑–∏–Ω".
     * @param {HTMLElement} container –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞.
     */
    function renderShopView(container) {
        container.innerHTML = `<h2 class="text-3xl font-extrabold mb-6 text-emerald-900">–ú–∞–≥–∞–∑–∏–Ω Paom</h2>`;

        // --- –†–∞–∑–¥–µ–ª –ê–≤–∞—Ç–∞—Ä–æ–∫ ---
        container.innerHTML += `<h3 class="text-2xl font-bold mt-8 mb-4 text-emerald-800 border-b pb-2">–ê–≤–∞—Ç–∞—Ä–∫–∏</h3>`;
        const avatarGrid = document.createElement('div');
        avatarGrid.className = 'grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-8';

        AVATAR_OPTIONS.forEach(avatar => {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞, –≤–ª–∞–¥–µ–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤–∞—Ç–∞—Ä–æ–º. –ï—Å–ª–∏ —Ü–µ–Ω–∞ > 0, –ø—Ä–æ–≤–µ—Ä—è–µ–º ownedAvatars.
            const isOwned = avatar.price === 0 || (appState.user.ownedAvatars && appState.user.ownedAvatars.includes(avatar.id));
            const isEquipped = appState.user.avatarId === avatar.id;
            
            const card = document.createElement('div');
            card.className = `bg-white p-4 rounded-xl shadow-lg transition duration-200 text-center flex flex-col items-center justify-between h-36 border-4 ${isEquipped ? 'border-yellow-500' : 'border-gray-100'}`;
            
            card.innerHTML = `<span class="text-4xl">${avatar.icon}</span>`;
            
            const actionBtn = document.createElement('button');
            actionBtn.className = 'mt-3 w-full px-3 py-1 rounded-lg font-semibold text-sm transition duration-150';
            
            if (isEquipped) {
                actionBtn.textContent = '–≠–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–æ';
                actionBtn.classList.add('bg-yellow-500', 'text-white', 'cursor-default');
                actionBtn.disabled = true;
            } else if (isOwned) {
                actionBtn.textContent = '–≠–∫–∏–ø–∏—Ä–æ–≤–∞—Ç—å';
                actionBtn.classList.add('btn-primary', 'hover:bg-emerald-600');
                actionBtn.onclick = () => {
                    appState.user.avatarId = avatar.id;
                    saveState();
                    renderView('shop');
                };
            } else {
                actionBtn.textContent = `${avatar.price} üíé –ö—É–ø–∏—Ç—å`;
                actionBtn.classList.add('bg-purple-600', 'text-white', 'hover:bg-purple-700');
                actionBtn.disabled = appState.user.diamonds < avatar.price;
                actionBtn.onclick = () => buyItem(avatar, 'avatar');
            }
            
            card.appendChild(actionBtn);
            avatarGrid.appendChild(card);
        });

        container.appendChild(avatarGrid);

        // --- –†–∞–∑–¥–µ–ª –£—Å–∫–æ—Ä–∏—Ç–µ–ª–µ–π XP ---
        container.innerHTML += `<h3 class="text-2xl font-bold mt-8 mb-4 text-emerald-800 border-b pb-2">–£—Å–∫–æ—Ä–∏—Ç–µ–ª–∏ –æ–ø—ã—Ç–∞</h3>`;
        const xpItemsContainer = document.createElement('div');
        xpItemsContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';

        SHOP_ITEMS.filter(item => item.type === 'xp').forEach(item => {
            const card = document.createElement('div');
            card.className = 'bg-white p-6 rounded-xl shadow-lg border-b-4 border-purple-500';
            card.innerHTML = `
                <h4 class="text-xl font-bold text-gray-800 mb-2">${item.name}</h4>
                <p class="text-gray-600 mb-4">–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç XP –≤ ${item.multiplier} —Ä–∞–∑ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–µ ${item.lessons} —É—Ä–æ–∫(–∞).</p>
                <button 
                    class="w-full bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold shadow-md hover:bg-purple-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
                    onclick="buyItem(SHOP_ITEMS.find(i => i.id === '${item.id}'), 'xp')"
                    ${appState.user.diamonds < item.price ? 'disabled' : ''}
                >
                    ${item.price} üíé –ö—É–ø–∏—Ç—å
                </button>
                ${appState.user.diamonds < item.price ? '<p class="text-red-500 text-sm mt-2">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–ª–º–∞–∑–æ–≤</p>' : ''}
            `;
            xpItemsContainer.appendChild(card);
        });

        container.appendChild(xpItemsContainer);
        
        // --- –°—Ç–∞—Ç—É—Å –º–Ω–æ–∂–∏—Ç–µ–ª—è
        if (appState.user.xpMultiplierLessonsLeft > 0) {
            container.innerHTML += `<div class="mt-8 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-lg">
                –ê–∫—Ç–∏–≤–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å: <span class="font-bold">x${appState.user.xpMultiplierValue}</span>. –û—Å—Ç–∞–ª–æ—Å—å —É—Ä–æ–∫–æ–≤: <span class="font-bold">${appState.user.xpMultiplierLessonsLeft}</span>.
            </div>`;
        }
    }

    /**
     * –õ–æ–≥–∏–∫–∞ –ø–æ–∫—É–ø–∫–∏ —Ç–æ–≤–∞—Ä–∞ –≤ –º–∞–≥–∞–∑–∏–Ω–µ.
     * @param {object} item –¢–æ–≤–∞—Ä.
     * @param {string} type –¢–∏–ø —Ç–æ–≤–∞—Ä–∞ ('avatar' –∏–ª–∏ 'xp').
     */
    function buyItem(item, type) {
        if (appState.user.diamonds < item.price) {
            showModal('–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏', '–£ –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–ª–º–∞–∑–æ–≤ –¥–ª—è —ç—Ç–æ–π –ø–æ–∫—É–ø–∫–∏.', null, '–û–ö');
            return;
        }

        const confirmPurchase = () => {
            appState.user.diamonds -= item.price;

            if (type === 'avatar') {
                if (!appState.user.ownedAvatars) appState.user.ownedAvatars = [];
                appState.user.ownedAvatars.push(item.id);
                appState.user.avatarId = item.id;
                showModal('–ü–æ–∫—É–ø–∫–∞ —Å–æ–≤–µ—Ä—à–µ–Ω–∞', `–í—ã –∫—É–ø–∏–ª–∏ –∏ —ç–∫–∏–ø–∏—Ä–æ–≤–∞–ª–∏ –∞–≤–∞—Ç–∞—Ä ${item.icon}.`, null, '–û—Ç–ª–∏—á–Ω–æ');
            } else if (type === 'xp') {
                appState.user.xpMultiplierLessonsLeft += item.lessons;
                appState.user.xpMultiplierValue = item.multiplier;
                showModal('–ü–æ–∫—É–ø–∫–∞ —Å–æ–≤–µ—Ä—à–µ–Ω–∞', `–í—ã –∫—É–ø–∏–ª–∏ –º–Ω–æ–∂–∏—Ç–µ–ª—å XP x${item.multiplier} –Ω–∞ ${item.lessons} —É—Ä–æ–∫(–∞)!`, null, '–û—Ç–ª–∏—á–Ω–æ');
            }
            
            saveState();
            renderView('shop');
        };

        showModal('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏', `–í—ã —Ö–æ—Ç–∏—Ç–µ –∫—É–ø–∏—Ç—å "${item.name}" –∑–∞ ${item.price} üíé?`, 
                  confirmPurchase, '–ö—É–ø–∏—Ç—å', '–û—Ç–º–µ–Ω–∞');
    }
    
    /**
     * –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤–∏–¥–∞ "–°—É–Ω–¥—É–∫–∏".
     * @param {HTMLElement} container –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞.
     */
    function renderChestsView(container) {
        container.innerHTML = `<h2 class="text-3xl font-extrabold mb-6 text-emerald-900">–°—É–Ω–¥—É–∫–∏ (–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ª–∏–º–∏—Ç: 1)</h2>`;

        const chestOpenedToday = appState.chests.lastChestOpenDate === new Date().toDateString();
        
        if (chestOpenedToday) {
            container.innerHTML += `<div class="p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-lg mb-6">
                –í—ã —É–∂–µ –æ—Ç–∫—Ä—ã–ª–∏ —Å—É–Ω–¥—É–∫ —Å–µ–≥–æ–¥–Ω—è. –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å –∑–∞–≤—Ç—Ä–∞!
            </div>`;
        }
        
        const availableChests = getAvailableChests();
        const chestGrid = document.createElement('div');
        chestGrid.className = 'grid grid-cols-1 md:grid-cols-3 gap-6';

        availableChests.forEach(chest => {
            const card = document.createElement('div');
            card.className = `bg-white p-6 rounded-xl shadow-lg border-b-4 ${chest.available ? 'border-emerald-500' : 'border-gray-300'}`;
            
            card.innerHTML = `
                <h4 class="text-xl font-bold text-gray-800 mb-2">${chest.name}</h4>
                <p class="text-sm text-gray-500 mb-2">–í—Ä–µ–º—è: ${chest.timeWindow}</p>
                <p class="text-gray-600 mb-4">${chest.description}</p>
            `;
            
            const btn = document.createElement('button');
            btn.className = `w-full px-4 py-2 rounded-lg font-semibold shadow-md transition disabled:bg-gray-400 disabled:cursor-not-allowed`;
            btn.textContent = chest.available ? '–û—Ç–∫—Ä—ã—Ç—å —Å—É–Ω–¥—É–∫!' : (chestOpenedToday ? '–û—Ç–∫—Ä—ã—Ç —Å–µ–≥–æ–¥–Ω—è' : '–ó–∞–∫—Ä—ã—Ç');
            btn.disabled = !chest.available || chestOpenedToday;

            if (chest.available && !chestOpenedToday) {
                btn.classList.add('btn-primary', 'hover:bg-emerald-600');
                btn.onclick = () => openChest(chest);
            } else {
                btn.classList.add('bg-gray-400', 'text-white');
            }
            
            card.appendChild(btn);
            chestGrid.appendChild(card);
        });

        container.appendChild(chestGrid);
    }

    /**
     * –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤–∏–¥–∞ "–ü—Ä–æ—Ñ–∏–ª—å".
     * @param {HTMLElement} container –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞.
     */
    function renderProfileView(container) {
        const user = appState.user;
        const levelInfo = calculateLevel(user.totalXP);
        const leagueInfo = getLeagueInfo(user.leaguePoints);
        const currentAvatar = AVATAR_OPTIONS.find(a => a.id === user.avatarId)?.icon || 'üë§';

        container.innerHTML = `<h2 class="text-3xl font-extrabold mb-6 text-emerald-900">–ü—Ä–æ—Ñ–∏–ª—å —É—á–µ–Ω–∏–∫–∞</h2>`;

        const profileCard = document.createElement('div');
        profileCard.className = 'bg-white p-8 rounded-xl shadow-xl max-w-lg mx-auto';
        profileCard.innerHTML = `
            <div class="flex flex-col items-center mb-6">
                <span class="text-7xl mb-4">${currentAvatar}</span>
                <input type="text" id="nickname-input" value="${user.nickname}" 
                       class="text-3xl font-bold text-gray-800 text-center border-b-2 border-emerald-300 focus:border-emerald-500 outline-none p-1 bg-gray-50 rounded-md"
                       onchange="updateNickname(this.value)">
                <p class="text-md text-gray-500 mt-1">ID: ${user.id}</p>
            </div>
            
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="space-y-4">
                <div class="p-3 bg-emerald-100 rounded-lg flex justify-between items-center">
                    <span class="font-semibold text-emerald-700">–ê–ª–º–∞–∑—ã:</span>
                    <span class="font-bold text-lg text-emerald-900">${user.diamonds} üíé</span>
                </div>

                <div class="p-3 bg-gray-100 rounded-lg">
                    <span class="font-semibold text-gray-700">–£—Ä–æ–≤–µ–Ω—å: ${levelInfo.level}</span>
                    <div class="w-full bg-gray-200 rounded-full h-3 mt-1">
                        <div class="h-3 rounded-full bg-blue-500" style="width: ${(levelInfo.xpInCurrent / levelInfo.totalXpForLevel) * 100}%"></div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">${levelInfo.xpInCurrent} / ${levelInfo.totalXpForLevel} XP –¥–æ ${levelInfo.level + 1} —É—Ä–æ–≤–Ω—è</p>
                </div>

                <div class="p-3 bg-red-100 rounded-lg">
                    <span class="font-semibold text-red-700">–õ–∏–≥–∞: ${leagueInfo.name}</span>
                    <div class="w-full bg-gray-200 rounded-full h-3 mt-1">
                        <div class="h-3 rounded-full bg-red-500" style="width: ${((user.leaguePoints - leagueInfo.minPoints) / (leagueInfo.requiredPoints - leagueInfo.minPoints)) * 100}%"></div>
                    </div>
                    ${leagueInfo.name !== CONFIG.LEAGUES[CONFIG.LEAGUES.length - 1].name ? 
                        `<p class="text-xs text-gray-500 mt-1">${user.leaguePoints - leagueInfo.minPoints} / ${leagueInfo.requiredPoints - leagueInfo.minPoints} –æ—á–∫–æ–≤ –¥–æ —Å–ª–µ–¥—É—é—â–µ–π –ª–∏–≥–∏</p>` :
                        `<p class="text-xs text-gray-500 mt-1">–í—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ —Å–∞–º–æ–π –≤—ã—Å–æ–∫–æ–π –ª–∏–≥–µ!</p>`
                    }
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ -->
            <button onclick="resetProfileConfirmation()" class="mt-8 w-full bg-red-500 text-white px-4 py-3 rounded-lg font-semibold shadow-md hover:bg-red-600 transition">
                –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å (–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ)
            </button>
        `;

        container.appendChild(profileCard);
    }
    
    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç –Ω–∏–∫–Ω–µ–π–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
     * @param {string} newNickname –ù–æ–≤—ã–π –Ω–∏–∫–Ω–µ–π–º.
     */
    function updateNickname(newNickname) {
        appState.user.nickname = newNickname.trim() || "–ù–æ–≤—ã–π –£—á–µ–Ω–∏–∫";
        saveState();
        showModal('–ù–∏–∫–Ω–µ–π–º –∏–∑–º–µ–Ω–µ–Ω', `–í–∞—à –Ω–∏–∫–Ω–µ–π–º —Ç–µ–ø–µ—Ä—å: ${appState.user.nickname}`, null, '–û–ö');
    }

    /**
     * –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–±—Ä–æ—Å–∞ –ø—Ä–æ—Ñ–∏–ª—è.
     */
    function resetProfileConfirmation() {
        showModal('–°–±—Ä–æ—Å –ø—Ä–æ—Ñ–∏–ª—è', 
                  '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å, XP, –∞–ª–º–∞–∑—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.',
                  resetProfile, '–î–∞, —Å–±—Ä–æ—Å–∏—Ç—å', '–û—Ç–º–µ–Ω–∞');
    }

    /**
     * –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –ø—Ä–æ—Ñ–∏–ª—è.
     */
    function resetProfile() {
        localStorage.removeItem('paomStudyState');
        initializeState();
        renderView('profile');
        showModal('–ü—Ä–æ—Ñ–∏–ª—å —Å–±—Ä–æ—à–µ–Ω', '–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å –±—ã–ª —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω. –ù–∞—á–Ω–∏—Ç–µ –æ–±—É—á–µ–Ω–∏–µ –∑–∞–Ω–æ–≤–æ!', null, '–ù–∞—á–∞—Ç—å');
    }

    // ===============================================
    // –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
    // ===============================================

    window.onload = function() {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ HTML
        window.renderView = renderView;
        window.startQuiz = startQuiz;
        window.updateNickname = updateNickname;
        window.resetProfileConfirmation = resetProfileConfirmation;
        window.buyItem = buyItem;
        window.addFriend = addFriend;
        window.removeFriend = removeFriend;
        window.openChest = openChest;
        // –î–æ–±–∞–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ checkAnswer
        window.checkAnswer = checkAnswer; 

        initializeState();
        renderView('courses');
    };
</script>
</body>
</html>
