<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>paom: Обновление 1 ❄️</title>
    <!-- Подключение Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Настройка шрифта Inter и Зимняя тема -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* Легкий, морозный фон */
            background-color: #e0f7fa; 
        }
        .snow-accent {
            color: #00bcd4; /* Голубой акцент */
        }
        .snow-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 188, 212, 0.1), 0 2px 4px -2px rgba(0, 188, 212, 0.06);
        }
        .snow-border {
            border-color: #00bcd4;
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="max-w-3xl mx-auto p-4 md:p-8">
        <!-- Заголовок -->
        <header class="text-center mb-10">
            <h1 class="text-5xl font-extrabold text-indigo-700 mb-2">
                paom
            </h1>
            <p class="text-xl font-semibold text-sky-500 mb-4">Обновление 1 ❄️</p>
            <p class="text-gray-500">Поделитесь своими мыслями в реальном времени.</p>
            <div id="user-info" class="mt-4 text-sm text-gray-700 p-3 bg-white rounded-xl shadow-lg snow-shadow border-t-4 border-sky-400">
                <p>Статус: <span id="auth-status" class="font-semibold text-yellow-600">Загрузка...</span></p>
                <p>Ваш ник: <span id="user-nickname" class="font-bold text-indigo-600"></span></p>
                <p>Ваш ID: <code id="user-id" class="break-all text-xs text-gray-500"></code></p>
            </div>
        </header>

        <!-- Форма для нового поста -->
        <section class="bg-white p-6 rounded-xl shadow-lg snow-shadow mb-8 border-t-4 border-sky-300">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Что у вас на уме?</h2>
            <form id="post-form">
                <textarea id="post-content" rows="3"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition duration-150 resize-none"
                    placeholder="Введите ваше сообщение здесь..." required disabled></textarea>
                <div class="mt-4 flex justify-end">
                    <button type="submit" id="post-button"
                        class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out disabled:bg-gray-400"
                        disabled>
                        Опубликовать
                    </button>
                </div>
            </form>
        </section>

        <!-- Лента постов -->
        <section>
            <h2 class="text-2xl font-semibold mb-6 text-gray-800">Лента Сообщений</h2>
            <div id="posts-feed" class="space-y-4">
                <!-- Здесь будут отображаться посты -->
                <p id="loading-indicator" class="text-center text-gray-500">Загрузка постов...</p>
            </div>
        </section>

        <!-- Кастомное модальное окно для ошибок/уведомлений -->
        <div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                <h3 id="modal-title" class="text-xl font-bold mb-3 text-red-600">Ошибка!</h3>
                <p id="modal-message" class="text-gray-700 mb-4"></p>
                <button onclick="document.getElementById('modal').classList.add('hidden')"
                    class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg transition duration-300">
                    Закрыть
                </button>
            </div>
        </div>

        <!-- Кастомное модальное окно для регистрации никнейма -->
        <div id="nickname-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full border-t-8 border-sky-400">
                <h3 class="text-2xl font-bold mb-4 text-indigo-700">Добро пожаловать в paom!</h3>
                <p class="text-gray-600 mb-6">Пожалуйста, придумайте никнейм. Он будет отображаться под вашими постами.</p>
                <form id="nickname-form">
                    <input type="text" id="nickname-input" minlength="2" maxlength="20" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition duration-150"
                        placeholder="Введите ваш никнейм (2-20 символов)">
                    <p id="nickname-error" class="text-red-500 text-sm mt-2 hidden">Никнейм не может быть пустым.</p>
                    <button type="submit" id="nickname-button"
                        class="mt-6 w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 rounded-lg shadow-lg transition duration-300">
                        Сохранить и Войти
                    </button>
                </form>
            </div>
        </div>

    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        // Импорт необходимых модулей Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, getDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ВАЖНО: Ваша СТРОГАЯ конфигурация (для развертывания)
        const userConfig = {
            apiKey: "AIzaSyAWV097BE56m2YVNi2D494dyXK41j9V5bE",
            authDomain: "messanger-b0b91.firebaseapp.com",
            projectId: "messanger-b0b91",
            storageBucket: "messanger-b0b91.firebasestorage.app",
            messagingSenderId: "895029700922",
            appId: "1:895029700922:web:184790c791e66978aa4803",
            measurementId: "G-8YMP1TY2HW"
        };

        // --- Глобальные переменные Canvas, которые мы ДОЛЖНЫ использовать для корректной работы здесь ---
        // Приоритет отдается конфигурации среды (для корректной аутентификации и работы с Firestore)
        const firebaseConfig = (typeof __firebase_config !== 'undefined' && Object.keys(JSON.parse(__firebase_config)).length > 0)
            ? JSON.parse(__firebase_config)
            : userConfig; // Ваша конфигурация как запасной вариант

        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.appId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // ------------------------------------------------------------------------------------------------

        let db;
        let auth;
        let currentUserId = null;
        let currentUsername = null; // Новый стейт для никнейма
        let isAuthReady = false;

        // Элементы UI
        const postForm = document.getElementById('post-form');
        const postContentInput = document.getElementById('post-content');
        const postButton = document.getElementById('post-button');
        const postsFeed = document.getElementById('posts-feed');
        const authStatus = document.getElementById('auth-status');
        const userIdDisplay = document.getElementById('user-id');
        const userNicknameDisplay = document.getElementById('user-nickname');
        const nicknameModal = document.getElementById('nickname-modal');
        const nicknameForm = document.getElementById('nickname-form');
        const nicknameInput = document.getElementById('nickname-input');
        const nicknameError = document.getElementById('nickname-error');
        const loadingIndicator = document.getElementById('loading-indicator');

        // Пути Firestore
        const PUBLIC_COLLECTION_PATH = `artifacts/${appId}/public/data/posts`;
        
        // Путь к документу профиля пользователя (приватное хранилище)
        // Структура: artifacts/{appId}/users/{uid}/profile/details (6 сегментов)
        const getUserProfileDocRef = (uid) => doc(db, `artifacts/${appId}/users/${uid}/profile/details`);

        // --- Утилиты ---

        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            const modal = document.getElementById('modal');
            modal.querySelector('h3').classList.toggle('text-red-600', title.toLowerCase().includes('ошибка'));
            modal.querySelector('h3').classList.toggle('text-green-600', !title.toLowerCase().includes('ошибка'));
            modal.classList.remove('hidden');
        }

        /**
         * Форматирует временную метку
         */
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'Неизвестно';
            const date = new Date(timestamp);
            const options = {
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            };
            return date.toLocaleTimeString('ru-RU', options);
        }

        /**
         * Управляет состоянием формы постинга (доступна/недоступна)
         */
        function setPostingEnabled(isEnabled) {
            postContentInput.disabled = !isEnabled;
            postButton.disabled = !isEnabled;
            if (isEnabled) {
                postContentInput.placeholder = 'Введите ваше сообщение здесь...';
                postButton.classList.remove('disabled:bg-gray-400');
            } else {
                postContentInput.placeholder = 'Сначала установите никнейм или дождитесь аутентификации...';
                postButton.classList.add('disabled:bg-gray-400');
            }
        }
        
        /**
         * Рендерит один пост в ленте
         */
        function renderPost(post) {
            const isCurrentUser = post.userId === currentUserId;
            const postUsername = post.username || 'Аноним';

            const postElement = document.createElement('div');
            postElement.className = 'bg-white p-5 rounded-xl shadow-md border-t-4 ' + (isCurrentUser ? 'border-indigo-500' : 'border-sky-300');
            postElement.dataset.id = post.id;

            postElement.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div class="text-sm font-bold ${isCurrentUser ? 'text-indigo-600' : 'text-sky-600'}">
                        ${postUsername} ${isCurrentUser ? '(Вы)' : ''}
                    </div>
                    <div class="text-xs text-gray-400">
                        ${formatTimestamp(post.createdAt?.toMillis() || post.createdAt)}
                    </div>
                </div>
                <p class="text-gray-800 whitespace-pre-wrap mb-3">${post.content}</p>
                <div class="text-xs text-gray-500 break-all border-t pt-2 mt-2">
                    ID: ${post.userId}
                </div>
            `;
            return postElement;
        }

        // --- Логика Профиля (Никнейм) ---

        /**
         * Загружает или запрашивает никнейм пользователя.
         */
        async function loadUserProfile(userId) {
            const profileRef = getUserProfileDocRef(userId);
            try {
                const docSnap = await getDoc(profileRef);
                
                if (docSnap.exists() && docSnap.data().nickname) {
                    // Профиль найден - УСПЕХ
                    currentUsername = docSnap.data().nickname;
                    userNicknameDisplay.textContent = currentUsername;
                    setPostingEnabled(true);
                    nicknameModal.classList.add('hidden'); // Убеждаемся, что модальное окно скрыто
                } else {
                    // Профиль не найден - НОВЫЙ ПОЛЬЗОВАТЕЛЬ, показываем модальное окно
                    currentUsername = null;
                    userNicknameDisplay.textContent = 'Не установлен';
                    setPostingEnabled(false);
                    nicknameModal.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Ошибка загрузки профиля (вероятно, из-за правил безопасности):", error);
                
                // ИСПРАВЛЕНИЕ: Если аутентификация прошла, но возникла ошибка при чтении
                // профиля, мы принудительно показываем модальное окно, чтобы пользователь
                // мог создать документ через setDoc.
                currentUsername = null;
                userNicknameDisplay.textContent = 'Не установлен (Ошибка чтения)';
                setPostingEnabled(false);
                nicknameModal.classList.remove('hidden');
                showModal('Внимание', 'Не удалось прочитать ваш никнейм (возможно, вы входите впервые). Пожалуйста, введите его.');
            }
        }

        /**
         * Сохраняет никнейм пользователя в Firestore.
         */
        async function saveNickname(nickname) {
            if (!currentUserId || !db) return;

            const profileRef = getUserProfileDocRef(currentUserId);
            try {
                await setDoc(profileRef, {
                    nickname: nickname,
                    updatedAt: serverTimestamp()
                }, { merge: true });

                currentUsername = nickname;
                userNicknameDisplay.textContent = currentUsername;
                nicknameModal.classList.add('hidden');
                setPostingEnabled(true);
                showModal('Успех!', `Ваш никнейм "${nickname}" сохранен.`);

            } catch (error) {
                console.error("Ошибка сохранения никнейма:", error);
                showModal('Ошибка Сохранения', 'Не удалось сохранить никнейм. Попробуйте снова.');
            }
        }
        
        /**
         * Обработчик отправки формы никнейма.
         */
        function handleNicknameSubmit(e) {
            e.preventDefault();
            const nickname = nicknameInput.value.trim();

            if (nickname.length < 2) {
                nicknameError.textContent = 'Никнейм должен содержать не менее 2 символов.';
                nicknameError.classList.remove('hidden');
                return;
            }

            nicknameError.classList.add('hidden');
            saveNickname(nickname);
        }

        // --- Инициализация Firebase и Аутентификация ---

        async function initializeFirebase() {
            try {
                // setLogLevel('debug'); // Для отладки
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Назначаем обработчик формы никнейма
                nicknameForm.addEventListener('submit', handleNicknameSubmit);

                // Слушатель состояния аутентификации
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        authStatus.textContent = 'Аутентифицирован';
                        authStatus.className = 'font-semibold text-green-600';
                        userIdDisplay.textContent = currentUserId;
                        
                        // Загружаем профиль и никнейм
                        await loadUserProfile(user.uid);

                        // Начинаем слушать посты только после успешной аутентификации
                        if (!isAuthReady) {
                            isAuthReady = true;
                            startPostsListener();
                        }
                    } else {
                        currentUserId = null;
                        currentUsername = null;
                        authStatus.textContent = 'Не аутентифицирован';
                        authStatus.className = 'font-semibold text-red-600';
                        userIdDisplay.textContent = 'N/A';
                        userNicknameDisplay.textContent = 'N/A';
                        
                        setPostingEnabled(false);

                        // Попытка входа
                        if (!isAuthReady) {
                             await handleSignIn();
                        } else {
                            // Если аутентификация была, но пользователь вышел
                            showModal('Вход Необходим', 'Сессия истекла. Пожалуйста, обновите страницу.');
                        }
                    }
                });

                // Если есть токен, пробуем войти с ним, иначе анонимно
                const handleSignIn = async () => {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                        // onAuthStateChanged обработает результат
                    } catch (error) {
                        console.error("Ошибка аутентификации:", error);
                        showModal('Ошибка Аутентификации', 'Не удалось войти в Firebase. Проверьте консоль.');
                        authStatus.textContent = 'Ошибка';
                        authStatus.className = 'font-semibold text-red-600';
                    }
                };

                // Запускаем процесс аутентификации
                await handleSignIn();


            } catch (error) {
                console.error("Ошибка инициализации Firebase:", error);
                showModal('Критическая Ошибка', 'Не удалось инициализировать Firebase. Проверьте конфигурацию и импорты.');
            }
        }


        // --- Логика Постов ---

        /**
         * Обработчик отправки формы
         */
        async function handlePostSubmit(e) {
            e.preventDefault();
            const content = postContentInput.value.trim();

            if (!content || !currentUserId || !currentUsername) {
                showModal('Ошибка', 'Сообщение не может быть пустым, и вы должны иметь никнейм.');
                return;
            }

            setPostingEnabled(false);
            postButton.textContent = 'Публикация...';

            try {
                // Используем addDoc для добавления нового документа в коллекцию
                await addDoc(collection(db, PUBLIC_COLLECTION_PATH), {
                    userId: currentUserId,
                    username: currentUsername, // Добавляем никнейм в пост
                    content: content,
                    createdAt: serverTimestamp(),
                });

                postContentInput.value = ''; // Очищаем поле
            } catch (error) {
                console.error("Ошибка добавления поста:", error);
                showModal('Ошибка Публикации', `Не удалось опубликовать сообщение: ${error.message}`);
            } finally {
                setPostingEnabled(true);
                postButton.textContent = 'Опубликовать';
            }
        }

        /**
         * Настраивает слушатель реального времени для ленты постов
         */
        function startPostsListener() {
            if (!db) return;

            const postsCollection = collection(db, PUBLIC_COLLECTION_PATH);
            const q = query(postsCollection);
            
            // onSnapshot устанавливает слушатель реального времени
            onSnapshot(q, (snapshot) => {
                loadingIndicator.classList.add('hidden');
                
                let posts = [];
                snapshot.forEach((doc) => {
                    posts.push({ id: doc.id, ...doc.data() });
                });

                // Сортируем в JavaScript
                posts.sort((a, b) => {
                    const timeA = a.createdAt?.toMillis() || 0;
                    const timeB = b.createdAt?.toMillis() || 0;
                    return timeB - timeA; // Сортировка по убыванию (новые сверху)
                });

                postsFeed.innerHTML = ''; // Очищаем ленту

                if (posts.length === 0) {
                    postsFeed.innerHTML = '<p class="text-center text-gray-500 p-4 bg-white rounded-lg border-t-4 border-sky-100">Пока нет сообщений. Будьте первым, кто опубликует!</p>';
                } else {
                    posts.forEach(post => {
                        postsFeed.appendChild(renderPost(post));
                    });
                }
            }, (error) => {
                console.error("Ошибка получения данных в реальном времени:", error);
                showModal('Ошибка Ленты', 'Не удалось загрузить сообщения в реальном времени.');
            });
        }

        // --- Запуск Приложения ---

        window.onload = initializeFirebase;
        postForm.addEventListener('submit', handlePostSubmit);

    </script>
</body>
</html>
