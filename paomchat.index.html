<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAOM –ß–∞—Ç 5–ë</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937; /* Dark background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        /* Styling for the central chat card */
        .chat-card {
            background-color: #2c3e50; /* Slightly lighter dark background for the card */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5), 0 0 50px rgba(79, 70, 229, 0.3);
            transition: all 0.3s ease-in-out;
        }
        /* Custom styles for the glowing buttons/inputs like in the video */
        .glowing-element {
            background-color: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            box-shadow: 0 0 15px rgba(129, 140, 248, 0.5);
            color: white;
            transition: all 0.3s;
        }
        .glowing-element:hover:not(:disabled) {
            box-shadow: 0 0 25px rgba(129, 140, 248, 0.7);
            background-color: rgba(255, 255, 255, 0.15);
        }
        .glowing-element:focus {
            border-color: #818cf8;
            outline: none;
        }
        .main-button {
            background-color: #4f46e5;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.7);
        }
        .main-button:hover:not(:disabled) {
            background-color: #4338ca;
            box-shadow: 0 4px 20px rgba(79, 70, 229, 1);
        }
        
        /* Styling for the emoji grid */
        #emoji-picker-container {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
        }
        .emoji-item {
            cursor: pointer;
            font-size: 20px;
            text-align: center;
            padding: 4px;
            border-radius: 6px;
            transition: background-color 0.1s;
        }
        .emoji-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>

<!-- –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –≤–∏–¥—ã -->
<div id="app-container" class="chat-card rounded-3xl w-full max-w-lg flex flex-col h-[75vh] min-h-[500px] overflow-hidden p-6 text-white">

    <!-- 1. –≠–ö–†–ê–ù –ó–ê–ü–£–°–ö–ê -->
    <div id="view-splash" class="view flex flex-col items-center justify-center h-full text-center">
        <h1 class="text-5xl font-extrabold mb-10 tracking-widest text-indigo-400">PAOM chat</h1>
        <button id="start-button" class="glowing-element py-3 px-8 rounded-full text-xl font-bold">
            –ù–∞—á–∞—Ç—å –≤—Ö–æ–¥
        </button>
    </div>

    <!-- 2. –≠–ö–†–ê–ù –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò / –í–•–û–î–ê -->
    <div id="view-auth" class="view flex-col items-center justify-center h-full text-center hidden p-4">
        <h2 id="auth-title" class="text-3xl font-semibold mb-8 text-indigo-400">–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç</h2>
        
        <input
            type="email"
            id="email-input"
            placeholder="–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞"
            autocomplete="email"
            class="glowing-element text-center py-3 px-5 rounded-xl text-lg w-full mb-4 focus:ring-2 focus:ring-indigo-400"
        >
        <input
            type="password"
            id="password-input"
            placeholder="–ü–∞—Ä–æ–ª—å"
            autocomplete="current-password"
            class="glowing-element text-center py-3 px-5 rounded-xl text-lg w-full mb-6 focus:ring-2 focus:ring-indigo-400"
        >
        
        <button id="main-auth-button" class="main-button py-3 px-8 rounded-full text-xl font-bold w-full transition duration-300 disabled:opacity-50" disabled>
            –í–æ–π—Ç–∏
        </button>
        
        <p id="auth-error" class="text-red-400 mt-4 text-sm hidden">–¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏</p>
        
        <div class="mt-8">
            <button id="toggle-auth-mode" class="text-indigo-300 text-sm opacity-80 hover:opacity-100 transition duration-150">
                –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
            </button>
        </div>
    </div>

    <!-- 3. –≠–ö–†–ê–ù –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò –ù–ò–ö–ê (–¢–û–õ–¨–ö–û –î–õ–Ø –ù–û–í–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô) -->
    <div id="view-name" class="view flex-col items-center justify-center h-full text-center hidden">
        <h2 class="text-3xl font-semibold mb-8 text-gray-200">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∏–∫:</h2>
        <input
            type="text"
            id="name-input-field"
            placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∑–¥–µ—Å—å"
            maxlength="20"
            class="glowing-element text-center py-3 px-5 rounded-full text-lg w-3/4 mb-6 focus:ring-2 focus:ring-indigo-400"
        >
        <button id="name-next-button" class="main-button py-3 px-8 rounded-full text-xl font-bold disabled:opacity-50" disabled>
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
        </button>
    </div>

    <!-- 4. –≠–ö–†–ê–ù –ú–ï–ù–Æ (–ß–ê–¢–´) -->
    <div id="view-menu" class="view flex-col h-full hidden">
        <h1 class="text-3xl font-bold mb-6 text-indigo-400">–ß–∞—Ç—ã:</h1>
        <div class="space-y-4">
            <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –æ–±—â–∏–π —á–∞—Ç -->
            <button id="open-chat-button" class="glowing-element w-full text-left py-4 px-6 rounded-2xl text-xl font-semibold flex items-center justify-between">
                –û–±—â–∏–π —á–∞—Ç 5–ë 
                <span class="text-red-400 text-2xl">üìå</span>
            </button>
        </div>
        <button id="logout-button" class="mt-8 text-red-400 opacity-80 hover:opacity-100 transition duration-150 flex items-center">
             <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
             –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
        </button>
    </div>

    <!-- 5. –≠–ö–†–ê–ù –û–°–ù–û–í–ù–û–ì–û –ß–ê–¢–ê -->
    <div id="view-chat" class="view flex-col h-full hidden">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ß–ê–¢–∞ -->
        <div class="p-4 border-b border-gray-700 bg-gray-800 rounded-t-2xl">
            <h1 class="text-2xl font-extrabold tracking-tight text-indigo-300">–û–±—â–∏–π —á–∞—Ç 5–ë</h1>
            <p id="chat-user-info" class="text-sm mt-1 opacity-80 transition duration-300">
                –ó–∞–≥—Ä—É–∑–∫–∞...
            </p>
        </div>

        <!-- –û–±–ª–∞—Å—Ç—å –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π -->
        <div id="messages-list" class="flex-grow p-4 space-y-4 overflow-y-auto bg-gray-800/50">
            <p id="loading-message" class="text-center text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</p>
        </div>

        <!-- –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è -->
        <div class="p-4 border-t border-gray-700 bg-gray-800 relative">
            <!-- –û–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Å–º–∞–π–ª–∏–∫–æ–≤ -->
            <div 
                id="emoji-picker" 
                class="absolute bottom-full mb-3 p-3 glowing-element z-10 w-full hidden rounded-xl shadow-lg"
            >
                <div id="emoji-picker-container">
                    <!-- Emojis will be added here -->
                </div>
            </div>

            <form id="message-form" class="flex gap-3">
                <input
                    type="text"
                    id="message-input"
                    placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                    autocomplete="off"
                    required
                    class="glowing-element flex-grow p-3 rounded-xl focus:ring-2 focus:ring-indigo-400 text-sm placeholder:text-gray-400"
                >
                
                <!-- –ö–Ω–æ–ø–∫–∞ —Å–º–∞–π–ª–∏–∫–∞ -->
                <button
                    type="button"
                    id="emoji-button"
                    class="bg-gray-700 text-white font-bold p-3 rounded-xl hover:bg-gray-600 transition duration-150 shadow-md"
                    aria-label="–û—Ç–∫—Ä—ã—Ç—å –≤—ã–±–æ—Ä —Å–º–∞–π–ª–∏–∫–æ–≤"
                >
                    üòä
                </button>

                <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
                <button
                    type="submit"
                    id="send-button"
                    class="main-button text-white font-bold py-3 px-5 rounded-xl transition duration-150 shadow-lg shadow-indigo-500/50 active:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none"
                    disabled
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                </button>
            </form>
        </div>
    </div>
</div>

<!-- –ë–ª–æ–∫ –¥–ª—è Firebase (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å type="module") -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        signInWithEmailAndPassword, 
        createUserWithEmailAndPassword,
        signInWithCustomToken, 
        onAuthStateChanged,
        signOut
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp, setLogLevel, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    setLogLevel('Debug');

    // 1. –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Canvas (–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-chat-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---
    let db, auth, userId = null;
    let currentDisplayName = null; 
    let isRegistrationMode = false; // –°–æ—Å—Ç–æ—è–Ω–∏–µ: true = –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, false = –í—Ö–æ–¥

    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const views = {
        splash: document.getElementById('view-splash'),
        auth: document.getElementById('view-auth'),
        name: document.getElementById('view-name'),
        menu: document.getElementById('view-menu'),
        chat: document.getElementById('view-chat'),
    };
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò
    const authTitle = document.getElementById('auth-title');
    const emailInput = document.getElementById('email-input');
    const passwordInput = document.getElementById('password-input');
    const mainAuthButton = document.getElementById('main-auth-button');
    const authError = document.getElementById('auth-error');
    const toggleAuthModeButton = document.getElementById('toggle-auth-mode');
    const logoutButton = document.getElementById('logout-button');

    // –≠–ª–µ–º–µ–Ω—Ç—ã –ù–ò–ö–ù–ï–ô–ú–ê
    const nameInputField = document.getElementById('name-input-field');
    const nameNextButton = document.getElementById('name-next-button');
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã –ù–ê–í–ò–ì–ê–¶–ò–ò
    const startButton = document.getElementById('start-button');
    const openChatButton = document.getElementById('open-chat-button');
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã –ß–ê–¢–ê
    const messagesList = document.getElementById('messages-list');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const chatUserInfo = document.getElementById('chat-user-info');
    const loadingMessage = document.getElementById('loading-message');
    const emojiPicker = document.getElementById('emoji-picker');
    const emojiPickerContainer = document.getElementById('emoji-picker-container');
    const emojiButton = document.getElementById('emoji-button');


    /**
     * –°–ø–∏—Å–æ–∫ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Å–º–∞–π–ª–∏–∫–æ–≤
     */
    const commonEmojis = [
        'üòä', 'üòÇ', 'üòç', 'üëç', 'üôè', '‚ù§Ô∏è', 'üî•', 'üéâ',
        'ü•≥', 'üòé', 'üò¢', 'üíØ', 'ü§î', 'üëã', 'üëÄ', 'üí°',
        'üöÄ', 'üíª', 'üìö', '‚úèÔ∏è', 'üçé', 'üçï', '‚öΩ', 'üé∂'
    ];

    // --- –õ–û–ì–ò–ö–ê –ù–ê–í–ò–ì–ê–¶–ò–ò –∏ –°–û–°–¢–û–Ø–ù–ò–Ø ---

    /**
     * –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π –≤–∏–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
     * @param {string} viewName –ò–º—è –≤–∏–¥–∞ ('splash', 'auth', 'name', 'menu', 'chat').
     */
    function switchView(viewName) {
        Object.keys(views).forEach(key => {
            if (key === viewName) {
                views[key].style.display = 'flex';
                // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –Ω–æ–≤–æ–º –≤–∏–¥–µ
                if (key === 'auth') emailInput.focus();
                if (key === 'name') nameInputField.focus();
            } else {
                views[key].style.display = 'none';
            }
        });
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Ö–æ–¥–∞ –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –≤–∏–¥.
     */
    async function checkStateAndNavigate() {
        if (!userId) {
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω
            switchView('splash');
        } else {
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∏–∫
            await loadAndCheckProfile();
            if (currentDisplayName) {
                // –ï—Å–ª–∏ –Ω–∏–∫ –µ—Å—Ç—å, –∏–¥–µ–º –≤ –º–µ–Ω—é
                switchView('menu');
            } else {
                // –ï—Å–ª–∏ –Ω–∏–∫–∞ –Ω–µ—Ç (–Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å), –∏–¥–µ–º –Ω–∞ —ç–∫—Ä–∞–Ω –Ω–∏–∫–∞
                switchView('name');
            }
        }
    }
    
    // --- –õ–û–ì–ò–ö–ê –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò (Email/Password) ---

    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞ (–í—Ö–æ–¥/–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è).
     */
    function updateAuthView() {
        authError.classList.add('hidden');
        if (isRegistrationMode) {
            authTitle.textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è';
            mainAuthButton.textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
            toggleAuthModeButton.textContent = '–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏';
            passwordInput.setAttribute('autocomplete', 'new-password');
        } else {
            authTitle.textContent = '–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç';
            mainAuthButton.textContent = '–í–æ–π—Ç–∏';
            toggleAuthModeButton.textContent = '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
            passwordInput.setAttribute('autocomplete', 'current-password');
        }
        mainAuthButton.disabled = !emailInput.value || !passwordInput.value;
    }

    /**
     * –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.
     * @param {string} message –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ.
     */
    function showAuthError(message) {
        authError.textContent = message;
        authError.classList.remove('hidden');
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–í—Ö–æ–¥ –∏–ª–∏ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è).
     */
    async function handleAuthSubmit() {
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();
        authError.classList.add('hidden');
        mainAuthButton.disabled = true;

        if (!email || !password) {
            showAuthError("–í–≤–µ–¥–∏—Ç–µ –ø–æ—á—Ç—É –∏ –ø–∞—Ä–æ–ª—å.");
            mainAuthButton.disabled = false;
            return;
        }

        try {
            if (isRegistrationMode) {
                // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await createUserWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –ø–µ—Ä–µ–≤–µ–¥–µ—Ç –Ω–∞ 'view-name'
            } else {
                // –í—Ö–æ–¥ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –ø–µ—Ä–µ–≤–µ–¥–µ—Ç –¥–∞–ª—å—à–µ
            }
        } catch (error) {
            let userMessage = "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.";
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –æ—à–∏–±–æ–∫ Firebase
            switch (error.code) {
                case 'auth/invalid-email':
                    userMessage = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã.';
                    break;
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                    userMessage = '–ù–µ–≤–µ—Ä–Ω–∞—è –ø–æ—á—Ç–∞ –∏–ª–∏ –ø–∞—Ä–æ–ª—å.';
                    break;
                case 'auth/email-already-in-use':
                    userMessage = '–≠—Ç–æ—Ç –∞–¥—Ä–µ—Å —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω.';
                    break;
                case 'auth/weak-password':
                    userMessage = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤.';
                    break;
            }
            showAuthError(userMessage);
            mainAuthButton.disabled = false;
        }
    }
    
    /**
     * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å" –¥–ª—è –Ω–∏–∫–∞.
     */
    function handleNameSubmit() {
        const name = nameInputField.value.trim();
        if (name) {
            saveUserProfile(name).then(() => {
                // –£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏ –Ω–∏–∫, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –º–µ–Ω—é
                switchView('menu');
            });
        }
    }

    /**
     * –í—ã—Ö–æ–¥ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞.
     */
    async function handleLogout() {
        try {
            await signOut(auth);
            userId = null;
            currentDisplayName = null;
            switchView('splash');
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ:", error);
        }
    }


    // --- –§–£–ù–ö–¶–ò–ò –ü–†–û–§–ò–õ–Ø FIREBASE ---

    /**
     * –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Å—Ç—Ä–æ–∫–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ userId –≤ —Ü–≤–µ—Ç HSL –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞.
     */
    function stringToHslColor(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }
        const h = hash % 360;
        return `hsl(${h}, 70%, 70%)`; 
    }

    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –≤ —à–∞–ø–∫–µ —á–∞—Ç–∞.
     */
    function updateChatUserInfoDisplay(name, fullId) {
        chatUserInfo.innerHTML = `
            <span class="flex items-center text-gray-300">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                –í—ã –≤–æ—à–ª–∏ –∫–∞–∫: <span title="${fullId}" class="font-bold text-indigo-300 ml-1 cursor-pointer">${name}</span>
            </span>
        `;
    }

    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –Ω–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Firestore.
     */
    async function loadAndCheckProfile() {
        if (!db || !userId) return;

        try {
            const profileDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_profiles', userId);
            const docSnap = await getDoc(profileDocRef);

            if (docSnap.exists() && docSnap.data().name) {
                currentDisplayName = docSnap.data().name;
            } else {
                currentDisplayName = null;
            }
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è:", error);
            currentDisplayName = null;
        }
    }

    /**
     * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Firestore.
     */
    async function saveUserProfile(name) {
        if (!name || !db || !userId) return;

        try {
            const profileDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'user_profiles', userId);
            await setDoc(profileDocRef, { name: name }, { merge: true });
            currentDisplayName = name;
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", error);
        }
    }
    
    // --- –õ–û–ì–ò–ö–ê –ß–ê–¢–ê FIREBASE ---

    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç Firebase –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Å–ª—É—à–∞—Ç–µ–ª—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.
     */
    async function initializeFirebase() {
        if (!firebaseConfig) {
            console.error("Firebase config is missing.");
            return;
        }
        
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // –°–ª—É—à–∞—Ç–µ–ª—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ - –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    sendButton.disabled = false;
                    checkStateAndNavigate(); // –ü–µ—Ä–µ—Ö–æ–¥ –∫ –º–µ–Ω—é –∏–ª–∏ –≤–≤–æ–¥—É –Ω–∏–∫–∞
                    setupMessageListener(); 
                } else {
                    userId = null;
                    sendButton.disabled = true;
                    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—Ö–æ–¥–∏—Ç (SignOut), –ø–æ–∫–∞–∑–∞—Ç—å Splash/Auth
                    if (views.auth.style.display !== 'flex') {
                        switchView('splash');
                    }
                }
            });

            // –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –≤—Ö–æ–¥–∞
            if (initialAuthToken) {
                 await signInWithCustomToken(auth, initialAuthToken).catch(e => {
                    console.warn("–¢–æ–∫–µ–Ω Canvas –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥ –ø–æ Email/Password.");
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –∏ –ø–æ–∑–≤–æ–ª—è–µ–º onAuthStateChanged —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (null)
                 });
            }
            
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:", error);
        }
    }

    /**
     * –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Å–ª—É—à–∞—Ç–µ–ª—å Firestore –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.
     */
    function setupMessageListener() {
        if (!db) return;

        const publicDataPath = doc(db, 'artifacts', appId, 'public', 'data');
        const messagesColRef = collection(publicDataPath, 'chat_messages');
        const q = query(messagesColRef, orderBy('timestamp', 'asc'));

        onSnapshot(q, (snapshot) => {
            if (loadingMessage) {
                loadingMessage.remove(); 
            }
            
            const messages = [];
            snapshot.forEach(doc => {
                messages.push({ id: doc.id, ...doc.data() });
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Ä–µ–∂–∏–º–µ —á–∞—Ç–∞
            if (views.chat.style.display === 'flex') {
                displayMessages(messages);
            }
        }, (error) => {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:", error);
        });
    }

    /**
     * –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ DOM –∏ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ—Ç –≤–Ω–∏–∑.
     */
    function displayMessages(messages) {
        messagesList.innerHTML = '';
        
        messages.forEach(message => {
            const isMine = message.senderId === userId;
            const messageElement = document.createElement('div');
            
            const senderName = message.displayName || (isMine ? '–í—ã (ID)' : message.senderId.substring(0, 8) + '...');
            
            let timeStr = '–°–µ–π—á–∞—Å';
            if (message.timestamp && message.timestamp.toDate) {
                const date = message.timestamp.toDate();
                timeStr = date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            }

            const alignment = isMine ? 'self-end' : 'self-start';
            const bgColor = isMine ? 'bg-indigo-600 text-white shadow-lg' : 'bg-gray-700 text-gray-100 border border-gray-600 shadow-md';
            const rounding = isMine ? 'rounded-3xl rounded-br-sm' : 'rounded-3xl rounded-bl-sm'; 
            
            const idColor = stringToHslColor(message.senderId);

            messageElement.className = `flex flex-col max-w-[85%] md:max-w-md ${alignment} transition duration-200 ease-in-out`;
            messageElement.innerHTML = `
                <div class="px-4 py-3 ${rounding} ${bgColor} relative break-words">
                    <!-- –ò–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è -->
                    <span class="text-xs font-bold block mb-1" 
                        style="color: ${isMine ? '#E0E7FF' : idColor};" 
                        title="ID: ${message.senderId}"
                    >
                        ${senderName}
                    </span>
                    <p class="text-sm">${message.text}</p>
                    <span class="text-[10px] opacity-70 mt-1 block ${isMine ? 'text-indigo-200' : 'text-gray-400'} text-right">${timeStr}</span>
                </div>
            `;
            messagesList.appendChild(messageElement);
        });

        messagesList.scrollTop = messagesList.scrollHeight;
    }

    /**
     * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã.
     */
    async function handleSendMessage(e) {
        e.preventDefault();
        
        const text = messageInput.value.trim();
        if (!text || !db || !userId || !currentDisplayName) {
            console.warn("–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –∏–º–µ–Ω–∏.");
            return;
        }

        sendButton.disabled = true; 
        
        const message = {
            senderId: userId,
            displayName: currentDisplayName,
            text: text,
            timestamp: serverTimestamp()
        };

        try {
            const publicDataPath = doc(db, 'artifacts', appId, 'public', 'data');
            const messagesColRef = collection(publicDataPath, 'chat_messages');
            await addDoc(messagesColRef, message);
            messageInput.value = '';
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:", error);
        } finally {
            sendButton.disabled = false;
        }
    }


    // --- –§–£–ù–ö–¶–ò–ò –°–ú–ê–ô–õ–ò–ö–û–í ---

    function renderEmojis() {
        emojiPickerContainer.innerHTML = '';
        commonEmojis.forEach(emoji => {
            const span = document.createElement('span');
            span.className = 'emoji-item';
            span.textContent = emoji;
            span.addEventListener('click', () => insertEmoji(emoji));
            emojiPickerContainer.appendChild(span);
        });
    }

    function insertEmoji(emoji) {
        const start = messageInput.selectionStart;
        const end = messageInput.selectionEnd;
        messageInput.value = messageInput.value.substring(0, start) + emoji + messageInput.value.substring(end);
        messageInput.selectionStart = messageInput.selectionEnd = start + emoji.length;
        messageInput.focus();
        emojiPicker.classList.add('hidden');
    }

    function toggleEmojiPicker() {
        emojiPicker.classList.toggle('hidden');
    }


    // --- –ù–ê–°–¢–†–û–ô–ö–ê –°–û–ë–´–¢–ò–ô –ò –ó–ê–ü–£–°–ö ---

    // –°–æ–±—ã—Ç–∏—è –ù–∞–≤–∏–≥–∞—Ü–∏–∏
    startButton.addEventListener('click', () => switchView('auth'));
    openChatButton.addEventListener('click', () => {
        updateChatUserInfoDisplay(currentDisplayName, userId);
        switchView('chat');
    });

    // –°–æ–±—ã—Ç–∏—è –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    [emailInput, passwordInput].forEach(input => {
        input.addEventListener('input', updateAuthView);
    });
    mainAuthButton.addEventListener('click', handleAuthSubmit);
    toggleAuthModeButton.addEventListener('click', () => {
        isRegistrationMode = !isRegistrationMode;
        emailInput.value = '';
        passwordInput.value = '';
        updateAuthView();
    });
    logoutButton.addEventListener('click', handleLogout);

    // –°–æ–±—ã—Ç–∏—è –ò–º–µ–Ω–∏
    nameInputField.addEventListener('input', (e) => {
        nameNextButton.disabled = e.target.value.trim().length === 0;
    });
    nameInputField.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !nameNextButton.disabled) {
            e.preventDefault();
            handleNameSubmit();
        }
    });
    nameNextButton.addEventListener('click', handleNameSubmit);
    
    // –°–æ–±—ã—Ç–∏—è –ß–∞—Ç–∞
    messageForm.addEventListener('submit', handleSendMessage);
    emojiButton.addEventListener('click', toggleEmojiPicker);
    document.addEventListener('click', (e) => {
        if (views.chat.style.display === 'flex' && !emojiPicker.contains(e.target) && e.target !== emojiButton && !emojiButton.contains(e.target)) {
            emojiPicker.classList.add('hidden');
        }
    });


    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    renderEmojis();
    initializeFirebase();
    updateAuthView(); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º (–í—Ö–æ–¥)

</script>

</body>
</html>

